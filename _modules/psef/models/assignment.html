

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>psef.models.assignment &mdash; CodeGrade Mosaic documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href="../../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                Mosaic
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/use-codegrade-as-a-student.html">How to use CodeGrade as a student</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/getting-started-with-codegrade.html">Getting started with CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/autotest-best-practices.html">Best Practices for AutoTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/creating-an-assignment.html">Create a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/set-up-a-rubric-for-an-assignment.html">Set up a rubric for an assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/setting-up-autotest.html">Setting up AutoTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/enabling-continuous-feedback-for-an-assignment.html">Enabling Continuous Feedback for an assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/set-up-group-assignment.html">Set up a CodeGrade group assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/setting-up-hand-in-requirements.html">Set up hand-in requirements for a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/setting-up-git-uploads.html">Set up Git uploads for a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/checking-for-plagiarism.html">Check for plagiarism in a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/dividing-submissions.html">Divide submissions over graders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/pass-back-grades-to-canvas-blackboard-moodle-brightspace.html">Pass back grades to Canvas, Blackboard, Moodle or Brightspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/creating-managing-and-using-snippets.html">Create, manage and use snippets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/setup-password-for-codegrade-account.html">Set up a password for my CodeGrade account</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/using-shortcuts.html">Using shortcuts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/cannot-find-feature-in-codegrade.html">I cannot find a feature in CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/installing-codegrade-filesystem.html">Install the CodeGrade Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/use-codegrade-filesystem.html">Use the CodeGrade Filesystem to locally mount CodeGrade</a></li>
</ul>
<p class="caption"><span class="caption-text">User Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user/overview.html">Overview of CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/codeviewer.html">Code Viewer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/management.html">Course and Assignment Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/plagiarism.html">Plagiarism Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/groups.html">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/permissions.html">Permissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/preferences.html">Settings and Site Preferences</a></li>
<li class="toctree-l1"><a class="reference external" href="https://fs-docs.codegra.de">Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/lms.html">LMS Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/autotest/overview.html">AutoTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/analytics-dashboard.html">Analytics Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/exam-mode.html">Exam mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/notifications.html">Notifications</a></li>
</ul>
<p class="caption"><span class="caption-text">About CodeGrade</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../about/about.html">About CodeGrade</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../developerdocs.html">Developer documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CodeGrade</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../psef.html">psef</a> &raquo;</li>
        
      <li>psef.models.assignment</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for psef.models.assignment</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This module defines all models needed for an assignment.</span>

<span class="sd">SPDX-License-Identifier: AGPL-3.0-only</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">t</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">shuffle</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">cycle</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">defaultdict</span>

<span class="kn">import</span> <span class="nn">structlog</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">from</span> <span class="nn">furl</span> <span class="kn">import</span> <span class="n">furl</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">validates</span>
<span class="kn">from</span> <span class="nn">mypy_extensions</span> <span class="kn">import</span> <span class="n">DefaultArg</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.types</span> <span class="kn">import</span> <span class="n">JSON</span>
<span class="kn">from</span> <span class="nn">sqlalchemy_utils</span> <span class="kn">import</span> <span class="n">PasswordType</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">TypedDict</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.collections</span> <span class="kn">import</span> <span class="n">attribute_mapped_collection</span>

<span class="kn">import</span> <span class="nn">psef</span>
<span class="kn">import</span> <span class="nn">cg_enum</span>
<span class="kn">import</span> <span class="nn">cg_cache</span>
<span class="kn">import</span> <span class="nn">cg_sqlalchemy_helpers</span>
<span class="kn">from</span> <span class="nn">cg_helpers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">humanize</span><span class="p">,</span> <span class="n">handle_none</span><span class="p">,</span> <span class="n">on_not_none</span><span class="p">,</span> <span class="n">zip_times_with_offset</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cg_dt_utils</span> <span class="kn">import</span> <span class="n">DatetimeWithTimezone</span>
<span class="kn">from</span> <span class="nn">cg_flask_helpers</span> <span class="kn">import</span> <span class="n">callback_after_this_request</span>
<span class="kn">from</span> <span class="nn">cg_sqlalchemy_helpers</span> <span class="kn">import</span> <span class="n">UUIDType</span>
<span class="kn">from</span> <span class="nn">cg_sqlalchemy_helpers</span> <span class="kn">import</span> <span class="n">expression</span> <span class="k">as</span> <span class="n">sql_expression</span>
<span class="kn">from</span> <span class="nn">cg_cache.intra_request</span> <span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">from</span> <span class="nn">cg_sqlalchemy_helpers.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_T_BASE</span><span class="p">,</span> <span class="n">MyQuery</span><span class="p">,</span> <span class="n">DbColumn</span><span class="p">,</span> <span class="n">ColumnProxy</span><span class="p">,</span> <span class="n">MyNonOrderableQuery</span><span class="p">,</span>
    <span class="n">hybrid_property</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cg_sqlalchemy_helpers.mixins</span> <span class="kn">import</span> <span class="n">IdMixin</span><span class="p">,</span> <span class="n">UUIDMixin</span><span class="p">,</span> <span class="n">TimestampMixin</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">UUID_LENGTH</span><span class="p">,</span> <span class="n">Base</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">user</span> <span class="k">as</span> <span class="n">user_models</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">work</span> <span class="k">as</span> <span class="n">work_models</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">course</span> <span class="k">as</span> <span class="n">course_models</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">linter</span> <span class="k">as</span> <span class="n">linter_models</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">rubric</span> <span class="k">as</span> <span class="n">rubric_models</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">analytics</span> <span class="k">as</span> <span class="n">analytics_models</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">auto_test</span> <span class="k">as</span> <span class="n">auto_test_models</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">validator</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">task_result</span> <span class="k">as</span> <span class="n">task_result_models</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">auth</span><span class="p">,</span> <span class="n">ignore</span><span class="p">,</span> <span class="n">helpers</span><span class="p">,</span> <span class="n">signals</span><span class="p">,</span> <span class="n">db_locks</span>
<span class="kn">from</span> <span class="nn">.role</span> <span class="kn">import</span> <span class="n">CourseRole</span>
<span class="kn">from</span> <span class="nn">.permission</span> <span class="kn">import</span> <span class="n">Permission</span><span class="p">,</span> <span class="n">PermissionComp</span>
<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">APICodes</span><span class="p">,</span> <span class="n">APIWarnings</span><span class="p">,</span> <span class="n">APIException</span><span class="p">,</span> <span class="n">PermissionException</span><span class="p">,</span>
    <span class="n">InvalidAssignmentState</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.link_tables</span> <span class="kn">import</span> <span class="n">user_course</span><span class="p">,</span> <span class="n">users_groups</span><span class="p">,</span> <span class="n">course_permissions</span>
<span class="kn">from</span> <span class="nn">..permissions</span> <span class="kn">import</span> <span class="n">CoursePermission</span> <span class="k">as</span> <span class="n">CPerm</span>

<span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="c1"># pylint: disable=unused-import</span>
    <span class="kn">from</span> <span class="nn">pylti1p3.assignments_grades</span> <span class="kn">import</span> <span class="n">_AssignmentsGradersData</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">group</span> <span class="k">as</span> <span class="n">group_models</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>


<div class="viewcode-block" id="PeerFeedbackSettingJSON"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.PeerFeedbackSettingJSON">[docs]</a><span class="k">class</span> <span class="nc">PeerFeedbackSettingJSON</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The serialization of an :class:`.AssignmentPeerFeedbackSettings`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#: The amount of student that a single user should peer review.</span>
    <span class="n">amount</span><span class="p">:</span> <span class="nb">int</span>

    <span class="c1">#: The amount of time in seconds a user has after the deadline to do the</span>
    <span class="c1">#: peer review.</span>
    <span class="n">time</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>

    <span class="c1">#: Should new peer feedback comments be considered approved by default or</span>
    <span class="c1">#: not.</span>
    <span class="n">auto_approved</span><span class="p">:</span> <span class="nb">bool</span></div>


<div class="viewcode-block" id="AssignmentPeerFeedbackConnectionJSON"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentPeerFeedbackConnectionJSON">[docs]</a><span class="k">class</span> <span class="nc">AssignmentPeerFeedbackConnectionJSON</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The serialization of an :class:`.AssignmentPeerFeedbackConnection`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#: The user that should do the peer review.</span>
    <span class="n">peer</span><span class="p">:</span> <span class="s1">&#39;user_models.User&#39;</span>
    <span class="c1">#: The user that should be reviewed by ``peer``.</span>
    <span class="n">subject</span><span class="p">:</span> <span class="s1">&#39;user_models.User&#39;</span></div>


<div class="viewcode-block" id="AssignmentJSON"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentJSON">[docs]</a><span class="k">class</span> <span class="nc">AssignmentJSON</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The serialization of an assignment.</span>

<span class="sd">    See the comments in the source code for the meaning of each field.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1">#: The id of the assignment.</span>
    <span class="n">state</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1">#: Current state of the assignment.</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>  <span class="c1">#: Description of the assignment.</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">DatetimeWithTimezone</span>  <span class="c1">#: ISO UTC date.</span>
    <span class="n">deadline</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">DatetimeWithTimezone</span><span class="p">]</span>  <span class="c1">#: ISO UTC date.</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1">#: The name of the assignment.</span>
    <span class="n">is_lti</span><span class="p">:</span> <span class="nb">bool</span>  <span class="c1">#: Is this an LTI assignment.</span>
    <span class="n">course</span><span class="p">:</span> <span class="s1">&#39;course_models.Course&#39;</span>  <span class="c1">#: Course of this assignment.</span>
    <span class="n">cgignore</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;psef.helpers.JSONType&#39;</span><span class="p">]</span>  <span class="c1">#: The cginore.</span>
    <span class="n">cgignore_version</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="c1">#: Has the whitespace linter run on this assignment.</span>
    <span class="n">whitespace_linter</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="c1">#: The time the assignment will become available (i.e. the state will</span>
    <span class="c1">#: switch from &#39;hidden&#39; to &#39;open&#39;). If the state is not &#39;hidden&#39; this value</span>
    <span class="c1">#: has no meaning. If this value is not ``None`` you cannot change to state</span>
    <span class="c1">#: to &#39;hidden&#39; or &#39;open&#39;.</span>
    <span class="n">available_at</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">DatetimeWithTimezone</span><span class="p">]</span>

    <span class="c1">#: Should we send login links to all users before the available_at time.</span>
    <span class="n">send_login_links</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="c1">#: The fixed value for the maximum that can be achieved in a rubric. This</span>
    <span class="c1">#: can be higher and lower than the actual max. Will be `null` if unset.</span>
    <span class="n">fixed_max_rubric_points</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>

    <span class="c1">#: The maximum grade you can get for this assignment. This is based around</span>
    <span class="c1">#: the idea that a 10 is a &#39;perfect&#39; score. So if this value is 12 a user</span>
    <span class="c1">#: can score 2 additional bonus points. If this value is `null` it is unset</span>
    <span class="c1">#: and regarded as a 10.</span>
    <span class="n">max_grade</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>

    <span class="c1">#: The group set of this assignment. This is ``null`` if this assignment is</span>
    <span class="c1">#: not a group assignment.</span>
    <span class="n">group_set</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;psef.models.GroupSet&#39;</span><span class="p">]</span>

    <span class="c1">#: The id of the AutoTest configuration connected to this assignment. This</span>
    <span class="c1">#: will always be given if there is a configuration connected to this</span>
    <span class="c1">#: assignment, even if you do not have permission to see the configuration</span>
    <span class="c1">#: itself.</span>

    <span class="n">auto_test_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">files_upload_enabled</span><span class="p">:</span> <span class="nb">bool</span>  <span class="c1">#: Can you upload files to this assignment.</span>
    <span class="n">webhook_upload_enabled</span><span class="p">:</span> <span class="nb">bool</span>  <span class="c1">#: Can you connect git to this assignment.</span>

    <span class="c1">#: The maximum amount of submission a student may create, inclusive. The</span>
    <span class="c1">#: value ``null`` indicates that there is no limit.</span>
    <span class="n">max_submissions</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

    <span class="c1">#: These two values determine the maximum submissions in an amount of time</span>
    <span class="c1">#: by a user. A user can submit at most `amount_in_cool_off_period`</span>
    <span class="c1">#: submissions in `cool_off_period` seconds. `amount_in_cool_off_period`</span>
    <span class="c1">#: is always &gt;= 1, so this check is disabled if `cool_off_period == 0`.</span>
    <span class="n">cool_off_period</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span>
    <span class="n">amount_in_cool_off_period</span><span class="p">:</span> <span class="nb">int</span>

    <span class="c1">#: ISO UTC date. This will be `null` if you don&#39;t have the permission to</span>
    <span class="c1">#: see this or if it is unset.</span>
    <span class="n">reminder_time</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="c1">#: The LMS providing this LTI assignment.</span>
    <span class="n">lms_name</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="c1">#: The peer feedback settings for this assignment. If ``null`` this</span>
    <span class="c1">#: assignment is not a peer feedback assignment.</span>
    <span class="n">peer_feedback_settings</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;AssignmentPeerFeedbackSettings&#39;</span><span class="p">]</span>

    <span class="c1">#: The kind of reminder that will be sent.  If you don&#39;t have the</span>
    <span class="c1">#: permission to see this it will always be ``null``. If this is not set it</span>
    <span class="c1">#: will also be ``null``.</span>
    <span class="n">done_type</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="c1">#: The email where the done email will be sent to. This will be ``null`` if</span>
    <span class="c1">#: you do not have permission to see this information.</span>
    <span class="n">done_email</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="c1">#: The assignment id of the assignment that determines the grader division</span>
    <span class="c1">#: of this assignment. This will be ``null`` if you do not have permissions</span>
    <span class="c1">#: to see this information, or if no such parent is set.</span>
    <span class="n">division_parent_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

    <span class="c1">#: The ids of the analytics workspaces connected to this assignment.</span>
    <span class="c1">#: WARNING: This API is still in beta, and might change in the future.</span>
    <span class="n">analytics_workspace_ids</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

    <span class="c1">#: What kind of assignment is this.</span>
    <span class="n">kind</span><span class="p">:</span> <span class="s1">&#39;AssignmentKind&#39;</span></div>


<div class="viewcode-block" id="AssignmentAmbiguousSettingTag"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentAmbiguousSettingTag">[docs]</a><span class="k">class</span> <span class="nc">AssignmentAmbiguousSettingTag</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;All items that can contribute to a ambiguous assignment setting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">webhook</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">cgignore</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">max_submissions</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">cool_off</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">deadline</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span></div>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_AssignmentAmbiguousSetting</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A class representing a ambiguous setting for an assignment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">]</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="n">AssignmentAmbiguousSettingTag</span><span class="p">]</span>


<div class="viewcode-block" id="AssignmentStateEnum"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentStateEnum">[docs]</a><span class="nd">@enum</span><span class="o">.</span><span class="n">unique</span>
<span class="k">class</span> <span class="nc">AssignmentStateEnum</span><span class="p">(</span><span class="n">cg_enum</span><span class="o">.</span><span class="n">CGEnum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describes in what state an :class:`.Assignment` is.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hidden</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">open</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">done</span> <span class="o">=</span> <span class="mi">2</span></div>


<div class="viewcode-block" id="AssignmentKind"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentKind">[docs]</a><span class="nd">@enum</span><span class="o">.</span><span class="n">unique</span>
<span class="k">class</span> <span class="nc">AssignmentKind</span><span class="p">(</span><span class="n">cg_enum</span><span class="o">.</span><span class="n">CGEnum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describes in what state an :class:`.Assignment` is.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">exam</span> <span class="o">=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="AssignmentVisibilityState"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentVisibilityState">[docs]</a><span class="nd">@enum</span><span class="o">.</span><span class="n">unique</span>
<span class="k">class</span> <span class="nc">AssignmentVisibilityState</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This enum determines what the visibility state is of this assignment.</span>

<span class="sd">    This state is more important than that of :class:`.AssignmentStateEnum`.</span>

<span class="sd">    .. todo::</span>

<span class="sd">        Investigate if we can combine this class with</span>
<span class="sd">        :class:`.AssignmentStateEnum`. We would really need to take care that</span>
<span class="sd">        performance isn&#39;t impacted when combining, and that it actually</span>
<span class="sd">        improves the clarity of the code.</span>

<span class="sd">    :ivar deep_linked: This assignment is not finished at the moment, but is</span>
<span class="sd">        being deep linked inside an LMS.</span>
<span class="sd">    :ivar visible: Assignment is visible and can be used as normal.</span>
<span class="sd">    :ivar ~AssignmentVisibilityState.deleted: Assignment has been deleted and</span>
<span class="sd">        should be hidden.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">deep_linked</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">visible</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">deleted</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Should you see this assignment as a deleted assignment?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleted</span></div>


<div class="viewcode-block" id="AssignmentAssignedGrader"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentAssignedGrader">[docs]</a><span class="k">class</span> <span class="nc">AssignmentAssignedGrader</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The class creates the link between an :class:`.user_models.User` and an</span>
<span class="sd">    :class:`.Assignment`.</span>

<span class="sd">    The user linked to the assignment is an assigned grader. In this link the</span>
<span class="sd">    weight is the weight this user was given when assigning.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;AssignmentAssignedGrader&#39;</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;User_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;User.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">assignment_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;Assignment_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Assignment.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">),</span> <span class="p">)</span></div>


<div class="viewcode-block" id="AssignmentGraderDone"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentGraderDone">[docs]</a><span class="k">class</span> <span class="nc">AssignmentGraderDone</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class creates the link between an :class:`.user_models.User` and an</span>
<span class="sd">    :class:`.Assignment` that exists only when the grader is done.</span>

<span class="sd">    If a user is linked to the assignment this indicates that this user is done</span>
<span class="sd">    with grading.</span>

<span class="sd">    :ivar ~.AssignmentGraderDone.user_id: The id of the user that is linked.</span>
<span class="sd">    :ivar ~.AssignmentGraderDone.assignment_id: The id of the assignment that</span>
<span class="sd">        is linked.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;AssignmentGraderDone&#39;</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;User_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;User.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">assignment_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;Assignment_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Assignment.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">),</span> <span class="p">)</span></div>


<div class="viewcode-block" id="AssignmentDoneType"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentDoneType">[docs]</a><span class="k">class</span> <span class="nc">AssignmentDoneType</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describes what type of reminder should be sent.</span>

<span class="sd">    :param none: Nobody should be e-mailed.</span>
<span class="sd">    :param assigned_only: Only graders that are assigned will be notified.</span>
<span class="sd">    :param all_graders: All users that have the permission to grade.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">assigned_only</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">all_graders</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span></div>


<div class="viewcode-block" id="AssignmentLinter"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentLinter">[docs]</a><span class="k">class</span> <span class="nc">AssignmentLinter</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The class is used when a linter (see :py:mod:`psef.linters`) is used on</span>
<span class="sd">    a :class:`.Assignment`.</span>

<span class="sd">    Every :class:`.work_models.Work` that is tested is attached by a</span>
<span class="sd">    :class:`.linter_models.LinterInstance`.</span>

<span class="sd">    The name identifies which :class:`.linter_models.Linter` is used.</span>

<span class="sd">    :ivar ~.AssignmentLinter.name: The name of the linter which is the</span>
<span class="sd">        `__name__` of a subclass of :py:class:`.linter_models.Linter`.</span>
<span class="sd">    :ivar tests: All the linter instances for this linter, this are the</span>
<span class="sd">        recordings of the running of the actual linter (so in the case of the</span>
<span class="sd">        :py:class:`.Flake8` metadata about the `flake8` program).</span>
<span class="sd">    :ivar config: The config that was passed to the linter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;AssignmentLinter&#39;</span>  <span class="c1"># type: str</span>
    <span class="c1"># This has to be a String object as the id has to be a non guessable uuid.</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">UUID_LENGTH</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">tests</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">linter_models</span><span class="o">.</span><span class="n">LinterInstance</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;tester&quot;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all,delete&#39;</span><span class="p">,</span>
        <span class="n">order_by</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">linter_models</span><span class="o">.</span><span class="n">LinterInstance</span><span class="o">.</span><span class="n">work_id</span><span class="p">,</span>
        <span class="n">uselist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;config&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">assignment_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;Assignment_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Assignment.id&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">assignment</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">Assignment</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">assignment_id</span><span class="p">,</span>
        <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;linters&#39;</span><span class="p">,</span> <span class="n">uselist</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">linters_crashed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The amount of linters that have crashed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amount_linters_in_state</span><span class="p">(</span><span class="n">linter_models</span><span class="o">.</span><span class="n">LinterState</span><span class="o">.</span><span class="n">crashed</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">linters_done</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The amount of linters that are done.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amount_linters_in_state</span><span class="p">(</span><span class="n">linter_models</span><span class="o">.</span><span class="n">LinterState</span><span class="o">.</span><span class="n">done</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">linters_running</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The amount of linters that are running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amount_linters_in_state</span><span class="p">(</span><span class="n">linter_models</span><span class="o">.</span><span class="n">LinterState</span><span class="o">.</span><span class="n">running</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_amount_linters_in_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="s1">&#39;linter_models.LinterState&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">linter_models</span><span class="o">.</span><span class="n">LinterInstance</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="n">tester_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__extended_to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Creates an extended JSON serializable representation of this</span>
<span class="sd">        assignment linter.</span>

<span class="sd">        This object will look like this:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            {</span>
<span class="sd">                &#39;tests&#39;: t.List[LinterInstance], # The tests done by this</span>
<span class="sd">                                                 # assignment linter.</span>
<span class="sd">                &#39;id&#39;: str, # The id of this assignment linter.</span>
<span class="sd">                &#39;name&#39;: str, # The name.</span>
<span class="sd">            }</span>

<span class="sd">        :returns: An object as described above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;tests&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">deleted</span><span class="p">],</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Returns the JSON serializable representation of this class.</span>

<span class="sd">        This representation also returns a count of the</span>
<span class="sd">        :class:`.linter_models.LinterState` of the attached</span>
<span class="sd">        :class:`.linter_models.LinterInstance` objects.</span>

<span class="sd">        :returns: A dict containing JSON serializable representations of the</span>
<span class="sd">            attributes and the test state counts of this AssignmentLinter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">linters_done</span><span class="p">,</span>
            <span class="s1">&#39;working&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">linters_running</span><span class="p">,</span>
            <span class="s1">&#39;crashed&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">linters_crashed</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">}</span>

<div class="viewcode-block" id="AssignmentLinter.create_linter"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentLinter.create_linter">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_linter</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="s1">&#39;AssignmentLinter&#39;</span><span class="p">],</span>
        <span class="n">assignment_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;AssignmentLinter&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a new instance of this class for a given :class:`.Assignment`</span>
<span class="sd">        with a given :py:class:`.linter_models.Linter`</span>

<span class="sd">        :param assignment_id: The id of the assignment</span>
<span class="sd">        :param name: Name of the linter</span>
<span class="sd">        :returns: The created AssignmentLinter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

        <span class="c1"># Find a unique id.</span>
        <span class="k">while</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">AssignmentLinter</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">new_id</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">new_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">new_id</span><span class="p">,</span> <span class="n">assignment_id</span><span class="o">=</span><span class="n">assignment_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tests</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">assig</span> <span class="o">=</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">assig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">assig</span><span class="o">.</span><span class="n">get_all_latest_submissions</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">linter_models</span><span class="o">.</span><span class="n">LinterInstance</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span></div></div>


<div class="viewcode-block" id="AssignmentPeerFeedbackConnection"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentPeerFeedbackConnection">[docs]</a><span class="k">class</span> <span class="nc">AssignmentPeerFeedbackConnection</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">TimestampMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This table represents a link between a two users and assignment.</span>

<span class="sd">    If a connection from ``peer_user`` to ``user`` for assignment ``A1`` exists this</span>
<span class="sd">    means that ``peer_user`` should peer review ``user`` for assignment ``A1``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@t</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">peer_feedback_settings</span><span class="p">:</span> <span class="s1">&#39;AssignmentPeerFeedbackSettings&#39;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="s1">&#39;user_models.User&#39;</span><span class="p">,</span>
        <span class="n">peer_user</span><span class="p">:</span> <span class="s1">&#39;user_models.User&#39;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="nd">@t</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">peer_feedback_settings</span><span class="p">:</span> <span class="s1">&#39;AssignmentPeerFeedbackSettings&#39;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">peer_user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">peer_feedback_settings</span><span class="p">:</span> <span class="s1">&#39;AssignmentPeerFeedbackSettings&#39;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="s1">&#39;user_models.User&#39;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">peer_user</span><span class="p">:</span> <span class="s1">&#39;user_models.User&#39;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">peer_user_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">peer_user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">peer_user_id</span> <span class="ow">is</span> <span class="kc">None</span>

            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="n">peer_feedback_settings</span><span class="o">=</span><span class="n">peer_feedback_settings</span><span class="p">,</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                <span class="n">peer_user</span><span class="o">=</span><span class="n">peer_user</span><span class="p">,</span>
                <span class="n">peer_feedback_settings_id</span><span class="o">=</span><span class="n">peer_feedback_settings</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">peer_user_id</span><span class="o">=</span><span class="n">peer_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">peer_user</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">peer_user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="n">peer_feedback_settings</span><span class="o">=</span><span class="n">peer_feedback_settings</span><span class="p">,</span>
                <span class="n">peer_feedback_settings_id</span><span class="o">=</span><span class="n">peer_feedback_settings</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                <span class="n">peer_user_id</span><span class="o">=</span><span class="n">peer_user_id</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="n">peer_feedback_settings_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;peer_feedback_settings_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
            <span class="s1">&#39;assignment_peer_feedback_settings.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span>
        <span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">#: The user that should be peer reviewed</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;user_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;User.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">#: The id of the user that should do this peer feedback.</span>
    <span class="n">peer_user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;peer_user_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;User.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">peer_feedback_settings</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">AssignmentPeerFeedbackSettings</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">peer_feedback_settings_id</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;selectin&#39;</span><span class="p">,</span>
        <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;connections&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
        <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;selectin&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">peer_user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">peer_user_id</span><span class="p">,</span>
        <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;selectin&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">db</span><span class="o">.</span><span class="n">PrimaryKeyConstraint</span><span class="p">(</span>
            <span class="n">peer_feedback_settings_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">peer_user_id</span>
        <span class="p">),</span>
        <span class="n">db</span><span class="o">.</span><span class="n">CheckConstraint</span><span class="p">(</span>
            <span class="s1">&#39;peer_user_id != user_id&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;peer_feedback_reviewer_is_not_subject&#39;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;AssignmentPeerFeedbackConnection&lt;peer=</span><span class="si">{}</span><span class="s1">, subject=</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peer_user_id</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="s1">&#39;peer&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer_user</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="AssignmentPeerFeedbackSettings"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentPeerFeedbackSettings">[docs]</a><span class="k">class</span> <span class="nc">AssignmentPeerFeedbackSettings</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">IdMixin</span><span class="p">,</span> <span class="n">TimestampMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This table represents the peer feedback settings for an assignment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#: The amount of students a single student should review. If this is 0 peer</span>
    <span class="c1">#: feedback is disabled.</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">#: The amount of time a user has after the deadline to do its peer</span>
    <span class="c1">#: feedback. If this is ``None`` the user has an infinite amount of time</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Interval</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">auto_approved</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;auto_approved&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">server_default</span><span class="o">=</span><span class="s1">&#39;false&#39;</span>
    <span class="p">)</span>

    <span class="n">assignment_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;assignment_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Assignment.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">assignment</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">Assignment</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">assignment_id</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">,</span>
        <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;peer_feedback_settings&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">connections</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">AssignmentPeerFeedbackConnection</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;peer_feedback_settings&#39;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;delete-orphan,delete,save-update&#39;</span><span class="p">,</span>
        <span class="n">uselist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">db</span><span class="o">.</span><span class="n">CheckConstraint</span><span class="p">(</span>
            <span class="s2">&quot;amount &gt; 0&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;peer_feedback_amount_at_least_one&#39;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">amount</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">time</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">],</span>
        <span class="n">assignment</span><span class="p">:</span> <span class="s1">&#39;Assignment&#39;</span><span class="p">,</span>
        <span class="n">auto_approved</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">,</span>
            <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
            <span class="n">assignment</span><span class="o">=</span><span class="n">assignment</span><span class="p">,</span>
            <span class="n">auto_approved</span><span class="o">=</span><span class="n">auto_approved</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PeerFeedbackSettingJSON</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">on_not_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()),</span>
            <span class="s1">&#39;auto_approved&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_approved</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">deadline_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Has the deadline for giving peer feedback expired.</span>

<span class="sd">        If the deadline for the assignment has not been set just yet we don&#39;t</span>
<span class="sd">        consider the deadline for the peer feedback expired. However, as the</span>
<span class="sd">        deadline for the assignment also hasn&#39;t expired in this case peer</span>
<span class="sd">        feedback is not yet open.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_request_start_time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">assig</span><span class="o">.</span><span class="n">deadline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">assig</span><span class="o">.</span><span class="n">deadline</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">now</span>

    <span class="nd">@cg_cache</span><span class="o">.</span><span class="n">intra_request</span><span class="o">.</span><span class="n">cache_within_request</span>
    <span class="k">def</span> <span class="nf">_get_subjects_for_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                               <span class="n">user</span><span class="p">:</span> <span class="s1">&#39;user_models.User&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Container</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="n">PFConn</span> <span class="o">=</span> <span class="n">AssignmentPeerFeedbackConnection</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">user_id</span> <span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">PFConn</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">PFConn</span><span class="o">.</span><span class="n">peer_feedback_settings</span> <span class="o">==</span> <span class="bp">self</span><span class="p">,</span>
                <span class="n">PFConn</span><span class="o">.</span><span class="n">peer_user</span> <span class="o">==</span> <span class="n">user</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="AssignmentPeerFeedbackSettings.does_peer_review_of"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentPeerFeedbackSettings.does_peer_review_of">[docs]</a>    <span class="k">def</span> <span class="nf">does_peer_review_of</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">reviewer</span><span class="p">:</span> <span class="s1">&#39;user_models.User&#39;</span><span class="p">,</span> <span class="n">subject</span><span class="p">:</span> <span class="s1">&#39;user_models.User&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the given ``reviewer`` should peer review submissions by</span>
<span class="sd">        the given ``subject``.</span>

<span class="sd">        :param reviewer: The user that should do the review.</span>
<span class="sd">        :param subject: Submissions of this user should be peer reviewed by the</span>
<span class="sd">            ``reviewer`` if this function returns ``True``.</span>

<span class="sd">        :returns: ``True`` if the ``reviewer`` should do a peer review,</span>
<span class="sd">                  ``False`` otherwise. It also returns ``False`` if the</span>
<span class="sd">                  deadline of an assignment has not expired just yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the assignment is not yet done the ordering has not stabilized, so</span>
        <span class="c1"># we always return ``False`` for this check.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">deadline_expired</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">subject</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_subjects_for_user</span><span class="p">(</span><span class="n">reviewer</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentPeerFeedbackSettings.maybe_do_initial_division"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentPeerFeedbackSettings.maybe_do_initial_division">[docs]</a>    <span class="k">def</span> <span class="nf">maybe_do_initial_division</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Do the initial division of peer feedback if the amount of submissions is</span>
<span class="sd">        adequate.</span>

<span class="sd">        .. warning:: This will delete all old connections.</span>

<span class="sd">        :returns: A boolean indicating if the initial submission was done.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span>
        <span class="n">existing_submissions</span> <span class="o">=</span> <span class="n">assig</span><span class="o">.</span><span class="n">get_amount_not_deleted_submissions</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">existing_submissions</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_do_initial_division</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">_make_connection</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">peer_user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssignmentPeerFeedbackConnection</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">AssignmentPeerFeedbackConnection</span><span class="p">(</span>
            <span class="n">peer_feedback_settings</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">peer_user_id</span><span class="o">=</span><span class="n">peer_user_id</span><span class="p">,</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_do_initial_division</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Do the initial division of peer feedback.</span>

<span class="sd">        This can only be done when the amount of submissions is equal to or</span>
<span class="sd">        larger than the amount of submissions that each user should review.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span>
        <span class="n">all_users</span> <span class="o">=</span> <span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span>
                <span class="n">assig</span><span class="o">.</span><span class="n">get_from_latest_submissions</span><span class="p">(</span><span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">shuffle</span><span class="p">(</span><span class="n">all_users</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">can_do_better_division</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="k">def</span> <span class="nf">get_offset_per_item</span><span class="p">(</span><span class="n">cur_depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">can_do_better_division</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cur_depth</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="n">cur_depth</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Doing initial division&#39;</span><span class="p">,</span>
            <span class="n">assignment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="p">,</span>
            <span class="n">amount_of_users</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">all_users</span><span class="p">),</span>
            <span class="n">division_amount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
            <span class="n">can_do_better_division</span><span class="o">=</span><span class="n">can_do_better_division</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">users</span> <span class="ow">in</span> <span class="n">zip_times_with_offset</span><span class="p">(</span>
            <span class="n">all_users</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">get_offset_per_item</span>
        <span class="p">):</span>
            <span class="n">peer_user</span><span class="p">,</span> <span class="o">*</span><span class="n">other_users</span> <span class="o">=</span> <span class="n">users</span>
            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">other_users</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_make_connection</span><span class="p">(</span>
                    <span class="n">peer_user_id</span><span class="o">=</span><span class="n">peer_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
                <span class="p">)</span>

<div class="viewcode-block" id="AssignmentPeerFeedbackSettings.maybe_delete_division_among_peers"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentPeerFeedbackSettings.maybe_delete_division_among_peers">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">maybe_delete_division_among_peers</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">deletion</span><span class="p">:</span> <span class="n">signals</span><span class="o">.</span><span class="n">WorkDeletedData</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Maybe delete the division for the student connected to the deleted</span>
<span class="sd">        work.</span>

<span class="sd">        This method might redivide all submissions again, so deleting work is</span>
<span class="sd">        quite dangerous. If this redivision happens a warning will be added to</span>
<span class="sd">        the response.</span>

<span class="sd">        :param deletion: The deleted work and extra data.</span>

<span class="sd">        :returns: Nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assig</span> <span class="o">=</span> <span class="n">deletion</span><span class="o">.</span><span class="n">assignment</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">assig</span><span class="o">.</span><span class="n">peer_feedback_settings</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_delete_division_among_peers</span><span class="p">(</span><span class="n">deletion</span><span class="p">)</span>  <span class="c1"># pylint: disable=protected-access</span></div>

    <span class="k">def</span> <span class="nf">_maybe_delete_division_among_peers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">deletion</span><span class="p">:</span> <span class="n">signals</span><span class="o">.</span><span class="n">WorkDeletedData</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">author</span> <span class="o">=</span> <span class="n">deletion</span><span class="o">.</span><span class="n">deleted_work</span><span class="o">.</span><span class="n">user</span>
        <span class="n">assig</span> <span class="o">=</span> <span class="n">deletion</span><span class="o">.</span><span class="n">assignment</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">author</span><span class="o">.</span><span class="n">is_test_student</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">deletion</span><span class="o">.</span><span class="n">was_latest</span> <span class="ow">or</span>
            <span class="n">deletion</span><span class="o">.</span><span class="n">new_latest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">return</span>

        <span class="n">db_locks</span><span class="o">.</span><span class="n">acquire_lock</span><span class="p">(</span>
            <span class="n">db_locks</span><span class="o">.</span><span class="n">LockNamespaces</span><span class="o">.</span><span class="n">peer_feedback_division</span><span class="p">,</span> <span class="n">assig</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>

        <span class="n">PFConn</span> <span class="o">=</span> <span class="n">AssignmentPeerFeedbackConnection</span>
        <span class="c1"># First we get all connections that involve the author that now no</span>
        <span class="c1"># longer has a submission.</span>
        <span class="n">all_conns</span> <span class="o">=</span> <span class="n">PFConn</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">PFConn</span><span class="o">.</span><span class="n">peer_feedback_settings</span> <span class="o">==</span> <span class="bp">self</span><span class="p">,</span>
            <span class="n">sql_expression</span><span class="o">.</span><span class="n">or_</span><span class="p">(</span>
                <span class="n">PFConn</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">author</span><span class="p">,</span>
                <span class="n">PFConn</span><span class="o">.</span><span class="n">peer_user</span> <span class="o">==</span> <span class="n">author</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">all_subjects</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">user</span> <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">all_conns</span> <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">user</span> <span class="o">!=</span> <span class="n">author</span>
        <span class="p">)</span>
        <span class="n">reviewers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">peer_user</span> <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">all_conns</span> <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">peer_user</span> <span class="o">!=</span> <span class="n">author</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">reviewers</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_subjects</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">reviewers</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_conns</span><span class="p">)</span>
        <span class="n">illegal_connections</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">PFConn</span><span class="o">.</span><span class="n">peer_user_id</span><span class="p">,</span> <span class="n">PFConn</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">PFConn</span><span class="o">.</span><span class="n">peer_feedback_settings</span> <span class="o">==</span> <span class="bp">self</span><span class="p">,</span>
                <span class="n">PFConn</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_subjects</span><span class="p">]),</span>
                <span class="n">PFConn</span><span class="o">.</span><span class="n">peer_user_id</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reviewers</span><span class="p">]),</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># We first want to divide the subjects that are also reviewers, as</span>
        <span class="c1"># these subjects might cause the redivision to fail.</span>
        <span class="n">high_priority_subjects</span> <span class="o">=</span> <span class="n">all_subjects</span> <span class="o">&amp;</span> <span class="n">reviewers</span>
        <span class="n">low_priority_subjects</span> <span class="o">=</span> <span class="n">all_subjects</span> <span class="o">-</span> <span class="n">high_priority_subjects</span>

        <span class="n">new_conns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Redivision might fail if a user should review the ``author`` and if</span>
        <span class="c1"># the ``author`` should review this user.</span>
        <span class="n">redivide_failed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">reviewer</span> <span class="ow">in</span> <span class="n">reviewers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">high_priority_subjects</span><span class="p">,</span> <span class="n">low_priority_subjects</span><span class="p">):</span>
                <span class="c1"># We don&#39;t know from which set we should remove the subject</span>
                <span class="c1"># (high or low priority) so we simply remove it from the all</span>
                <span class="c1"># set and check this set to see if the subject is still</span>
                <span class="c1"># available.</span>
                <span class="k">if</span> <span class="n">subj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_subjects</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">reviewer</span> <span class="o">==</span> <span class="n">subj</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">reviewer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">subj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">illegal_connections</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">all_subjects</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">subj</span><span class="p">)</span>
                <span class="n">new_conns</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">reviewer</span><span class="p">,</span> <span class="n">subj</span><span class="p">))</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">redivide_failed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">redivide_failed</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Redividing succeeded&#39;</span><span class="p">,</span> <span class="n">new_connections</span><span class="o">=</span><span class="n">new_conns</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">all_conns</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">peer</span><span class="p">,</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">new_conns</span><span class="p">:</span>
                <span class="n">PFConn</span><span class="p">(</span>
                    <span class="n">peer_feedback_settings</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">peer_user</span><span class="o">=</span><span class="n">peer</span>
                <span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_do_initial_division</span><span class="p">():</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">add_warning</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s1">&#39;All connections for peer feedback were redivided because&#39;</span>
                    <span class="s1">&#39; of this deletion.&#39;</span>
                <span class="p">),</span> <span class="n">psef</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">APIWarnings</span><span class="o">.</span><span class="n">ALL_PEER_FEEDBACK_REDIVIDED</span>
            <span class="p">)</span>

<div class="viewcode-block" id="AssignmentPeerFeedbackSettings.maybe_divide_work_among_peers"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentPeerFeedbackSettings.maybe_divide_work_among_peers">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">maybe_divide_work_among_peers</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">work</span><span class="p">:</span> <span class="s1">&#39;work_models.Work&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Maybe divide the given work among peers.</span>

<span class="sd">        The work will be divided if it is done by a real user (i.e. not a test</span>
<span class="sd">        student), and if peer feedback is enabled. All users with a submission</span>
<span class="sd">        for the assignment are considered peers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">peer_feedback_settings</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_divide_work_among_peers</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>  <span class="c1"># pylint: disable=protected-access</span></div>

    <span class="k">def</span> <span class="nf">_maybe_divide_work_among_peers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">:</span> <span class="s1">&#39;work_models.Work&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_test_student</span><span class="p">:</span>
            <span class="c1"># Test students cannot do peer feedback</span>
            <span class="k">return</span>

        <span class="n">assig</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">assignment</span>

        <span class="k">def</span> <span class="nf">_has_no_submission</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="o">~</span><span class="n">assig</span><span class="o">.</span><span class="n">get_not_deleted_submissions</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">work</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                    <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">work</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>

        <span class="c1"># We use the entire body of submissions to determine the peer reviewers</span>
        <span class="c1"># for this submission. So no submissions by new users (without any</span>
        <span class="c1"># submissions) should be created at this point to prevent race</span>
        <span class="c1"># conditions.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">db_locks</span><span class="o">.</span><span class="n">maybe_acquire_lock</span><span class="p">(</span>
            <span class="n">_has_no_submission</span><span class="p">,</span> <span class="n">db_locks</span><span class="o">.</span><span class="n">LockNamespaces</span><span class="o">.</span><span class="n">peer_feedback_division</span><span class="p">,</span>
            <span class="n">assig</span><span class="o">.</span><span class="n">id</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;No division necessary, user already has a submission&#39;</span><span class="p">,</span>
                <span class="n">work_author</span><span class="o">=</span><span class="n">work</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">existing_submissions</span> <span class="o">=</span> <span class="n">assig</span><span class="o">.</span><span class="n">get_amount_not_deleted_submissions</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">existing_submissions</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span><span class="p">:</span>
            <span class="c1"># Not enough submissions to create a division</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Not enough submissions to do initial division&#39;</span><span class="p">,</span>
                <span class="n">existing_submissions</span><span class="o">=</span><span class="n">existing_submissions</span><span class="p">,</span>
                <span class="n">division_amount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amount</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">existing_submissions</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Need to do initial division&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_do_initial_division</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">PFConn</span> <span class="o">=</span> <span class="n">AssignmentPeerFeedbackConnection</span>
        <span class="n">all_connections</span> <span class="o">=</span> <span class="n">PFConn</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">PFConn</span><span class="o">.</span><span class="n">peer_feedback_settings</span> <span class="o">==</span> <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">sql_expression</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
        <span class="c1"># XXX: It might be faster do a ``random.shuffle`` in Python instead of</span>
        <span class="c1"># ordering by a random value in the database. I have not tested this,</span>
        <span class="c1"># but this seems fast enough for now.</span>

        <span class="n">illegal_connections</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">all_connections</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">peer_user_id</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">user_id</span><span class="p">),</span>
                <span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">connection</span><span class="o">.</span><span class="n">user_id</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">new_conn</span> <span class="ow">in</span> <span class="n">illegal_connections</span> <span class="k">for</span> <span class="n">new_conn</span> <span class="ow">in</span> <span class="n">new</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">peer_user</span><span class="p">,</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">new</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_make_connection</span><span class="p">(</span><span class="n">peer_user_id</span><span class="o">=</span><span class="n">peer_user</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>

            <span class="n">illegal_connections</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
            <span class="c1"># We add two connections to `illegal_connections` every time, so</span>
            <span class="c1"># the amount of connections for our new author is the length of</span>
            <span class="c1"># that set divided by two.</span>
            <span class="n">found</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">illegal_connections</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">found</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="c1"># This (``found &lt; self.amount``) should never happen, but the exact</span>
            <span class="c1"># distribution of users (especially when ``self.amount &gt; 1``) is</span>
            <span class="c1"># really hard to follow. We don&#39;t want uploading to fail, so in</span>
            <span class="c1"># production we simply redivide everybody and report this error to</span>
            <span class="c1"># sentry.</span>
            <span class="k">if</span> <span class="n">psef</span><span class="o">.</span><span class="n">current_app</span><span class="o">.</span><span class="n">do_sanity_checks</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s1">&#39;Could not upload new submission without redividing&#39;</span>
                        <span class="s1">&#39; all existing users. Existing connections: </span><span class="si">{}</span><span class="s1">&#39;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;All submissions needed a new division&#39;</span><span class="p">,</span>
                <span class="n">report_to_sentry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">old_connections</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_do_initial_division</span><span class="p">()</span></div>


<span class="n">signals</span><span class="o">.</span><span class="n">WORK_DELETED</span><span class="o">.</span><span class="n">connect_immediate</span><span class="p">(</span>
    <span class="n">AssignmentPeerFeedbackSettings</span><span class="o">.</span><span class="n">maybe_delete_division_among_peers</span>
<span class="p">)</span>
<span class="n">signals</span><span class="o">.</span><span class="n">WORK_CREATED</span><span class="o">.</span><span class="n">connect_immediate</span><span class="p">(</span>
    <span class="n">AssignmentPeerFeedbackSettings</span><span class="o">.</span><span class="n">maybe_divide_work_among_peers</span>
<span class="p">)</span>


<div class="viewcode-block" id="AssignmentLoginLink"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentLoginLink">[docs]</a><span class="k">class</span> <span class="nc">AssignmentLoginLink</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">UUIDMixin</span><span class="p">,</span> <span class="n">TimestampMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class represents a link that a user can use to login for a specific</span>
<span class="sd">    assignment between the ``available_at`` and the ``deadline``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;user_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;User.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
        <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">assignment_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;assignment_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Assignment.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">assignment</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">Assignment</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">assignment_id</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;password&#39;</span><span class="p">,</span>
        <span class="n">PasswordType</span><span class="p">(</span><span class="n">schemes</span><span class="o">=</span><span class="p">[</span>
            <span class="s1">&#39;pbkdf2_sha512&#39;</span><span class="p">,</span>
        <span class="p">],</span> <span class="n">deprecated</span><span class="o">=</span><span class="p">[]),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">furl</span><span class="p">(</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;EXTERNAL_URL&#39;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;assignments&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_id</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
              <span class="p">)</span><span class="o">.</span><span class="n">tostr</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_message_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">{self_id}</span><span class="s1">-</span><span class="si">{token_id}</span><span class="s1">-</span><span class="si">{idx}</span><span class="s1">@</span><span class="si">{domain}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">self_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">token_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">send_login_links_token</span><span class="p">,</span>
            <span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>
            <span class="n">domain</span><span class="o">=</span><span class="n">psef</span><span class="o">.</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;EXTERNAL_DOMAIN&#39;</span><span class="p">],</span>
        <span class="p">)</span>

<div class="viewcode-block" id="AssignmentLoginLink.AsJSON"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentLoginLink.AsJSON">[docs]</a>    <span class="k">class</span> <span class="nc">AsJSON</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The way this class will be represented in JSON.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#: The id of this link.</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span>
        <span class="c1">#: The assignment connected to this login link.</span>
        <span class="n">assignment</span><span class="p">:</span> <span class="s1">&#39;Assignment&#39;</span>
        <span class="c1">#: The user that is link will login.</span>
        <span class="n">user</span><span class="p">:</span> <span class="s1">&#39;user_models.User&#39;</span></div>

    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsJSON</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;assignment&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="p">,</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="AssignmentResult"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.AssignmentResult">[docs]</a><span class="k">class</span> <span class="nc">AssignmentResult</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The class creates the link between an :class:`.user_models.User` and an</span>
<span class="sd">    :class:`.Assignment` in the database and the external users LIS sourcedid.</span>

<span class="sd">    :ivar sourcedid: The ``sourcedid`` for this user for this assignment.</span>
<span class="sd">    :ivar ~.AssignmentResult.user_id: The id of the user this belongs to.</span>
<span class="sd">    :ivar ~.AssignmentResult.assignment_id: The id of the assignment this</span>
<span class="sd">        belongs to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;AssignmentResult&#39;</span>
    <span class="n">sourcedid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;sourcedid&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;User_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;User.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">assignment_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;Assignment_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Assignment.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">),</span> <span class="p">)</span></div>


<div class="viewcode-block" id="Assignment"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment">[docs]</a><span class="k">class</span> <span class="nc">Assignment</span><span class="p">(</span><span class="n">helpers</span><span class="o">.</span><span class="n">NotEqualMixin</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-many-public-methods</span>
    <span class="sd">&quot;&quot;&quot;This class describes a :class:`.course_models.Course` specific assignment.</span>

<span class="sd">    :ivar ~.Assignment.name: The name of the assignment.</span>
<span class="sd">    :ivar ~.Assignment.cgignore: The .cgignore file of this assignment.</span>
<span class="sd">    :ivar ~.Assignment.state: The current state the assignment is in.</span>
<span class="sd">    :ivar ~.Assignment.description: UNUSED</span>
<span class="sd">    :ivar ~.Assignment.course: The course this assignment belongs to.</span>
<span class="sd">    :ivar ~.Assignment.created_at: The date this assignment was added.</span>
<span class="sd">    :ivar ~.Assignment.deadline: The deadline of this assignment.</span>
<span class="sd">    :ivar ~.Assignment._mail_task_id: This is the id of the current task that</span>
<span class="sd">        will email all the TA&#39;s to hurry up with grading.</span>
<span class="sd">    :ivar reminder_email_time: The time the reminder email should be sent. To</span>
<span class="sd">        see if we should actually send these reminders look at `done_type`</span>
<span class="sd">    :ivar done_email: The email address we should sent a email if the grading</span>
<span class="sd">        is done. The function :py:func:`email.utils.getaddresses` should be</span>
<span class="sd">        able to parse this string.</span>
<span class="sd">    :ivar done_type: The type of reminder that should be sent.</span>
<span class="sd">    :ivar assigned_graders: All graders that are assigned to grade mapped by</span>
<span class="sd">        user_id to `AssignmentAssignedGrader` object.</span>
<span class="sd">    :ivar rubric_rows: The rubric rows that make up the rubric for this</span>
<span class="sd">        assignment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;Assignment&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_cgignore</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;cgignore&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">_cgignore_version</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;cgignore_version&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>

    <span class="n">visibility_state</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;visibility_state&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">AssignmentVisibilityState</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="n">AssignmentVisibilityState</span><span class="o">.</span><span class="n">visible</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">_state</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;state&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">AssignmentStateEnum</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;_assignmentstateenum&#39;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="n">AssignmentStateEnum</span><span class="o">.</span><span class="n">hidden</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">kind</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;kind&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">AssignmentKind</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="n">AssignmentKind</span><span class="o">.</span><span class="n">normal</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">server_default</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span>
    <span class="p">)</span>

    <span class="n">description</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">course_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;Course_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Course.id&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">ColumnProxy</span><span class="p">[</span><span class="n">DatetimeWithTimezone</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">db</span><span class="o">.</span><span class="n">TIMESTAMP</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DatetimeWithTimezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">_deadline</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;deadline&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">TIMESTAMP</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="n">_mail_task_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;mail_task_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">reminder_email_time</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;reminder_email_time&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">TIMESTAMP</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">done_email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;done_email&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">done_type</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;done_type&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">AssignmentDoneType</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">_max_grade</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;max_grade&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># This is always `None` for LTI 1.3. As LTI 1.3 supports sending more than</span>
    <span class="c1"># the set maximum amount of points.</span>
    <span class="n">lti_points_possible</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;lti_points_possible&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># All stuff for LTI</span>
    <span class="n">lti_assignment_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;lti_assignment_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">is_lti</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;is_lti&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># This is the lti outcome service url for LTI 1.1 and for LTI 1.3 this is</span>
    <span class="c1"># the data passed under the</span>
    <span class="c1"># &quot;https://purl.imsglobal.org/spec/lti-ags/claim/endpoint&quot; claim.</span>
    <span class="n">lti_grade_service_data</span><span class="p">:</span> <span class="n">ColumnProxy</span><span class="p">[</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;_AssignmentsGradersData&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>
    <span class="n">lti_grade_service_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;lti_grade_service_data&#39;</span><span class="p">,</span> <span class="n">JSON</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">assigned_graders</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span>
        <span class="nb">int</span><span class="p">,</span> <span class="n">AssignmentAssignedGrader</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
            <span class="s1">&#39;AssignmentAssignedGrader&#39;</span><span class="p">,</span>
            <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;delete-orphan, delete, save-update&#39;</span><span class="p">,</span>
            <span class="n">collection_class</span><span class="o">=</span><span class="n">attribute_mapped_collection</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">),</span>
            <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;assignment&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;select&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">division_parent_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;division_parent_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Assignment.id&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">division_parent</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">Assignment</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;division_children&#39;</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">division_parent_id</span><span class="p">,</span>
        <span class="n">remote_side</span><span class="o">=</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;select&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">division_children</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">Assignment</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;division_parent&quot;</span><span class="p">,</span>
        <span class="n">uselist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;select&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">finished_graders</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">AssignmentGraderDone</span><span class="p">,</span>
        <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;assignment&#39;</span><span class="p">),</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;delete-orphan, delete&#39;</span><span class="p">,</span>
        <span class="n">uselist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">assignment_results</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span>
        <span class="nb">int</span><span class="p">,</span> <span class="n">AssignmentResult</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
            <span class="s1">&#39;AssignmentResult&#39;</span><span class="p">,</span>
            <span class="n">collection_class</span><span class="o">=</span><span class="n">attribute_mapped_collection</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">),</span>
            <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;assignment&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;select&#39;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">course</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">course_models</span><span class="o">.</span><span class="n">Course</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">course_id</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;assignments&#39;</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">,</span>
        <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">fixed_max_rubric_points</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;fixed_max_rubric_points&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">rubric_rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">rubric_models</span><span class="o">.</span><span class="n">RubricRowBase</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;assignment&#39;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;delete-orphan, delete, save-update&#39;</span><span class="p">,</span>
        <span class="n">order_by</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">rubric_models</span><span class="o">.</span><span class="n">RubricRowBase</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
        <span class="n">uselist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">analytics_workspaces</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">analytics_models</span><span class="o">.</span><span class="n">AnalyticsWorkspace</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;assignment&#39;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;delete-orphan, delete, save-update&#39;</span><span class="p">,</span>
        <span class="n">uselist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">group_set_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;group_set_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;GroupSet.id&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">group_set</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">psef</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">GroupSet</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;assignments&#39;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
        <span class="n">uselist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># This variable is available through a backref</span>
    <span class="n">linters</span><span class="p">:</span> <span class="n">ColumnProxy</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="s1">&#39;AssignmentLinter&#39;</span><span class="p">]]</span>

    <span class="c1"># This variable is available through a backref</span>
    <span class="n">submissions</span><span class="p">:</span> <span class="n">ColumnProxy</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="s1">&#39;work_models.Work&#39;</span><span class="p">]]</span>

    <span class="n">auto_test_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;auto_test_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;AutoTest.id&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">auto_test</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">auto_test_models</span><span class="o">.</span><span class="n">AutoTest</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">auto_test_id</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;assignment&quot;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">files_upload_enabled</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;files_upload_enabled&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">server_default</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">webhook_upload_enabled</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;webhook_upload_enabled&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">server_default</span><span class="o">=</span><span class="s1">&#39;false&#39;</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">_cool_off_period</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;cool_off_period&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Interval</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">_amount_in_cool_off_period</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;amount_in_cool_off_period&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">server_default</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">_max_submissions</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;max_amount_of_submissions&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">peer_feedback_settings</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="n">AssignmentPeerFeedbackSettings</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;assignment&quot;</span><span class="p">,</span>
        <span class="n">uselist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;delete-orphan,delete,save-update&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">_available_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;available_at&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">TIMESTAMP</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">_send_login_links_token</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;send_login_links_token&#39;</span><span class="p">,</span>
        <span class="n">UUIDType</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">db</span><span class="o">.</span><span class="n">CheckConstraint</span><span class="p">(</span>
            <span class="s2">&quot;files_upload_enabled or webhook_upload_enabled&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;upload_methods_check&#39;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">db</span><span class="o">.</span><span class="n">CheckConstraint</span><span class="p">(</span>
            <span class="s1">&#39;amount_in_cool_off_period &gt;= 1&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;amount_in_cool_off_period_check&#39;</span>
        <span class="p">),</span>
        <span class="n">db</span><span class="o">.</span><span class="n">CheckConstraint</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="s1">&#39;available_at IS NULL OR deadline IS NULL OR available_at &lt;&#39;</span>
                <span class="s1">&#39; deadline&#39;</span>
            <span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;available_at_before_deadline&#39;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">db</span><span class="o">.</span><span class="n">CheckConstraint</span><span class="p">(</span>
            <span class="s1">&#39;send_login_links_token IS NULL OR available_at IS NOT NULL&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;send_login_links_only_valid_with_available_at&#39;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">db</span><span class="o">.</span><span class="n">UniqueConstraint</span><span class="p">(</span>
            <span class="n">lti_assignment_id</span><span class="p">,</span>
            <span class="n">course_id</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ltiassignmentid_courseid_unique&#39;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="nd">@validator</span><span class="o">.</span><span class="n">validates</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">_available_at</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">_deadline</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">_send_login_links_token</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_available_at_and_login_links</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_login_links</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_at</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">deadline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s1">&#39;Login links can only be enabled when an available at and&#39;</span>
                    <span class="s1">&#39; deadline is set&#39;</span>
                <span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;Some required data was missing for assignment </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_STATE</span><span class="p">,</span> <span class="mi">409</span>
            <span class="p">)</span>

        <span class="n">max_time</span> <span class="o">=</span> <span class="n">psef</span><span class="o">.</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;EXAM_LOGIN_MAX_LENGTH&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deadline</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_at</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_time</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s1">&#39;Login links can only be enabled if the deadline is at&#39;</span>
                    <span class="s1">&#39; most </span><span class="si">{}</span><span class="s1"> after the available at date&#39;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">humanize</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">max_time</span><span class="p">,</span> <span class="n">no_prefix</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
                <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;The assignment </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> has too long between deadline&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39; and available at&#39;</span>
                <span class="p">),</span>
                <span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_STATE</span><span class="p">,</span>
                <span class="mi">409</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="nd">@validator</span><span class="o">.</span><span class="n">validates</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">_available_at</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">_deadline</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_available_at_and_deadline</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_at</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">deadline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_at</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deadline</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                <span class="s1">&#39;The assignment should become available before the deadline.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;The available_at is at or after the deadline&#39;</span><span class="p">,</span>
                <span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_STATE</span><span class="p">,</span> <span class="mi">409</span>
            <span class="p">)</span>

    <span class="nd">@validator</span><span class="o">.</span><span class="n">validates</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">_send_login_links_token</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_normal_assignment_login_links</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">is_normal</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_login_links</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                <span class="s1">&#39;Login links are only available for exam mode assignments&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;The assignment </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> is not an exam assignment&#39;</span><span class="p">,</span>
                <span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_STATE</span><span class="p">,</span> <span class="mi">409</span>
            <span class="p">)</span>

    <span class="nd">@validator</span><span class="o">.</span><span class="n">validates</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">_available_at</span><span class="p">,</span>
            <span class="n">Assignment</span><span class="o">.</span><span class="n">_deadline</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_kind_and_required_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">is_exam</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_at</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">deadline</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s1">&#39;Exam mode assignments are required to set an available at&#39;</span>
                    <span class="s1">&#39; and deadline&#39;</span>
                <span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;Some required data was missing for assignment </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_STATE</span><span class="p">,</span> <span class="mi">409</span>
            <span class="p">)</span>

    <span class="nd">@validator</span><span class="o">.</span><span class="n">validates</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="n">Assignment</span><span class="o">.</span><span class="n">is_lti</span><span class="p">,</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">kind</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">_exam_mode_not_for_lti</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_lti</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">is_exam</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                <span class="s1">&#39;Exam mode is not available for LTI assignments&#39;</span><span class="p">,</span>
                <span class="s1">&#39;You cannot combine LTI assignments and exam mode&#39;</span><span class="p">,</span>
                <span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_STATE</span><span class="p">,</span> <span class="mi">409</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">course</span><span class="p">:</span> <span class="s1">&#39;course_models.Course&#39;</span><span class="p">,</span>
        <span class="n">is_lti</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">visibility_state</span><span class="p">:</span> <span class="n">AssignmentVisibilityState</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">AssignmentVisibilityState</span><span class="o">.</span><span class="n">visible</span>
        <span class="p">),</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">AssignmentStateEnum</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="p">:</span> <span class="n">DatetimeWithTimezone</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lti_assignment_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">course</span><span class="o">=</span><span class="n">course</span><span class="p">,</span>
            <span class="n">course_id</span><span class="o">=</span><span class="n">course</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">visibility_state</span><span class="o">=</span><span class="n">visibility_state</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
            <span class="n">_deadline</span><span class="o">=</span><span class="n">deadline</span><span class="p">,</span>
            <span class="n">lti_assignment_id</span><span class="o">=</span><span class="n">lti_assignment_id</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">is_lti</span><span class="o">=</span><span class="n">is_lti</span><span class="p">,</span>
            <span class="n">analytics_workspaces</span><span class="o">=</span><span class="p">[</span>
                <span class="n">analytics_models</span><span class="o">.</span><span class="n">AnalyticsWorkspace</span><span class="p">(</span><span class="n">assignment</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">kind</span><span class="o">=</span><span class="n">AssignmentKind</span><span class="o">.</span><span class="n">normal</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changed_ambiguous_settings</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="n">AssignmentAmbiguousSettingTag</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_orm_load</span><span class="p">()</span>

        <span class="n">signals</span><span class="o">.</span><span class="n">ASSIGNMENT_CREATED</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@sqlalchemy</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">reconstructor</span>
    <span class="k">def</span> <span class="nf">_on_orm_load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changed_ambiguous_settings</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__structlog__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;visibility_state&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">visibility_state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;course_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_id</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if two Assignments are equal.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Assignment</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_deadline</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">DatetimeWithTimezone</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deadline</span>

    <span class="k">def</span> <span class="nf">_set_deadline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">new_deadline</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">DatetimeWithTimezone</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deadline</span> <span class="o">!=</span> <span class="n">new_deadline</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deadline</span> <span class="o">=</span> <span class="n">new_deadline</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_changed_ambiguous_settings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">AssignmentAmbiguousSettingTag</span><span class="o">.</span><span class="n">deadline</span>
            <span class="p">)</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">ASSIGNMENT_DEADLINE_CHANGED</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="n">deadline</span> <span class="o">=</span> <span class="n">hybrid_property</span><span class="p">(</span><span class="n">_get_deadline</span><span class="p">,</span> <span class="n">_set_deadline</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">send_login_links_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The login links token.</span>

<span class="sd">        This parameter is updated every time we reschedule the tasks to send</span>
<span class="sd">        the login links, and the token is also passed to the task. This makes</span>
<span class="sd">        it possible for the task to see if it should actually execute or not.</span>
<span class="sd">        Do not use a ``is None`` check to see if login tokens are enabled, but</span>
<span class="sd">        use ``send_login_links``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_login_links_token</span>

<div class="viewcode-block" id="Assignment.validate_group_set"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.validate_group_set">[docs]</a>    <span class="nd">@validates</span><span class="p">(</span><span class="s1">&#39;group_set&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_group_set</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">group_set</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;psef.models.GroupSet&#39;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;psef.models.GroupSet&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Make sure the course id of the group set is the same as the course</span>
<span class="sd">        id of the assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">group_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_id</span> <span class="o">==</span> <span class="n">group_set</span><span class="o">.</span><span class="n">course_id</span>
        <span class="k">return</span> <span class="n">group_set</span></div>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">is_visible</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Is this assignment visible to users.</span>

<span class="sd">        The value of this property does not depend on the current user at this</span>
<span class="sd">        moment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visibility_state</span> <span class="o">==</span> <span class="n">AssignmentVisibilityState</span><span class="o">.</span><span class="n">visible</span>

    <span class="k">def</span> <span class="nf">mark_as_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visibility_state</span> <span class="o">=</span> <span class="n">AssignmentVisibilityState</span><span class="o">.</span><span class="n">deleted</span>

    <span class="n">GRADE_SCALE</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_grade</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the maximum grade possible for this assignment.</span>

<span class="sd">        :returns: The maximum a grade for a submission.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GRADE_SCALE</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_grade</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_grade</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cgignore</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">ignore</span><span class="o">.</span><span class="n">SubmissionFilter</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The submission filter of this assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cgignore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cgignore_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="c1"># This branch is needed for backwards compatibility, but it is not</span>
            <span class="c1"># possible to test as it is not possible to insert this old data</span>
            <span class="c1"># using the api.</span>
            <span class="k">return</span> <span class="n">ignore</span><span class="o">.</span><span class="n">IgnoreFilterManager</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cgignore</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filter_type</span> <span class="o">=</span> <span class="n">ignore</span><span class="o">.</span><span class="n">filter_handlers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cgignore_version</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">filter_type</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cgignore</span><span class="p">))</span>

    <span class="nd">@cgignore</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cgignore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="n">ignore</span><span class="o">.</span><span class="n">SubmissionFilter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changed_ambiguous_settings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">AssignmentAmbiguousSettingTag</span><span class="o">.</span><span class="n">cgignore</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cgignore_version</span> <span class="o">=</span> <span class="n">ignore</span><span class="o">.</span><span class="n">filter_handlers</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cgignore</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">export</span><span class="p">())</span>

<div class="viewcode-block" id="Assignment.update_cgignore"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.update_cgignore">[docs]</a>    <span class="k">def</span> <span class="nf">update_cgignore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="s1">&#39;helpers.JSONType&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update the cgignore file of this assignment.</span>

<span class="sd">        :param version: The type of cgignore file to use. This should be</span>
<span class="sd">            registered with ``psef.ignore.filter_handlers``.</span>
<span class="sd">        :param data: The data to use for the cgignore, this should be</span>
<span class="sd">            compatible for the given ``version``.</span>

<span class="sd">        :raises APIException: If the ``version`` is unknown or if the ``data``</span>
<span class="sd">            is unsupported for the given ``version``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filter_type</span> <span class="o">=</span> <span class="n">ignore</span><span class="o">.</span><span class="n">filter_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filter_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                <span class="s1">&#39;The given ignore version was not found.&#39;</span><span class="p">,</span> <span class="p">(</span>
                    <span class="s1">&#39;The known values are:&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ignore</span><span class="o">.</span><span class="n">filter_handlers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">),</span> <span class="n">APICodes</span><span class="o">.</span><span class="n">OBJECT_NOT_FOUND</span><span class="p">,</span> <span class="mi">404</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cgignore</span> <span class="o">=</span> <span class="n">filter_type</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cool_off_period</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The minimum amount of time there should be between two submissions</span>
<span class="sd">            from the same user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cool_off_period</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cool_off_period</span>

    <span class="nd">@cool_off_period</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cool_off_period</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changed_ambiguous_settings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">AssignmentAmbiguousSettingTag</span><span class="o">.</span><span class="n">cool_off</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cool_off_period</span> <span class="o">=</span> <span class="n">delta</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">amount_in_cool_off_period</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The maximum amount of submissions that a user may create inside the</span>
<span class="sd">            cool off period.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            Setting this property may raise an :exc:`.APIException` if the</span>
<span class="sd">            value is not valid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amount_in_cool_off_period</span>

    <span class="nd">@amount_in_cool_off_period</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">amount_in_cool_off_period</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_amount</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">new_amount</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s1">&#39;The minimum amount of submissions that can be done in a&#39;</span>
                    <span class="s1">&#39; cool of period should be at least one&#39;</span>
                <span class="p">),</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;The given amount </span><span class="si">{</span><span class="n">new_amount</span><span class="si">}</span><span class="s1"> is too low for&#39;</span>
                    <span class="s1">&#39; `amount_in_cool_off_period`&#39;</span>
                <span class="p">),</span> <span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_PARAM</span><span class="p">,</span> <span class="mi">400</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_amount_in_cool_off_period</span> <span class="o">=</span> <span class="n">new_amount</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_submissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The maximum amount of submissions a user is allowed to make.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            Setting this property is not pure! It may raise an</span>
<span class="sd">            :exc:`.APIException` if the value is not valid, it may add a</span>
<span class="sd">            warning to the response, and it may change the</span>
<span class="sd">            ``_changed_ambiguous_settings`` attribute. Furthermore, it may also</span>
<span class="sd">            be slow as it will query the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_submissions</span>

    <span class="nd">@max_submissions</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">max_submissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_submissions</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changed_ambiguous_settings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">AssignmentAmbiguousSettingTag</span><span class="o">.</span><span class="n">max_submissions</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">helpers</span><span class="o">.</span><span class="n">handle_none</span><span class="p">(</span><span class="n">max_submissions</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                <span class="s1">&#39;You have to allow at least one submission&#39;</span><span class="p">,</span>
                <span class="s1">&#39;The set maximum amount of submissions is too low&#39;</span><span class="p">,</span>
                <span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_PARAM</span><span class="p">,</span> <span class="mi">400</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">max_submissions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_not_deleted_submissions</span><span class="p">()</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span>
                <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">user_id</span>
            <span class="p">)</span><span class="o">.</span><span class="n">having</span><span class="p">(</span><span class="n">sql_expression</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_submissions</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
            <span class="n">helpers</span><span class="o">.</span><span class="n">add_warning</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s1">&#39;There are already users with more submission than the&#39;</span>
                    <span class="s1">&#39; set max submissions amount&#39;</span>
                <span class="p">),</span>
                <span class="n">APIWarnings</span><span class="o">.</span><span class="n">LIMIT_ALREADY_EXCEEDED</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_max_submissions</span> <span class="o">=</span> <span class="n">max_submissions</span>

    <span class="k">def</span> <span class="nf">_state_getter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssignmentStateEnum</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>

    <span class="k">def</span> <span class="nf">_state_setter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span><span class="p">:</span> <span class="n">AssignmentStateEnum</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_at</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_value</span><span class="o">.</span><span class="n">is_done</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_request_start_time</span><span class="p">()</span>
            <span class="n">expired</span> <span class="o">=</span> <span class="n">now</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_at</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">AssignmentStateEnum</span><span class="o">.</span><span class="n">open</span>
                <span class="k">if</span> <span class="n">expired</span> <span class="k">else</span> <span class="n">AssignmentStateEnum</span><span class="o">.</span><span class="n">hidden</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">new_value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">new_value</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">ASSIGNMENT_STATE_CHANGED</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="n">state</span> <span class="o">=</span> <span class="n">hybrid_property</span><span class="p">(</span><span class="n">_state_getter</span><span class="p">,</span> <span class="n">_state_setter</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_schedule_send_login_links</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deadline_expired</span><span class="p">:</span>
            <span class="n">helpers</span><span class="o">.</span><span class="n">add_warning</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s1">&#39;The deadline for this assignment already expired, so we&#39;</span>
                    <span class="s1">&#39; will not send any login links.&#39;</span>
                <span class="p">),</span> <span class="n">APIWarnings</span><span class="o">.</span><span class="n">ALREADY_EXPIRED</span>
            <span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_login_links_token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="n">assig_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>

        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">psef</span><span class="o">.</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;LOGIN_TOKEN_BEFORE_TIME&#39;</span><span class="p">]:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">task_result_models</span><span class="o">.</span><span class="n">TaskResult</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">offset</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">_after_req</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_at</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_request_start_time</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
                <span class="n">eta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_at</span> <span class="o">-</span> <span class="n">offset</span>
                <span class="k">if</span> <span class="n">eta</span> <span class="o">&lt;</span> <span class="n">now</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">send_login_links_to_users</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">assig_id</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">hex</span><span class="p">,</span> <span class="n">eta</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="n">token</span><span class="o">.</span><span class="n">hex</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span>
                    <span class="n">eta</span><span class="o">=</span><span class="n">eta</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">callback_after_this_request</span><span class="p">(</span><span class="n">_after_req</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">send_login_links</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Should we send login links to the users with permissions to receive</span>
<span class="sd">        one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_login_links_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@send_login_links</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">send_login_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">new_value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_login_links</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">new_value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_send_login_links</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send_login_links_token</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">available_at</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">DatetimeWithTimezone</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;At what time should this assignment become available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_available_at</span>

    <span class="nd">@available_at</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">available_at</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">DatetimeWithTimezone</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">old_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_available_at</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_available_at</span> <span class="o">=</span> <span class="n">new_value</span>

        <span class="k">if</span> <span class="n">new_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># The state setter sets this to the correct value based on the</span>
        <span class="c1"># expiration state.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_done</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">AssignmentStateEnum</span><span class="o">.</span><span class="n">open</span>

        <span class="k">if</span> <span class="n">old_value</span> <span class="o">==</span> <span class="n">new_value</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_request_start_time</span><span class="p">()</span>
        <span class="n">expired</span> <span class="o">=</span> <span class="n">now</span> <span class="o">&gt;=</span> <span class="n">new_value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expired</span><span class="p">:</span>
            <span class="n">callback_after_this_request</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">maybe_open_assignment_at</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">),</span>
                    <span class="n">eta</span><span class="o">=</span><span class="n">new_value</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_login_links</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_send_login_links</span><span class="p">()</span>

    <span class="c1"># We don&#39;t use property.setter because in that case `new_val` could only be</span>
    <span class="c1"># a `float` because of https://github.com/python/mypy/issues/3004</span>
<div class="viewcode-block" id="Assignment.set_max_grade"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.set_max_grade">[docs]</a>    <span class="k">def</span> <span class="nf">set_max_grade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_val</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set or unset the maximum grade for this assignment.</span>

<span class="sd">        :param new_val: The new value for ``_max_grade``.</span>
<span class="sd">        :return: Nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_grade</span> <span class="o">=</span> <span class="n">new_val</span></div>

    <span class="c1">#: The minimum grade for a submission in this assignment.</span>
    <span class="n">min_grade</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="Assignment.change_notifications"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.change_notifications">[docs]</a>    <span class="k">def</span> <span class="nf">change_notifications</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">done_type</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">AssignmentDoneType</span><span class="p">],</span>
        <span class="n">grader_date</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">DatetimeWithTimezone</span><span class="p">],</span>
        <span class="n">done_email</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Change the notifications for the current assignment.</span>

<span class="sd">        :param done_type: How to determine when the assignment is done. Set</span>
<span class="sd">            this value to ``None`` to disable the reminder for this assignment.</span>
<span class="sd">        :param grader_date: The datetime when to send graders that are causing</span>
<span class="sd">            the assignment to be not done a reminder email.</span>
<span class="sd">        :param done_email: The email to send a notification when grading for</span>
<span class="sd">            this assignment is done.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mail_task_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">celery</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">revoke</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mail_task_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">done_type</span> <span class="o">=</span> <span class="n">done_type</span>

        <span class="c1"># Make sure _reminder_email_time is ``None`` if ``done_type`` is</span>
        <span class="c1"># ``none``</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reminder_email_time</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">done_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">grader_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_email</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">done_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">done_email</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reminder_email_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Make sure id is reset so we don&#39;t revoke it multiple times</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mail_task_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">send_reminder_mails</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">),</span> <span class="n">eta</span><span class="o">=</span><span class="n">grader_date</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mail_task_id</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">id</span></div>

<div class="viewcode-block" id="Assignment.graders_are_done"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.graders_are_done">[docs]</a>    <span class="k">def</span> <span class="nf">graders_are_done</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the graders of this assignment are done.</span>

<span class="sd">        :returns: A boolean indicating if the graders of this assignment are</span>
<span class="sd">            done.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># We are never done as we have no condition to be done</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_type</span> <span class="o">==</span> <span class="n">AssignmentDoneType</span><span class="o">.</span><span class="n">assigned_only</span><span class="p">:</span>
            <span class="n">assigned</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_assigned_grader_ids</span><span class="p">())</span>
            <span class="n">finished</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fg</span><span class="o">.</span><span class="n">user_id</span> <span class="k">for</span> <span class="n">fg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished_graders</span><span class="p">)</span>
            <span class="c1"># Check if every assigned grader is done.</span>
            <span class="k">return</span> <span class="n">assigned</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">finished</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_type</span> <span class="o">==</span> <span class="n">AssignmentDoneType</span><span class="o">.</span><span class="n">all_graders</span><span class="p">:</span>
            <span class="c1"># All graders should be done. As finished_graders all have unique</span>
            <span class="c1"># user ids we simply need to check if the lengths are the same</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finished_graders</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_graders</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="c1"># This is needed because of https://github.com/python/mypy/issues/4223</span>
        <span class="c1"># and to please pylint</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;The assignment has a invalid `done_type`: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">done_type</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>  <span class="c1"># pragma: no cover</span></div>

<div class="viewcode-block" id="Assignment.get_assigned_grader_ids"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.get_assigned_grader_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_assigned_grader_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the ids of all the graders that have submissions assigned.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This only gets graders with latest submissions assigned to them.</span>

<span class="sd">        :returns: The ids of the all the graders that have work assigned within</span>
<span class="sd">            this assignnment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_from_latest_submissions</span><span class="p">(</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">assigned_to</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">assigned_to</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>

        <span class="c1"># The last check (`user_id is not None`) is only needed for mypy to let</span>
        <span class="c1"># it know that this generator will never yield `None`.</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">user_id</span> <span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="ow">in</span> <span class="n">query</span> <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="Assignment.set_graders_to_not_done"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.set_graders_to_not_done">[docs]</a>    <span class="k">def</span> <span class="nf">set_graders_to_not_done</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">user_ids</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">send_mail</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_errors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the status of the given graders to &#39;not done&#39;.</span>

<span class="sd">        :param user_ids: The ids of the users that should be set to &#39;not done&#39;</span>
<span class="sd">        :param send_mail: If ``True`` the users who are reset to &#39;not done&#39;</span>
<span class="sd">            will get an email notifying them of this.</span>
<span class="sd">        :param ignore_errors: Do not raise an error if a user in ``user_ids``</span>
<span class="sd">            was not yet done.</span>
<span class="sd">        :raise ValueError: If a user in ``user_ids`` was not yet done. This can</span>
<span class="sd">            happen because the user has not indicated this yet, because this</span>
<span class="sd">            user does not exist or because of any reason.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_ids</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">graders</span> <span class="o">=</span> <span class="n">AssignmentGraderDone</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">AssignmentGraderDone</span><span class="o">.</span><span class="n">assignment_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">AssignmentGraderDone</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">user_ids</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">graders</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_ids</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Not all graders were found&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">grader</span> <span class="ow">in</span> <span class="n">graders</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">send_mail</span><span class="p">:</span>
                <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">send_grader_status_mail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">grader</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">grader</span><span class="p">)</span></div>

<div class="viewcode-block" id="Assignment.has_non_graded_submissions"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.has_non_graded_submissions">[docs]</a>    <span class="k">def</span> <span class="nf">has_non_graded_submissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the user with the given ``user_id`` has submissions</span>
<span class="sd">        assigned without a grade.</span>

<span class="sd">        :param user_id: The id of the user to check for</span>

<span class="sd">        :returns: A boolean indicating if user has work assigned that does not</span>
<span class="sd">                  have grade or a selected rubric item</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_from_latest_submissions</span><span class="p">(</span><span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="n">latest</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">assigned_to</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">rubric_models</span><span class="o">.</span><span class="n">WorkRubricItem</span><span class="p">,</span>
            <span class="n">rubric_models</span><span class="o">.</span><span class="n">WorkRubricItem</span><span class="o">.</span><span class="n">work_id</span> <span class="o">==</span> <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">isouter</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">having</span><span class="p">(</span>
            <span class="n">sql_expression</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span>
                <span class="n">sql_expression</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span>
                    <span class="n">rubric_models</span><span class="o">.</span><span class="n">WorkRubricItem</span><span class="o">.</span><span class="n">rubricitem_id</span>
                <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                <span class="c1"># We access _grade here directly as we need it to do this query</span>
                <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">_grade</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># pylint: disable=protected-access</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">False</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_rubric_points</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the maximum amount of points possible for the rubric</span>

<span class="sd">        .. note::</span>

<span class="sd">          This is always higher than zero (so also not zero).</span>


<span class="sd">        :returns: The maximum amount of points.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_max_rubric_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_max_rubric_points</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_max_points</span>

<div class="viewcode-block" id="Assignment.locked_rubric_rows"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.locked_rubric_rows">[docs]</a>    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">locked_rubric_rows</span><span class="p">(</span>
        <span class="bp">self</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;rubric_models.RubricLockReason&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the locked rubric rows of this assignment.</span>

<span class="sd">        :returns: A mapping from rubric row id to the reason why they are</span>
<span class="sd">            locked. Ids not in this mapping are not locked.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">s</span><span class="o">.</span><span class="n">rubric_row_id</span><span class="p">:</span> <span class="n">rubric_models</span><span class="o">.</span><span class="n">RubricLockReason</span><span class="o">.</span><span class="n">auto_test</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_test</span><span class="o">.</span><span class="n">all_suites</span>
        <span class="p">}</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">deadline_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Has the deadline of this assignment expired.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deadline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">deadline</span> <span class="o">&lt;</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_request_start_time</span><span class="p">()</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_dynamic_max_points</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">sql_expression</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rubric_models</span><span class="o">.</span><span class="n">RubricItem</span><span class="o">.</span><span class="n">points</span>
                                    <span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;max_val&#39;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">rubric_models</span><span class="o">.</span><span class="n">RubricRowBase</span><span class="p">,</span> <span class="n">rubric_models</span><span class="o">.</span><span class="n">RubricRowBase</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span>
            <span class="n">rubric_models</span><span class="o">.</span><span class="n">RubricItem</span><span class="o">.</span><span class="n">rubricrow_id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">rubric_models</span><span class="o">.</span><span class="n">RubricRowBase</span><span class="o">.</span><span class="n">assignment_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
                 <span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">rubric_models</span><span class="o">.</span><span class="n">RubricRowBase</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">(</span><span class="s1">&#39;sub&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql_expression</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">max_val</span><span class="p">)</span>
                                <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_open</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Is the current assignment open, which means the assignment is in the</span>
<span class="sd">        state students submit work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deadline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_open</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">deadline_expired</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_hidden</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Is the assignment hidden.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_hidden</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_done</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Is the assignment done, which means that grades are open.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_done</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">should_passback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Should we passback the current grade.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_done</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_lti</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The current name of the grade.</span>

<span class="sd">        .. warning:: This is not the same as ``str(self.state)``.</span>

<span class="sd">        :returns: The correct name of the current state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_open</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;submitting&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_open</span> <span class="k">else</span> <span class="s1">&#39;grading&#39;</span>
        <span class="k">return</span> <span class="n">AssignmentStateEnum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">whitespace_linter_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Does this assignment have a whitespace linter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=attribute-defined-outside-init</span>
        <span class="c1"># _whitespace_linter_exists is a cache property, so this is why it is</span>
        <span class="c1"># defined outside of the init.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_whitespace_linter_exists&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_whitespace_linter_exists</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">AssignmentLinter</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">AssignmentLinter</span><span class="o">.</span><span class="n">assignment_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">AssignmentLinter</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;MixedWhitespace&#39;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_whitespace_linter_exists</span>

    <span class="nd">@whitespace_linter_exists</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">whitespace_linter_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exists</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Preset the cache for ``whitespace_linter_exists`` reducing the</span>
<span class="sd">        amount of queries needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=attribute-defined-outside-init</span>
        <span class="c1"># _whitespace_linter_exists is a cache property, so this is why it is</span>
        <span class="c1"># defined outside of the init.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_whitespace_linter_exists</span> <span class="o">=</span> <span class="n">exists</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">whitespace_linter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if this assignment has an associated MixedWhitespace linter.</span>

<span class="sd">        .. note::</span>

<span class="sd">            If the assignment is not yet done we check if the ``current_user``</span>
<span class="sd">            has the permission ``can_see_linter_feedback_before_done``.</span>

<span class="sd">        :returns: True if there is an :py:class:`.AssignmentLinter` with name</span>
<span class="sd">            ``MixedWhitespace`` and ``assignment_id``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_done</span><span class="p">:</span>
                <span class="n">auth</span><span class="o">.</span><span class="n">ensure_permission</span><span class="p">(</span>
                    <span class="n">CPerm</span><span class="o">.</span><span class="n">can_see_linter_feedback_before_done</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_id</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="n">PermissionException</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitespace_linter_exists</span>

    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssignmentJSON</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates a JSON serializable representation of this assignment.</span>

<span class="sd">        :returns: An :class:``.AssignmentJSON`` dictionary.</span>

<span class="sd">        .. todo:: Remove &#39;description&#39; field from Assignment model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This property getter is quite expensive, and we evaluate it at most 3</span>
        <span class="c1"># times so caching it in a local variable is a good idea.</span>
        <span class="n">cgignore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cgignore</span>

        <span class="n">res</span><span class="p">:</span> <span class="n">AssignmentJSON</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_name</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
            <span class="s1">&#39;deadline&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">deadline</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;is_lti&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_lti</span><span class="p">,</span>
            <span class="s1">&#39;course&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="p">,</span>
            <span class="s1">&#39;cgignore&#39;</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">cgignore</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cgignore</span><span class="o">.</span><span class="n">export</span><span class="p">(),</span>
            <span class="s1">&#39;cgignore_version&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cgignore_version</span><span class="p">,</span>
            <span class="s1">&#39;whitespace_linter&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitespace_linter</span><span class="p">,</span>
            <span class="s1">&#39;fixed_max_rubric_points&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_max_rubric_points</span><span class="p">,</span>
            <span class="s1">&#39;max_grade&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_grade</span><span class="p">,</span>
            <span class="s1">&#39;group_set&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_set</span><span class="p">,</span>
            <span class="s1">&#39;auto_test_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_test_id</span><span class="p">,</span>
            <span class="s1">&#39;files_upload_enabled&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_upload_enabled</span><span class="p">,</span>
            <span class="s1">&#39;webhook_upload_enabled&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">webhook_upload_enabled</span><span class="p">,</span>
            <span class="s1">&#39;max_submissions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_submissions</span><span class="p">,</span>
            <span class="s1">&#39;cool_off_period&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cool_off_period</span><span class="p">,</span>
            <span class="s1">&#39;amount_in_cool_off_period&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount_in_cool_off_period</span><span class="p">,</span>
            <span class="s1">&#39;peer_feedback_settings&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer_feedback_settings</span><span class="p">,</span>
            <span class="s1">&#39;available_at&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_at</span><span class="p">,</span>
            <span class="s1">&#39;send_login_links&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_login_links</span><span class="p">,</span>
            <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span>

            <span class="c1"># These are all filled in based on permissions and data</span>
            <span class="c1"># availability.</span>
            <span class="s1">&#39;reminder_time&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;lms_name&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;done_type&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;done_email&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;division_parent_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;analytics_workspace_ids&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">lti_provider</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;lms_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">lti_provider</span><span class="o">.</span><span class="n">lms_name</span>

        <span class="k">if</span> <span class="n">psef</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span>
            <span class="n">CPerm</span><span class="o">.</span><span class="n">can_grade_work</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">course_id</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_email</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s1">&#39;done_email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_email</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s1">&#39;done_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_type</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reminder_email_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s1">&#39;reminder_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reminder_email_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">psef</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span>
            <span class="n">CPerm</span><span class="o">.</span><span class="n">can_see_assignee</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_id</span>
        <span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;division_parent_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">division_parent_id</span>

        <span class="k">for</span> <span class="n">workspace</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytics_workspaces</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">auth</span><span class="o">.</span><span class="n">AnalyticsWorkspacePermissions</span><span class="p">(</span><span class="n">workspace</span>
                                                  <span class="p">)</span><span class="o">.</span><span class="n">ensure_may_see</span><span class="o">.</span><span class="n">as_bool</span><span class="p">():</span>
                <span class="n">res</span><span class="p">[</span><span class="s1">&#39;analytics_workspace_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">workspace</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="Assignment.set_state_with_string"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.set_state_with_string">[docs]</a>    <span class="k">def</span> <span class="nf">set_state_with_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update the current state (class:`AssignmentStateEnum`).</span>

<span class="sd">        You can update the state to hidden, done or open. A assignment can not</span>
<span class="sd">        be updated to &#39;submitting&#39; or &#39;grading&#39; as this is an assignment with</span>
<span class="sd">        state of &#39;open&#39; and, respectively, a deadline before or after the</span>
<span class="sd">        current time.</span>

<span class="sd">        :param state: The new state, can be &#39;hidden&#39;, &#39;done&#39; or &#39;open&#39;</span>
<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_state</span> <span class="o">=</span> <span class="n">AssignmentStateEnum</span><span class="p">[</span><span class="n">state</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidAssignmentState</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">state</span><span class="si">}</span><span class="s1"> is not a valid state&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_state</span></div>

    <span class="k">def</span> <span class="nf">get_amount_not_deleted_submissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">handle_none</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_not_deleted_submissions</span><span class="p">()</span><span class="o">.</span><span class="n">with_entities</span><span class="p">(</span>
                <span class="n">sql_expression</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span>
                    <span class="n">cg_sqlalchemy_helpers</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">(),</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Assignment.get_not_deleted_submissions"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.get_not_deleted_submissions">[docs]</a>    <span class="k">def</span> <span class="nf">get_not_deleted_submissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MyQuery</span><span class="p">[</span><span class="s1">&#39;work_models.Work&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get a query returning all not deleted submissions to this</span>
<span class="sd">            assignment.</span>

<span class="sd">        This method returns a faster query than just filtering submissions on</span>
<span class="sd">        not deleted and an assignment, as it checks the state of the assignment</span>
<span class="sd">        itself separately.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">assignment</span> <span class="o">==</span> <span class="bp">self</span><span class="p">,</span>
            <span class="c1"># We don&#39;t need the intelligent `deleted` attribute here from the</span>
            <span class="c1"># Work models, which also checks if the assignment is deleted, as</span>
            <span class="c1"># we already check this at the start of the function.</span>
            <span class="o">~</span><span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">_deleted</span><span class="p">,</span>  <span class="c1"># pylint: disable=protected-access</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_visible</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">base_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">false</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">base_query</span></div>

<div class="viewcode-block" id="Assignment.get_latest_submission_for_user"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.get_latest_submission_for_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_latest_submission_for_user</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="s1">&#39;user_models.User&#39;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">group_of_user</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;group_models.Group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MyNonOrderableQuery</span><span class="p">[</span><span class="s1">&#39;work_models.Work&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the latest non deleted submission for a given user.</span>

<span class="sd">        This function returns a query, but also executes a query, so be careful</span>
<span class="sd">        in calling this in a loop.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Be very careful when changing this function, it is important that</span>
<span class="sd">            it always returns the same submission for a user as</span>
<span class="sd">            `get_from_latest_submission`.</span>

<span class="sd">        :param user: The user to get the latest non deleted submission for.</span>
<span class="sd">        :param group_of_user: The group that the user belongs to for this</span>
<span class="sd">            assignment. This parameter prevents that the database is queried to</span>
<span class="sd">            check if the user is in a group.</span>
<span class="sd">        :returns: A query that should not be reordered that contains the latest</span>
<span class="sd">            submission for the given user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_not_deleted_submissions</span><span class="p">()</span>

        <span class="n">user_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
        <span class="n">order_bys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">desc</span><span class="p">(),</span>
            <span class="c1"># Sort by id too so that when the date is exactly the same we can</span>
            <span class="c1"># still have well defined behavior (i.e. always get the same</span>
            <span class="c1"># submissions for a user.)</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="n">group_user_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">group_of_user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">group_user_id</span> <span class="o">=</span> <span class="n">group_of_user</span><span class="o">.</span><span class="n">virtual_user_id</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_set_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">group_user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">psef</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Group</span><span class="o">.</span><span class="n">virtual_user_id</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">group_set_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_set_id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">psef</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Group</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">group_user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">user_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_user_id</span><span class="p">)</span>
                <span class="c1"># Make sure that group submissions are ordered before user</span>
                <span class="c1"># submissions. This makes sure group submissions are always</span>
                <span class="c1"># seen as the latest submission, even if their created_at is a</span>
                <span class="c1"># bit later. This is the same behavior as</span>
                <span class="c1"># `get_from_latest_submission`.</span>
                <span class="n">order_bys</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">group_user_id</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">base_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">user_ids</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="o">*</span><span class="n">order_bys</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

    <span class="nd">@t</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="nf">get_from_latest_submissions</span><span class="p">(</span>  <span class="c1"># pylint: disable=function-redefined,missing-docstring,unused-argument,no-self-use</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__to_query</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">_T_BASE</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_deleted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_old_user_submissions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MyQuery</span><span class="p">[</span><span class="n">_T_BASE</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@t</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="nf">get_from_latest_submissions</span><span class="p">(</span>  <span class="c1"># pylint: disable=function-redefined,missing-docstring,unused-argument,no-self-use</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__to_query</span><span class="p">:</span> <span class="n">DbColumn</span><span class="p">[</span><span class="n">T</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_deleted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_old_user_submissions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MyQuery</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">T</span><span class="p">]]:</span>
        <span class="o">...</span>

    <span class="nd">@t</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="nf">get_from_latest_submissions</span><span class="p">(</span>  <span class="c1"># pylint: disable=function-redefined,missing-docstring,unused-argument,no-self-use</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">__first</span><span class="p">:</span> <span class="n">DbColumn</span><span class="p">[</span><span class="n">T</span><span class="p">],</span>
        <span class="n">__second</span><span class="p">:</span> <span class="n">DbColumn</span><span class="p">[</span><span class="n">Y</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_deleted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_old_user_submissions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MyQuery</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">T</span><span class="p">,</span> <span class="n">Y</span><span class="p">]]:</span>
        <span class="o">...</span>

<div class="viewcode-block" id="Assignment.get_from_latest_submissions"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.get_from_latest_submissions">[docs]</a>    <span class="k">def</span> <span class="nf">get_from_latest_submissions</span><span class="p">(</span>  <span class="c1"># pylint: disable=function-redefined</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">to_query</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
        <span class="n">include_deleted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_old_user_submissions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MyQuery</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the given fields from all last submitted submissions.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Be very careful when changing this function, it is important that</span>
<span class="sd">            it always returns the same submission for a user as</span>
<span class="sd">            `get_latest_submission_for_user`.</span>

<span class="sd">        :param to_query: The field to get from the last submitted submissions.</span>
<span class="sd">        :returns: A query object with the given fields selected from the last</span>
<span class="sd">            submissions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="o">*</span><span class="n">to_query</span><span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_visible</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">base_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">false</span><span class="p">())</span>

        <span class="c1"># TODO: Investigate this subquery here. We need to do that right now as</span>
        <span class="c1"># other functions might use this method and might want to order in a</span>
        <span class="c1"># different way or do other distincts. But I have no idea how slow this</span>
        <span class="c1"># subquery makes the query, as postgres could optimize it out.</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">assignment_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">desc</span><span class="p">(),</span>
            <span class="c1"># Sort by id too so that when the date is exactly the same we can</span>
            <span class="c1"># still have well defined behavior (i.e. always get the same</span>
            <span class="c1"># submissions for a user.)</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_deleted</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">_deleted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">sub</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">(</span><span class="s1">&#39;ids&#39;</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">base_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">sub</span><span class="p">),</span> <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_set_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">include_old_user_submissions</span><span class="p">:</span>
            <span class="n">sub_query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">assignment_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">psef</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Group</span><span class="o">.</span><span class="n">virtual_user_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">include_deleted</span><span class="p">:</span>
                <span class="c1"># We don&#39;t need the intelligent `deleted` attribute here from</span>
                <span class="c1"># the Work models, which also checks if the assignment is</span>
                <span class="c1"># deleted, as we already check this at the start of the</span>
                <span class="c1"># function.</span>
                <span class="c1"># pylint: disable=protected-access</span>
                <span class="n">sub_query</span> <span class="o">=</span> <span class="n">sub_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">_deleted</span><span class="p">)</span>
            <span class="n">groups_with_submission</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">psef</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Group</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">psef</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Group</span><span class="o">.</span><span class="n">group_set_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_set_id</span><span class="p">,</span>
                <span class="n">sub_query</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="o">~</span><span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">users_groups</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="n">users_groups</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">group_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">groups_with_submission</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Assignment.get_all_latest_submissions"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.get_all_latest_submissions">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_latest_submissions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_deleted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_old_user_submissions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MyQuery</span><span class="p">[</span><span class="s1">&#39;work_models.Work&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get a list of all the latest submissions</span>
<span class="sd">        (:class:`.work_models.Work`) by each :class:`.user_models.User` who has</span>
<span class="sd">        submitted at least one work for this assignment.</span>

<span class="sd">        :returns: The latest submissions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get_from_latest_submissions uses SQLAlchemy magic that MyPy cannot</span>
        <span class="c1"># encode.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_from_latest_submissions</span><span class="p">(</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="p">,</span>
            <span class="n">include_deleted</span><span class="o">=</span><span class="n">include_deleted</span><span class="p">,</span>
            <span class="n">include_old_user_submissions</span><span class="o">=</span><span class="n">include_old_user_submissions</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Assignment.get_divided_amount_missing"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.get_divided_amount_missing">[docs]</a>    <span class="k">def</span> <span class="nf">get_divided_amount_missing</span><span class="p">(</span>
        <span class="bp">self</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">,</span> <span class="n">DefaultArg</span><span class="p">(</span><span class="nb">bool</span><span class="p">)],</span> <span class="n">t</span><span class="o">.</span>
                                                   <span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]:</span>
        <span class="sd">&quot;&quot;&quot;Get a mapping between user and the amount of submissions that they</span>
<span class="sd">        should be assigned but are not.</span>

<span class="sd">        For example if we have two graders, John and Dorian that respectively</span>
<span class="sd">        have the weights 1 and 1 assigned. Lets say we have three submissions</span>
<span class="sd">        divided in such a way that John has to grade 2 and Dorian has to grade</span>
<span class="sd">        one, then our function we return that John is missing -0.5 submissions</span>
<span class="sd">        and Dorian is missing 0.5.</span>

<span class="sd">        .. note::</span>

<span class="sd">            If ``self.assigned_graders`` is empty this function and its</span>
<span class="sd">            recalculate will always return an empty directory.</span>

<span class="sd">        :returns: A mapping between user int and the amount missing as</span>
<span class="sd">            described above. Furthermore it returns a function that can be used</span>
<span class="sd">            to recalculate this mapping by given it the user id of the user</span>
<span class="sd">            that was assigned a submission.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">assigned_graders</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{},</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="o">=</span><span class="kc">False</span><span class="p">:</span> <span class="p">{}</span>

        <span class="n">total_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">weight</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assigned_graders</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">amount_subs</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">amount_subs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_from_latest_submissions</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">sql_expression</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>

        <span class="n">divided_amount</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">u_id</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_from_latest_submissions</span><span class="p">(</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">assigned_to</span><span class="p">,</span> <span class="n">sql_expression</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">assigned_to</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">u_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">divided_amount</span><span class="p">[</span><span class="n">u_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">amount</span>

        <span class="n">missing</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">assigned</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assigned_graders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">missing</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">assigned</span><span class="o">.</span><span class="n">weight</span> <span class="o">/</span> <span class="n">total_weight</span> <span class="o">*</span>
                                <span class="n">amount_subs</span><span class="p">)</span> <span class="o">-</span> <span class="n">divided_amount</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">__recalculate</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">increment_sub_amount</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
                          <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
            <span class="k">nonlocal</span> <span class="n">amount_subs</span>

            <span class="k">if</span> <span class="n">increment_sub_amount</span><span class="p">:</span>
                <span class="n">amount_subs</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">divided_amount</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">assigned_user_id</span><span class="p">,</span> <span class="n">assigned</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assigned_graders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">missing</span><span class="p">[</span><span class="n">assigned_user_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">assigned</span><span class="o">.</span><span class="n">weight</span> <span class="o">/</span> <span class="n">total_weight</span> <span class="o">*</span> <span class="n">amount_subs</span>
                <span class="p">)</span> <span class="o">-</span> <span class="n">divided_amount</span><span class="p">[</span><span class="n">assigned_user_id</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">missing</span>

        <span class="k">return</span> <span class="n">missing</span><span class="p">,</span> <span class="n">__recalculate</span></div>

    <span class="k">def</span> <span class="nf">_weights_changed</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">user_weights</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="s1">&#39;user_models.User&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the given users and their weights have changed since the</span>
<span class="sd">        last division.</span>

<span class="sd">        :param user_weights: A list of tuples that map users and the weights.</span>
<span class="sd">            The weights are used to determine how many submissions should be</span>
<span class="sd">            assigned to a single user.</span>
<span class="sd">        :returns: If the weights have changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_weights</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assigned_graders</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">user_weights</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assigned_graders</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assigned_graders</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span> <span class="o">!=</span> <span class="n">weight</span>
                <span class="p">):</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="Assignment.divide_submissions"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.divide_submissions">[docs]</a>    <span class="k">def</span> <span class="nf">divide_submissions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">user_weights</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="s1">&#39;user_models.User&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Divide all newest submissions for this assignment between the given</span>
<span class="sd">        users.</span>

<span class="sd">        This methods prefers to keep submissions assigned to the same grader as</span>
<span class="sd">        much as possible. To get completely new and random assignments first</span>
<span class="sd">        clear all old assignments.</span>

<span class="sd">        :param user_weights: A list of tuples that map users and the weights.</span>
<span class="sd">            The weights are used to determine how many submissions should be</span>
<span class="sd">            assigned to a single user.</span>
<span class="sd">        :returns: Nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the weights are not changed we should not divide anything as that</span>
        <span class="c1"># would mean that pressing the button again on accident might change</span>
        <span class="c1"># the (custom) division.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights_changed</span><span class="p">(</span><span class="n">user_weights</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">submissions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_latest_submissions</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">user</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">is_test_student</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">shuffle</span><span class="p">(</span><span class="n">submissions</span><span class="p">)</span>

        <span class="n">counts</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">user_submissions</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">work_models</span><span class="o">.</span>
                                                                   <span class="n">Work</span><span class="p">]]</span>
        <span class="n">user_submissions</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="c1"># Remove all users not in user_weights</span>
        <span class="n">new_users</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">user_weights</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">submission</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">submission</span><span class="o">.</span><span class="n">assigned_to</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_users</span><span class="p">:</span>
                <span class="n">submission</span><span class="o">.</span><span class="n">assigned_to</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">counts</span><span class="p">[</span><span class="n">submission</span><span class="o">.</span><span class="n">assigned_to</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">user_submissions</span><span class="p">[</span><span class="n">submission</span><span class="o">.</span><span class="n">assigned_to</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span>

        <span class="n">new_total_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weight</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">user_weights</span><span class="p">)</span>

        <span class="n">negative_weights</span><span class="p">,</span> <span class="n">positive_weights</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">new_weight</span> <span class="ow">in</span> <span class="n">user_weights</span><span class="p">:</span>
            <span class="n">percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_weight</span> <span class="o">/</span> <span class="n">new_total_weight</span><span class="p">)</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">percentage</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">submissions</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">new</span> <span class="o">&lt;</span> <span class="n">counts</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">]:</span>
                <span class="n">negative_weights</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">-</span> <span class="n">new</span>
            <span class="k">elif</span> <span class="n">new</span> <span class="o">&gt;</span> <span class="n">counts</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">]:</span>
                <span class="n">positive_weights</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span> <span class="o">-</span> <span class="n">counts</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">delete_amount</span> <span class="ow">in</span> <span class="n">negative_weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">user_submissions</span><span class="p">[</span><span class="n">user_id</span><span class="p">][:</span><span class="nb">round</span><span class="p">(</span><span class="n">delete_amount</span><span class="p">)]:</span>
                <span class="n">user_submissions</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>

        <span class="n">to_assign</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">positive_weights</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">positive_weights</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
            <span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">new_amount</span> <span class="ow">in</span> <span class="n">positive_weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">to_assign</span> <span class="o">+=</span> <span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">new_amount</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span>

        <span class="n">shuffle</span><span class="p">(</span><span class="n">to_assign</span><span class="p">)</span>
        <span class="n">newly_assigned</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sub</span><span class="p">,</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">user_submissions</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">cycle</span><span class="p">(</span><span class="n">to_assign</span><span class="p">)):</span>
            <span class="n">sub</span><span class="o">.</span><span class="n">assigned_to</span> <span class="o">=</span> <span class="n">user_id</span>
            <span class="n">newly_assigned</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_graders_to_not_done</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">newly_assigned</span><span class="p">),</span>
            <span class="n">send_mail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assigned_graders</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">user_weights</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">AssignmentAssignedGrader</span><span class="p">(</span>
                    <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">assignment</span><span class="o">=</span><span class="bp">self</span>
                <span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Assignment.get_assignee_from_division_children"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.get_assignee_from_division_children">[docs]</a>    <span class="k">def</span> <span class="nf">get_assignee_from_division_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_id</span><span class="p">:</span> <span class="nb">int</span>
                                            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get id of the most common grader for a student in the division</span>
<span class="sd">        children of this assignment.</span>

<span class="sd">        If this is tied a user is chosen arbitrarily from the most common</span>
<span class="sd">        graders. If the student is not present in the children ``None`` is</span>
<span class="sd">        returned.</span>

<span class="sd">        :param student_id: The id of the student you want to get the assignee</span>
<span class="sd">            for.</span>
<span class="sd">        :returns: The id of the assignee, or ``None`` if there is none.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">division_children</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">division_parent_id</span>

        <span class="n">shuffled_children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">division_children</span><span class="p">)</span>
        <span class="n">shuffle</span><span class="p">(</span><span class="n">shuffled_children</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_other_assignees</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">shuffled_children</span><span class="p">:</span>
                <span class="n">assignee_id</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">get_from_latest_submissions</span><span class="p">(</span>
                    <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">assigned_to</span>
                <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">student_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">assignee_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">assignee_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">assignee_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">latest</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">get_other_assignees</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">latest</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">latest</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Assignment.get_assignee_for_submission"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.get_assignee_for_submission">[docs]</a>    <span class="k">def</span> <span class="nf">get_assignee_for_submission</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sub</span><span class="p">:</span> <span class="s1">&#39;work_models.Work&#39;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">from_divided</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the id of the default assignee for a given submission.</span>

<span class="sd">        This checks if a user has handed in a submission to this assignment</span>
<span class="sd">        before. In that is the case the same assignee is returned. Otherwise,</span>
<span class="sd">        if the assignment has a division parent it checks for an assignee</span>
<span class="sd">        there, and uses the value if it is not ``None``.</span>

<span class="sd">        If the assignment doesn&#39;t have a submission by the same user and is a</span>
<span class="sd">        parent it will search through the children. There the most common</span>
<span class="sd">        assignee for the submitting user is found. If such an assignee exists</span>
<span class="sd">        this value is returned.</span>

<span class="sd">        Finally if ``from_divided`` is enabled it finds a assignee among the</span>
<span class="sd">        divided graders. If no assignee is found ``None`` is returned.</span>

<span class="sd">        :param sub: The submission you want to get the assignee for.</span>
<span class="sd">        :param from_divided: Get a grader from the divided graders if all other</span>
<span class="sd">            methods fail.</span>
<span class="sd">        :returns: The id of the assignee or ``None`` if no assignee was found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_test_student</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_from_latest_submissions</span><span class="p">(</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">assigned_to</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">sub</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">user_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">division_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">division_parent</span><span class="o">.</span><span class="n">get_assignee_for_submission</span><span class="p">(</span>
                <span class="n">sub</span><span class="p">,</span> <span class="n">from_divided</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">user</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">division_children</span><span class="p">:</span>
            <span class="n">most_common</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_assignee_from_division_children</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">most_common</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">most_common</span>

        <span class="k">if</span> <span class="n">from_divided</span><span class="p">:</span>
            <span class="n">missing</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_divided_amount_missing</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">missing</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">missing</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Assignment.connect_division"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.connect_division">[docs]</a>    <span class="k">def</span> <span class="nf">connect_division</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;Assignment&#39;</span><span class="p">]</span>
                         <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="s1">&#39;work_models.Work&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Set the division parent of this assignment.</span>

<span class="sd">        :param parent: The assignment that should be the new division parent of</span>
<span class="sd">            this assignment. Set this to ``None`` to remove the division parent</span>
<span class="sd">            of this assignment.</span>
<span class="sd">        :returns: A list of submissions that couldn&#39;t be assigned and are left</span>
<span class="sd">            unassigned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If we unset the division parent we don&#39;t touch the divisions at all.</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">division_parent</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">assert</span> <span class="n">parent</span><span class="o">.</span><span class="n">division_parent</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">parent</span><span class="o">.</span><span class="n">course_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_id</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">division_parent_id</span> <span class="o">==</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># We first empty this value. This is needed as</span>
        <span class="c1"># `AssignmentAssignedGrader` objects have a primary key constraint on</span>
        <span class="c1"># the tuple `(assignment_id, user_id)`. If a assignee only changes</span>
        <span class="c1"># weight sqlalchemy gets confused as this tuple doesn&#39;t change. This is</span>
        <span class="c1"># a bit slower (as the flush does a db roundtrip) but fixes that issue.</span>
        <span class="c1"># TODO: Investigate if this is possible without the db.session.flush()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assigned_graders</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assigned_graders</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">AssignmentAssignedGrader</span><span class="p">(</span>
                <span class="n">weight</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
                <span class="n">user_id</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
                <span class="n">assignment_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">assigned_graders</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">division_parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="n">user_sub</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">user_id</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_latest_submissions</span><span class="p">()}</span>
        <span class="n">todo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">user_sub</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">sub</span><span class="o">.</span><span class="n">assigned_to</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">todo</span><span class="p">[</span><span class="n">sub</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span>

        <span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">assigned_to</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">get_from_latest_submissions</span><span class="p">(</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">assigned_to</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">user_sub</span><span class="p">:</span>
                <span class="n">user_sub</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">assigned_to</span> <span class="o">=</span> <span class="n">assigned_to</span>
                <span class="k">if</span> <span class="n">user_sub</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">assigned_to</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">todo</span><span class="p">[</span><span class="n">user_sub</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">missing</span><span class="p">,</span> <span class="n">recalc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_divided_amount_missing</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">todo</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_test_student</span><span class="p">:</span>
                <span class="c1"># Remove from todo as we simply do not want to assign these</span>
                <span class="c1"># submissions.</span>
                <span class="k">del</span> <span class="n">todo</span><span class="p">[</span><span class="n">sub</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
                <span class="k">continue</span>

            <span class="n">other</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get_assignee_from_division_children</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">missing</span><span class="p">:</span>
                <span class="n">other</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">missing</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">missing</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
            <span class="n">sub</span><span class="o">.</span><span class="n">assigned_to</span> <span class="o">=</span> <span class="n">other</span>
            <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">assigned_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">recalc</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">assigned_to</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">todo</span><span class="p">[</span><span class="n">sub</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">todo</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>

<div class="viewcode-block" id="Assignment.get_all_graders"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.get_all_graders">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_graders</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sort</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MyQuery[t.Tuple[str, int, bool]]&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get all graders for this assignment.</span>

<span class="sd">        The graders are retrieved from the database using a single query. The</span>
<span class="sd">        return value is a query with three items selected: the first is the</span>
<span class="sd">        name of the grader, the second is the database id of the user object</span>
<span class="sd">        of grader and the third and last is a boolean indicating if this grader</span>
<span class="sd">        is done grading. You can use this query as an iterator.</span>

<span class="sd">        :param sort: Should the graders be sorted by name.</span>
<span class="sd">        :returns: A query with items selected as described above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">done_graders</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
            <span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
            <span class="c1"># This now can be NULL as we do an outerjoin on assignments graders</span>
            <span class="c1"># done. It is `None` for every grader that is not yet done.</span>
            <span class="o">~</span><span class="n">AssignmentGraderDone</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span>
                <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">),</span>
            <span class="n">user_course</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;course_id&quot;</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">AssignmentGraderDone</span><span class="p">,</span>
            <span class="n">sql_expression</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span>
                <span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">AssignmentGraderDone</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
                <span class="n">AssignmentGraderDone</span><span class="o">.</span><span class="n">assignment_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">isouter</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">user_course</span><span class="p">,</span>
            <span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user_course</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">(</span><span class="s1">&#39;done_graders&#39;</span><span class="p">)</span>

        <span class="n">graders</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">course_permissions</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_role_id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">CourseRole</span><span class="p">,</span>
            <span class="n">CourseRole</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">course_permissions</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_role_id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">Permission</span><span class="p">,</span>
            <span class="n">course_permissions</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">permission_id</span> <span class="o">==</span> <span class="n">Permission</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">CourseRole</span><span class="o">.</span><span class="n">course_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_id</span><span class="p">,</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
                <span class="n">PermissionComp</span><span class="p">[</span><span class="n">CPerm</span><span class="p">],</span>
                <span class="n">Permission</span><span class="p">[</span><span class="n">CPerm</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>  <span class="c1"># type: ignore[misc]</span>
            <span class="p">)</span> <span class="o">==</span> <span class="n">CPerm</span><span class="o">.</span><span class="n">can_grade_work</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">(</span><span class="s1">&#39;graders&#39;</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="c1"># We cast here so that we get an accurately types query, as</span>
            <span class="c1"># `RawTable.c.{something}` is currently always typed as `Any`.</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">done_graders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">done_graders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="n">done_graders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">done</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">graders</span><span class="p">,</span> <span class="n">done_graders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_id</span> <span class="o">==</span> <span class="n">graders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_role_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">sql_expression</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">done_graders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Assignment.has_group_submissions"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.has_group_submissions">[docs]</a>    <span class="k">def</span> <span class="nf">has_group_submissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the assignment has submissions by a group.</span>

<span class="sd">        :returns: ``True`` if the assignment has a submission by a group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">assignment_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">deleted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="p">,</span>
                <span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">user_id</span>
            <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">psef</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Group</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span></div>

<div class="viewcode-block" id="Assignment.get_author_handing_in"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.get_author_handing_in">[docs]</a>    <span class="k">def</span> <span class="nf">get_author_handing_in</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">request_args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;user_models.User&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the author handing in a submission from the request arguments.</span>

<span class="sd">        This function also validates that the current user is allowed to</span>
<span class="sd">        hand-in a submission as the given user.</span>

<span class="sd">        :param request_args: The GET request arguments of the request.</span>
<span class="sd">        :returns: The :class:`.user_models.User` that should be the author of</span>
<span class="sd">            the submission.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">given_author</span> <span class="o">=</span> <span class="n">request_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">is_test_submission</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">request_arg_true</span><span class="p">(</span>
            <span class="s1">&#39;is_test_submission&#39;</span><span class="p">,</span> <span class="n">request_args</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Uploading submission&#39;</span><span class="p">,</span>
            <span class="n">is_test_submission</span><span class="o">=</span><span class="n">is_test_submission</span><span class="p">,</span>
            <span class="n">given_author</span><span class="o">=</span><span class="n">given_author</span><span class="p">,</span>
            <span class="n">assignment_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">given_author</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">is_test_submission</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                <span class="s1">&#39;You cannot provide an author for a test submission&#39;</span><span class="p">,</span> <span class="p">(</span>
                    <span class="s1">&#39;The options `given_author` and `is_test_submission`&#39;</span>
                    <span class="s1">&#39; cannot be combined&#39;</span>
                <span class="p">),</span> <span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_PARAM</span><span class="p">,</span> <span class="mi">400</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deadline</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_test_submission</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;The deadline for this assignment has not yet been set. &#39;</span>
                <span class="s1">&#39;Please ask your teacher to set a deadline before you can &#39;</span>
                <span class="s1">&#39;submit your work.&#39;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">psef</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span>
                <span class="n">CPerm</span><span class="o">.</span><span class="n">can_submit_others_work</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_id</span>
            <span class="p">):</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39; You can still upload a test submission.&#39;</span>
            <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                <span class="n">msg</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;The deadline for assignment </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> is unset.&#39;</span><span class="p">,</span>
                <span class="n">APICodes</span><span class="o">.</span><span class="n">ASSIGNMENT_DEADLINE_UNSET</span><span class="p">,</span>
                <span class="mi">400</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">is_test_submission</span><span class="p">:</span>
            <span class="n">author</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">get_test_student</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">given_author</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">author</span> <span class="o">=</span> <span class="n">psef</span><span class="o">.</span><span class="n">current_user</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">author</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">filter_single_or_404</span><span class="p">(</span>
                <span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="p">,</span>
                <span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">given_author</span><span class="p">,</span>
                <span class="n">also_error</span><span class="o">=</span><span class="k">lambda</span> <span class="n">user</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">is_test_student</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_set</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">author</span><span class="o">.</span><span class="n">is_test_student</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_set</span><span class="o">.</span><span class="n">get_valid_group_for_user</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>
            <span class="n">resulting_author</span> <span class="o">=</span> <span class="n">author</span> <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">group</span><span class="o">.</span><span class="n">virtual_user</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resulting_author</span> <span class="o">=</span> <span class="n">author</span>

        <span class="n">auth</span><span class="o">.</span><span class="n">ensure_can_submit_work</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="n">resulting_author</span><span class="p">,</span> <span class="n">for_user</span><span class="o">=</span><span class="n">author</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">resulting_author</span></div>

<div class="viewcode-block" id="Assignment.has_webhooks"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.has_webhooks">[docs]</a>    <span class="k">def</span> <span class="nf">has_webhooks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Does this assignment have any connected webhooks.</span>

<span class="sd">        :returns: The presence of any webhooks for this assignment after</span>
<span class="sd">                  querying the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">WebhookBase</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">assignment</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span></div>

<div class="viewcode-block" id="Assignment.get_changed_ambiguous_combinations"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.get_changed_ambiguous_combinations">[docs]</a>    <span class="k">def</span> <span class="nf">get_changed_ambiguous_combinations</span><span class="p">(</span>
        <span class="bp">self</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterator</span><span class="p">[</span><span class="n">_AssignmentAmbiguousSetting</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get all new ambiguous setting combinations on this assignment.</span>

<span class="sd">        This simply gets all ambiguous settings on an assignment and checks</span>
<span class="sd">        which settings were changed since the assignment was loaded from the</span>
<span class="sd">        database/created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_ambiguous_combinations</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">warning</span><span class="o">.</span><span class="n">tags</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changed_ambiguous_settings</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">warning</span></div>

<div class="viewcode-block" id="Assignment.get_all_ambiguous_combinations"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.get_all_ambiguous_combinations">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_ambiguous_combinations</span><span class="p">(</span>
        <span class="bp">self</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">_AssignmentAmbiguousSetting</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get all ambiguous settings for an assignment.</span>

<span class="sd">        :returns: A list of ambiguous settings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cgignore</span><span class="p">,</span> <span class="p">(</span><span class="n">ignore</span><span class="o">.</span><span class="n">EmptySubmissionFilter</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">webhook_upload_enabled</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">_AssignmentAmbiguousSetting</span><span class="p">(</span>
                    <span class="n">tags</span><span class="o">=</span><span class="p">{</span>
                        <span class="n">AssignmentAmbiguousSettingTag</span><span class="o">.</span><span class="n">webhook</span><span class="p">,</span>
                        <span class="n">AssignmentAmbiguousSettingTag</span><span class="o">.</span><span class="n">cgignore</span>
                    <span class="p">},</span>
                    <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                        <span class="s1">&#39;Hand-in requirements are currently ignored when&#39;</span>
                        <span class="s1">&#39; handing in using Git&#39;</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cool_off_period</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">webhook_upload_enabled</span>
        <span class="p">):</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">_AssignmentAmbiguousSetting</span><span class="p">(</span>
                    <span class="n">tags</span><span class="o">=</span><span class="p">{</span>
                        <span class="n">AssignmentAmbiguousSettingTag</span><span class="o">.</span><span class="n">webhook</span><span class="p">,</span>
                        <span class="n">AssignmentAmbiguousSettingTag</span><span class="o">.</span><span class="n">cool_off</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                        <span class="s1">&#39;When combining a cool off period with webhooks &#39;</span>
                        <span class="s1">&#39; submissions can be silently ignored when students&#39;</span>
                        <span class="s1">&#39; push too quickly.&#39;</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_submissions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">webhook_upload_enabled</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">_AssignmentAmbiguousSetting</span><span class="p">(</span>
                    <span class="n">tags</span><span class="o">=</span><span class="p">{</span>
                        <span class="n">AssignmentAmbiguousSettingTag</span><span class="o">.</span><span class="n">webhook</span><span class="p">,</span>
                        <span class="n">AssignmentAmbiguousSettingTag</span><span class="o">.</span><span class="n">max_submissions</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                        <span class="s1">&#39;When combining a limit on submissions and webhooks&#39;</span>
                        <span class="s1">&#39; submissions can be silently dropped, as the student&#39;</span>
                        <span class="s1">&#39; might not check if a push results in a new&#39;</span>
                        <span class="s1">&#39; submission.&#39;</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Assignment.update_submission_types"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.assignment.Assignment.update_submission_types">[docs]</a>    <span class="k">def</span> <span class="nf">update_submission_types</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">webhook</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="n">files</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update the enabled submission types for this assignment.</span>

<span class="sd">        This method has the side effect of possibly adding items to the</span>
<span class="sd">        ``_changed_ambiguous_settings`` attribute. So if you&#39;re setting</span>
<span class="sd">        multiple properties on the assignment make sure you call</span>
<span class="sd">        :meth:`.Assignment.get_changed_ambiguous_combinations` at the end. This</span>
<span class="sd">        method might also add a warning to the response.</span>

<span class="sd">        :param webhook: Should users be allowed to upload using webhooks. Pass</span>
<span class="sd">            ``None`` to keep the current option.</span>
<span class="sd">        :param files: Should users be allowed to upload files for a submission.</span>
<span class="sd">            Pass ``None`` to keep the current option.</span>

<span class="sd">        :raises APIException: If both ``webhook`` and ``files`` uploading will</span>
<span class="sd">            be disabled at the end of this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files_upload_enabled</span> <span class="o">=</span> <span class="n">files</span>

        <span class="k">if</span> <span class="n">webhook</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_changed_ambiguous_settings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">AssignmentAmbiguousSettingTag</span><span class="o">.</span><span class="n">webhook</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">webhook_upload_enabled</span> <span class="o">=</span> <span class="n">webhook</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">webhook_upload_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_webhooks</span><span class="p">():</span>
                <span class="n">helpers</span><span class="o">.</span><span class="n">add_warning</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s1">&#39;This assignment already has existing webhooks, these &#39;</span>
                        <span class="s1">&#39;will continue to work&#39;</span>
                    <span class="p">),</span> <span class="n">APIWarnings</span><span class="o">.</span><span class="n">EXISTING_WEBHOOKS_EXIST</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">webhook_upload_enabled</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_upload_enabled</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                <span class="s1">&#39;At least one way of uploading needs to be enabled&#39;</span><span class="p">,</span>
                <span class="s1">&#39;It is not possible to disable both webhook and files uploads&#39;</span><span class="p">,</span>
                <span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_STATE</span><span class="p">,</span> <span class="mi">400</span>
            <span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, CodeGrade

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>