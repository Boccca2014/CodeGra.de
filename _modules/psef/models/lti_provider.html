

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>psef.models.lti_provider &mdash; CodeGrade Mosaic documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href="../../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                Mosaic
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/use-codegrade-as-a-student.html">How to use CodeGrade as a student</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/getting-started-with-codegrade.html">Getting started with CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/autotest-best-practices.html">Best Practices for AutoTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/creating-an-assignment.html">Create a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/set-up-a-rubric-for-an-assignment.html">Set up a rubric for an assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/setting-up-autotest.html">Setting up AutoTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/enabling-continuous-feedback-for-an-assignment.html">Enabling Continuous Feedback for an assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/set-up-group-assignment.html">Set up a CodeGrade group assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/setting-up-hand-in-requirements.html">Set up hand-in requirements for a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/setting-up-git-uploads.html">Set up Git uploads for a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/checking-for-plagiarism.html">Check for plagiarism in a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/dividing-submissions.html">Divide submissions over graders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/pass-back-grades-to-canvas-blackboard-moodle-brightspace.html">Pass back grades to Canvas, Blackboard, Moodle or Brightspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/creating-managing-and-using-snippets.html">Create, manage and use snippets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/setup-password-for-codegrade-account.html">Set up a password for my CodeGrade account</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/using-shortcuts.html">Using shortcuts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/cannot-find-feature-in-codegrade.html">I cannot find a feature in CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/installing-codegrade-filesystem.html">Install the CodeGrade Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/use-codegrade-filesystem.html">Use the CodeGrade Filesystem to locally mount CodeGrade</a></li>
</ul>
<p class="caption"><span class="caption-text">User Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user/overview.html">Overview of CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/codeviewer.html">Code Viewer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/management.html">Course and Assignment Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/plagiarism.html">Plagiarism Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/groups.html">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/permissions.html">Permissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/preferences.html">Settings and Site Preferences</a></li>
<li class="toctree-l1"><a class="reference external" href="https://fs-docs.codegra.de">Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/lms.html">LMS Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/autotest/overview.html">AutoTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/analytics-dashboard.html">Analytics Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/exam-mode.html">Exam mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/notifications.html">Notifications</a></li>
</ul>
<p class="caption"><span class="caption-text">About CodeGrade</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../about/about.html">About CodeGrade</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../developerdocs.html">Developer documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CodeGrade</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../psef.html">psef</a> &raquo;</li>
        
      <li>psef.models.lti_provider</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for psef.models.lti_provider</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This module defines all LTI models and connections between LTI providers and</span>
<span class="sd">    courses.</span>

<span class="sd">SPDX-License-Identifier: AGPL-3.0-only</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">t</span>

<span class="kn">import</span> <span class="nn">furl</span>
<span class="kn">import</span> <span class="nn">structlog</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">import</span> <span class="nn">jwcrypto.jwk</span>
<span class="kn">import</span> <span class="nn">pylti1p3.grade</span>
<span class="kn">import</span> <span class="nn">pylti1p3.exception</span>
<span class="kn">import</span> <span class="nn">pylti1p3.names_roles</span>
<span class="kn">import</span> <span class="nn">pylti1p3.service_connector</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.types</span> <span class="kn">import</span> <span class="n">JSON</span>
<span class="kn">from</span> <span class="nn">sqlalchemy_utils</span> <span class="kn">import</span> <span class="n">UUIDType</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Final</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.backends</span> <span class="kn">import</span> <span class="n">default_backend</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">serialization</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.asymmetric</span> <span class="kn">import</span> <span class="n">rsa</span>

<span class="kn">import</span> <span class="nn">psef</span>
<span class="kn">from</span> <span class="nn">cg_helpers</span> <span class="kn">import</span> <span class="n">handle_none</span>
<span class="kn">from</span> <span class="nn">cg_dt_utils</span> <span class="kn">import</span> <span class="n">DatetimeWithTimezone</span>
<span class="kn">from</span> <span class="nn">cg_sqlalchemy_helpers</span> <span class="kn">import</span> <span class="n">hybrid_property</span>
<span class="kn">from</span> <span class="nn">cg_sqlalchemy_helpers.types</span> <span class="kn">import</span> <span class="n">DbColumn</span><span class="p">,</span> <span class="n">ColumnProxy</span>
<span class="kn">from</span> <span class="nn">cg_sqlalchemy_helpers.mixins</span> <span class="kn">import</span> <span class="n">UUIDMixin</span><span class="p">,</span> <span class="n">TimestampMixin</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">UUID_LENGTH</span><span class="p">,</span> <span class="n">Base</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">user</span> <span class="k">as</span> <span class="n">user_models</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">work</span> <span class="k">as</span> <span class="n">work_models</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">course</span> <span class="k">as</span> <span class="n">course_models</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">assignment</span> <span class="k">as</span> <span class="n">assignment_models</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">auth</span><span class="p">,</span> <span class="n">signals</span><span class="p">,</span> <span class="n">current_app</span>
<span class="kn">from</span> <span class="nn">..lti</span> <span class="kn">import</span> <span class="n">v1_3</span> <span class="k">as</span> <span class="n">lti_v1_3</span>
<span class="kn">from</span> <span class="nn">..lti.v1_3</span> <span class="kn">import</span> <span class="n">claims</span> <span class="k">as</span> <span class="n">ltiv1_3_claims</span>
<span class="kn">from</span> <span class="nn">..registry</span> <span class="kn">import</span> <span class="n">lti_provider_handlers</span><span class="p">,</span> <span class="n">lti_1_3_lms_capabilities</span>
<span class="kn">from</span> <span class="nn">..lti.v1_3.lms_capabilities</span> <span class="kn">import</span> <span class="n">LMSCapabilities</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>

<span class="c1"># This task acks late and retries on exceptions. For the exact meaning of these</span>
<span class="c1"># variables see the celery documentation. But basically ``acks_late`` means</span>
<span class="c1"># that a task will only be removed from the queue AFTER it has finished</span>
<span class="c1"># processing, if the worker dies during processing it will simply restart. The</span>
<span class="c1"># ``max_retry`` parameter means that if the worker throws an exception during</span>
<span class="c1"># processing the task will also be retried, with a maximum of 10. The</span>
<span class="c1"># ``reject_on_worker_lost`` means that if a worker suddenly dies while</span>
<span class="c1"># processing the task (if the machine fails, or if the main process is killed</span>
<span class="c1"># with the ``KILL`` signal) the task will also be retried.</span>
<span class="n">_PASSBACK_CELERY_OPTS</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;acks_late&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;max_retries&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s1">&#39;reject_on_worker_lost&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;autoretry_for&#39;</span><span class="p">:</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="p">),</span>
<span class="p">}</span>

<span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="c1"># pylint: disable=unused-import, invalid-name</span>
    <span class="kn">from</span> <span class="nn">pylti1p3.names_roles</span> <span class="kn">import</span> <span class="n">_Member</span><span class="p">,</span> <span class="n">_NamesAndRolesData</span>

    <span class="kn">from</span> <span class="nn">.work</span> <span class="kn">import</span> <span class="n">Work</span>

<span class="n">_ALL_LTI_PROVIDERS</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="s1">&#39;lti1.1&#39;</span><span class="p">,</span> <span class="s1">&#39;lti1.3&#39;</span><span class="p">])</span>
<span class="n">lti_provider_handlers</span><span class="o">.</span><span class="n">set_possible_options</span><span class="p">(</span><span class="n">_ALL_LTI_PROVIDERS</span><span class="p">)</span>

<span class="n">T_LTI_PROV</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T_LTI_PROV&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s1">&#39;LTIProviderBase&#39;</span><span class="p">)</span>  <span class="c1"># pylint: disable=invalid-name</span>


<div class="viewcode-block" id="LTIProviderBase"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTIProviderBase">[docs]</a><span class="k">class</span> <span class="nc">LTIProviderBase</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">TimestampMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class defines a connection between CodeGrade and an LMS.</span>

<span class="sd">    This class not implement the logic for the handling for the LTI messages,</span>
<span class="sd">    but instead provides a place were to store data about the LMS and the</span>
<span class="sd">    handshake with CodeGrade.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;LTIProvider&#39;</span>
    <span class="n">_SIGNALS_SETUP</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">UUID_LENGTH</span><span class="p">),</span>
        <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># This is only really available for LTI1.3, however we need to define it</span>
    <span class="c1"># here to be able to create a unique constraint.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
        <span class="n">client_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;client_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>

    <span class="c1"># The foreign key needs to be defined here for sqlalchemy, but the relation</span>
    <span class="c1"># is defined in the ``LTI1p3Provider`` model.</span>
    <span class="n">_updates_lti1p1_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;updates_lti1p1_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">UUID_LENGTH</span><span class="p">),</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="nb">id</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">_lti_provider_version</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;lti_provider_version&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="o">*</span><span class="n">_ALL_LTI_PROVIDERS</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ltiproviderversion&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">server_default</span><span class="o">=</span><span class="s1">&#39;lti1.1&#39;</span>
    <span class="p">)</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;polymorphic_on&#39;</span><span class="p">:</span> <span class="n">_lti_provider_version</span><span class="p">,</span>
        <span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="s1">&#39;non_existing&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;client_id&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="p">)</span>

<div class="viewcode-block" id="LTIProviderBase.find_user"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTIProviderBase.find_user">[docs]</a>    <span class="k">def</span> <span class="nf">find_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lti_user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;user_models.User&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Find the user with the given ``lti_user_id`` in this provider.</span>

<span class="sd">        .. note::</span>

<span class="sd">            A ``lti_user_id`` is not globally unique!</span>

<span class="sd">        :param lti_user_id: The id to search for.</span>
<span class="sd">        :returns: A user that has the given lti user id for the connected LMS,</span>
<span class="sd">            ``None`` if no user could be found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_link</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">UserLTIProvider</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">UserLTIProvider</span><span class="o">.</span><span class="n">lti_user_id</span> <span class="o">==</span> <span class="n">lti_user_id</span><span class="p">,</span>
            <span class="n">UserLTIProvider</span><span class="o">.</span><span class="n">lti_provider_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user_link</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">user_link</span><span class="o">.</span><span class="n">user</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">member_sourcedid_required</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Is it required to have an entry in the</span>
<span class="sd">        :class:`.assignment_models.AssignmentResult` table for a user before a</span>
<span class="sd">        submission can be made?</span>

<span class="sd">        This should be ``True`` if this data is required for a grade passback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_signal_assignment_pre_check</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">assig</span><span class="p">:</span> <span class="s1">&#39;assignment_models.Assignment&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">assig</span><span class="o">.</span><span class="n">is_lti</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">assig</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">lti_provider</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_self_from_assignment_id</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">T_LTI_PROV</span><span class="p">],</span>
        <span class="n">assignment_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">lock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="s1">&#39;assignment_models.Assignment&#39;</span><span class="p">,</span> <span class="n">t</span>
                                              <span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">T_LTI_PROV</span><span class="p">]]]:</span>
        <span class="k">if</span> <span class="n">assignment_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">assignment_models</span><span class="o">.</span><span class="n">Assignment</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">assignment_models</span><span class="o">.</span><span class="n">Assignment</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">assignment_id</span><span class="p">,</span>
            <span class="n">assignment_models</span><span class="o">.</span><span class="n">Assignment</span><span class="o">.</span><span class="n">is_visible</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">with_for_update</span><span class="p">(</span>
                <span class="n">read</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">of</span><span class="o">=</span><span class="n">assignment_models</span><span class="o">.</span><span class="n">Assignment</span>
            <span class="p">)</span>

        <span class="n">assig</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">assig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Assignment not found&#39;</span><span class="p">,</span> <span class="n">assignment_id</span><span class="o">=</span><span class="n">assignment_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">assig</span><span class="o">.</span><span class="n">is_lti</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Assignment isn&#39;t a LTI assignment&quot;</span><span class="p">,</span> <span class="n">assignment</span><span class="o">=</span><span class="n">assig</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">assig</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_self_from_course</span><span class="p">(</span><span class="n">assig</span><span class="o">.</span><span class="n">course</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@t</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="nf">_get_self_from_course</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">course</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@t</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="nf">_get_self_from_course</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">T_LTI_PROV</span><span class="p">],</span>
        <span class="n">course</span><span class="p">:</span> <span class="s1">&#39;course_models.Course&#39;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">T_LTI_PROV</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_self_from_course</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">T_LTI_PROV</span><span class="p">],</span>
        <span class="n">course</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;course_models.Course&#39;</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">T_LTI_PROV</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">course</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Course not found&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">course</span><span class="o">.</span><span class="n">lti_provider</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Course is not an LTI course&#39;</span><span class="p">,</span> <span class="n">course</span><span class="o">=</span><span class="n">course</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">possible_self</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">lti_provider</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">possible_self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Course does not belong to this LTI Provider&#39;</span><span class="p">,</span>
                <span class="n">course</span><span class="o">=</span><span class="n">course</span><span class="p">,</span>
                <span class="n">lti_provider_cls</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">possible_self</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">lms_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The name of the LMS for this LTIProvider.</span>

<span class="sd">        :getter: Get the LMS name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<div class="viewcode-block" id="LTIProviderBase.supports_setting_state"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTIProviderBase.supports_setting_state">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">supports_setting_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;May users change the available at of the assignment within CodeGrade.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="LTIProviderBase.supports_setting_deadline"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTIProviderBase.supports_setting_deadline">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">supports_setting_deadline</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;May users change the deadline of the assignment within CodeGrade.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            attribute :meth:`psef.lti.v1_3.lms_capabilities.LMSCapabilities.set_deadline`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="LTIProviderBase.supports_max_points"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTIProviderBase.supports_max_points">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">supports_max_points</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;May users set the ``Assignment._max_grade`` property?</span>

<span class="sd">        This effectively means if the LMS supports bonus points (i.e. a higher</span>
<span class="sd">        amount of points than the grade scale).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="k">def</span> <span class="nf">__structlog__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_update_history_sub</span><span class="p">(</span><span class="n">sub</span><span class="p">:</span> <span class="s1">&#39;work_models.Work&#39;</span>
                            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;work_models.GradeHistory&#39;</span><span class="p">]:</span>
        <span class="n">newest_grade_history</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">GradeHistory</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">work</span><span class="o">=</span><span class="n">sub</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
                <span class="n">DbColumn</span><span class="p">[</span><span class="n">DatetimeWithTimezone</span><span class="p">],</span>
                <span class="n">work_models</span><span class="o">.</span><span class="n">GradeHistory</span><span class="o">.</span><span class="n">changed_at</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">(),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">with_for_update</span><span class="p">()</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">newest_grade_history</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not find grade history item&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newest_grade_history</span><span class="o">.</span><span class="n">passed_back</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">newest_grade_history</span>

    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
            <span class="s1">&#39;lms&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lms_name</span><span class="p">,</span>
            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lti_provider_version</span><span class="p">,</span>
            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="LTI1p1Provider"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p1Provider">[docs]</a><span class="nd">@lti_provider_handlers</span><span class="o">.</span><span class="n">register_table</span>
<span class="k">class</span> <span class="nc">LTI1p1Provider</span><span class="p">(</span><span class="n">LTIProviderBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class represents a connection between an LMS and CodeGrade using</span>
<span class="sd">        the LTI 1.1 protocol.</span>

<span class="sd">    .. seealso: module :mod:`psef.lti.v1_1` for the implementation of the LTI</span>
<span class="sd">        1.1 launches.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="s1">&#39;lti1.1&#39;</span><span class="p">}</span>

    <span class="n">upgraded_to_lti1p3</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">LTI1p3Provider</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;_updates_lti1p1&#39;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all,delete&#39;</span><span class="p">,</span>
        <span class="n">uselist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;select&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>

<div class="viewcode-block" id="LTI1p1Provider.find_course"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p1Provider.find_course">[docs]</a>    <span class="k">def</span> <span class="nf">find_course</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">lti_course_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;CourseLTIProvider&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Find a course with the given ``lti_course_id`` in this LTI</span>
<span class="sd">        connection.</span>

<span class="sd">        :param lti_course_id: The course that was present in the LTI launch.</span>

<span class="sd">        :returns: The connection object between the course and this LTI</span>
<span class="sd">                  provider if the course was found. If it was not found</span>
<span class="sd">                  ``None`` is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">CourseLTIProvider</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">CourseLTIProvider</span><span class="o">.</span><span class="n">lti_course_id</span> <span class="o">==</span> <span class="n">lti_course_id</span><span class="p">,</span>
            <span class="n">CourseLTIProvider</span><span class="o">.</span><span class="n">lti_provider</span> <span class="o">==</span> <span class="bp">self</span><span class="p">,</span>
            <span class="o">~</span><span class="n">CourseLTIProvider</span><span class="o">.</span><span class="n">old_connection</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">member_sourcedid_required</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;We do need sourcedids to passback grades in the LTI 1.1 protocol.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lms_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The name of the lms connected to this provider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lms_and_secrets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># The next methods all are handlers for signals we setup in `setup_signals`</span>
    <span class="c1"># at the end of the class</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_create_submission_in_lms</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">work_assignment_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">work_id</span><span class="p">,</span> <span class="n">assignment_id</span> <span class="o">=</span> <span class="n">work_assignment_id</span>

        <span class="n">_</span><span class="p">,</span> <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_self_from_assignment_id</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">)</span>
        <span class="n">submission</span> <span class="o">=</span> <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">work_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">submission</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Creating submission in lms&#39;</span><span class="p">,</span>
                <span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">,</span>
                <span class="n">lti_provider</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># pylint: disable=protected-access</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_passback_grade</span><span class="p">(</span><span class="n">submission</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_passback_grades</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">work_assignment_ids</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">submission_ids</span><span class="p">,</span> <span class="n">assignment_id</span> <span class="o">=</span> <span class="n">work_assignment_ids</span>

        <span class="n">assig</span><span class="p">,</span> <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_self_from_assignment_id</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">assig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">assig</span><span class="o">.</span><span class="n">should_passback</span> <span class="ow">or</span>
            <span class="ow">not</span> <span class="n">submission_ids</span>
        <span class="p">):</span>
            <span class="k">return</span>

        <span class="n">subs</span> <span class="o">=</span> <span class="n">assig</span><span class="o">.</span><span class="n">get_all_latest_submissions</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">submission_ids</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Passback grades&#39;</span><span class="p">,</span>
            <span class="n">gotten_submission</span><span class="o">=</span><span class="n">subs</span><span class="p">,</span>
            <span class="n">wanted_submission</span><span class="o">=</span><span class="n">submission_ids</span><span class="p">,</span>
            <span class="n">difference</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subs</span><span class="p">)</span> <span class="o">^</span> <span class="nb">set</span><span class="p">(</span><span class="n">submission_ids</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># pylint: disable=protected-access</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_passback_grade</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_history_sub</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_delete_submission</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">work_assignment_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">work_id</span><span class="p">,</span> <span class="n">assignment_id</span> <span class="o">=</span> <span class="n">work_assignment_id</span>

        <span class="n">assignment</span><span class="p">,</span> <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_self_from_assignment_id</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">assignment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># TODO: This has a bug: if a user has a group submission, that is</span>
        <span class="c1"># already deleted, and now his/her latest personal submission is</span>
        <span class="c1"># deleted, this personal submission is not found, as we think the</span>
        <span class="c1"># deleted group submission (which we ignore) is the latest submission.</span>

        <span class="c1"># TODO: Another possible bug is that if a user has two submissions, and</span>
        <span class="c1"># the latest is already deleted, and now we delete the new latest this</span>
        <span class="c1"># is also not registered as the latest submission.  In other words:</span>
        <span class="c1"># this code works for common cases, but is hopelessly broken for all</span>
        <span class="c1"># other cases :(</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">get_all_latest_submissions</span><span class="p">(</span>
            <span class="n">include_deleted</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">work_id</span><span class="p">)</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not find submission&#39;</span><span class="p">,</span> <span class="n">work_id</span><span class="o">=</span><span class="n">work_id</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting grade for submission&#39;</span><span class="p">,</span> <span class="n">work_id</span><span class="o">=</span><span class="n">sub</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="c1"># pylint: disable=protected-access</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_passback_grade</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># End of all signal handlers.</span>

    <span class="k">def</span> <span class="nf">_passback_grade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub</span><span class="p">:</span> <span class="s1">&#39;Work&#39;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">initial</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Passback the grade for a given submission to this lti provider.</span>

<span class="sd">        :param sub: The submission to passback.</span>
<span class="sd">        :param initial: If true no grade will be send, this is to make sure the</span>
<span class="sd">            ``created_at`` date is correct in the LMS. Not all providers</span>
<span class="sd">            actually do a passback when this is set to ``True``.</span>
<span class="sd">        :returns: Nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">service_url</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">lti_grade_service_data</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">service_url</span><span class="p">,</span> <span class="nb">str</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;Service url has unexpected value: </span><span class="si">{</span><span class="n">service_url</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="n">assig_results</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">assignment_results</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">get_all_authors</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_test_student</span> <span class="ow">or</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">assig_results</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="c1"># We actually cover this line, but python optimizes it out:</span>
                <span class="c1"># https://github.com/nedbat/coveragepy/issues/198</span>
                <span class="k">continue</span>
            <span class="n">sourcedid</span> <span class="o">=</span> <span class="n">assig_results</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">sourcedid</span>
            <span class="k">if</span> <span class="n">sourcedid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">continue</span>

            <span class="c1"># Work around for https://github.com/python/mypy/issues/2608</span>
            <span class="n">_sourcedid</span> <span class="o">=</span> <span class="n">sourcedid</span>
            <span class="n">_service_url</span> <span class="o">=</span> <span class="n">service_url</span>

            <span class="c1"># We bind these values as kwargs so pylint doesn&#39;t complain about</span>
            <span class="c1"># using names bound in a loop in a closure (as python ) will reuse</span>
            <span class="c1"># the same name for every iteration, so:</span>
            <span class="c1">#</span>
            <span class="c1"># ```</span>
            <span class="c1"># cbs = []</span>
            <span class="c1"># for i in range(9): cbs.append(lambda: print(i))</span>
            <span class="c1"># [cb() for cb in cbs()]</span>
            <span class="c1"># ```</span>
            <span class="c1">#</span>
            <span class="c1"># Will print &#39;9&#39; nine times.</span>
            <span class="k">def</span> <span class="nf">try_passback</span><span class="p">(</span>
                <span class="n">secret</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="o">*</span><span class="p">,</span>
                <span class="n">_sid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_sourcedid</span><span class="p">,</span>
                <span class="n">_surl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_service_url</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lti_class</span><span class="o">.</span><span class="n">passback_grade</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
                    <span class="n">secret</span><span class="o">=</span><span class="n">secret</span><span class="p">,</span>
                    <span class="n">grade</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">deleted</span> <span class="k">else</span> <span class="n">sub</span><span class="o">.</span><span class="n">grade</span><span class="p">,</span>
                    <span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">,</span>
                    <span class="n">service_url</span><span class="o">=</span><span class="n">_surl</span><span class="p">,</span>
                    <span class="n">sourcedid</span><span class="o">=</span><span class="n">_sid</span><span class="p">,</span>
                    <span class="n">lti_points_possible</span><span class="o">=</span><span class="n">sub</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">lti_points_possible</span><span class="p">,</span>
                    <span class="n">submission</span><span class="o">=</span><span class="n">sub</span><span class="p">,</span>
                    <span class="n">host</span><span class="o">=</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;EXTERNAL_URL&#39;</span><span class="p">],</span>
                <span class="p">)</span>

            <span class="c1"># The newest secret should be placed last in this list</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">try_for_every</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secrets</span><span class="p">),</span> <span class="n">try_passback</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_lms_and_secrets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Return the OAuth consumer secret and the name of the LMS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;LTI_CONSUMER_KEY_SECRETS&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">secrets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The OAuth consumer secret for this LTIProvider.</span>

<span class="sd">        :getter: Get the OAuth secret.</span>
<span class="sd">        :setter: Impossible as all secrets are fixed during startup of</span>
<span class="sd">            codegra.de</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lms_and_secrets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lti_class</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="s1">&#39;psef.lti.v1_1.LTI&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The name of the LTI class to be used for this LTIProvider.</span>

<span class="sd">        :getter: Get the LTI class name.</span>
<span class="sd">        :setter: Impossible as this is fixed during startup of CodeGrade.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lms_name</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">psef</span><span class="o">.</span><span class="n">lti</span><span class="o">.</span><span class="n">v1_1</span><span class="o">.</span><span class="n">lti_classes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lms</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">psef</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">APIException</span><span class="p">(</span>
                <span class="s1">&#39;The requested LMS is not supported&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;The LMS &quot;</span><span class="si">{</span><span class="n">lms</span><span class="si">}</span><span class="s1">&quot; is not supported&#39;</span><span class="p">,</span>
                <span class="n">psef</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_PARAM</span><span class="p">,</span> <span class="mi">400</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span>

<div class="viewcode-block" id="LTI1p1Provider.supports_setting_deadline"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p1Provider.supports_setting_deadline">[docs]</a>    <span class="k">def</span> <span class="nf">supports_setting_deadline</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Only some LMSes pass the deadline in LTI launches.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_class</span><span class="o">.</span><span class="n">supports_deadline</span><span class="p">()</span></div>

<div class="viewcode-block" id="LTI1p1Provider.supports_setting_state"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p1Provider.supports_setting_state">[docs]</a>    <span class="k">def</span> <span class="nf">supports_setting_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;We cannot set the state of the assignment when the LMS</span>
<span class="sd">            manages the state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_class</span><span class="o">.</span><span class="n">supports_state_management</span><span class="p">()</span></div>

<div class="viewcode-block" id="LTI1p1Provider.supports_max_points"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p1Provider.supports_max_points">[docs]</a>    <span class="k">def</span> <span class="nf">supports_max_points</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Only some LMSes support bonus points using the LTI 1.1 standard.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_class</span><span class="o">.</span><span class="n">supports_max_points</span><span class="p">()</span></div>

<div class="viewcode-block" id="LTI1p1Provider.setup_signals"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p1Provider.setup_signals">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setup_signals</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Setup the signals used by the LTI 1.1 providers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_SIGNALS_SETUP</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">return</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_SIGNALS_SETUP</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">pre_checker</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_signal_assignment_pre_check</span>

        <span class="n">signals</span><span class="o">.</span><span class="n">WORK_DELETED</span><span class="o">.</span><span class="n">connect_celery</span><span class="p">(</span>
            <span class="n">pre_check</span><span class="o">=</span><span class="k">lambda</span> <span class="n">wd</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">wd</span><span class="o">.</span><span class="n">was_latest</span> <span class="ow">and</span> <span class="n">wd</span><span class="o">.</span><span class="n">new_latest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="n">pre_checker</span><span class="p">(</span><span class="n">wd</span><span class="o">.</span><span class="n">assignment</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">converter</span><span class="o">=</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">wd</span><span class="p">:</span> <span class="p">(</span>
                    <span class="c1"># This stupid check is needed for mypy</span>
                    <span class="p">[</span><span class="n">wd</span><span class="o">.</span><span class="n">new_latest</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="k">if</span> <span class="n">wd</span><span class="o">.</span><span class="n">new_latest</span> <span class="k">else</span> <span class="p">[],</span>
                    <span class="n">wd</span><span class="o">.</span><span class="n">assignment_id</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">task_args</span><span class="o">=</span><span class="n">_PASSBACK_CELERY_OPTS</span><span class="p">,</span>
        <span class="p">)(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_passback_grades</span><span class="p">)</span>

        <span class="n">signals</span><span class="o">.</span><span class="n">WORK_DELETED</span><span class="o">.</span><span class="n">connect_celery</span><span class="p">(</span>
            <span class="n">converter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">wd</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">wd</span><span class="o">.</span><span class="n">deleted_work</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">wd</span><span class="o">.</span><span class="n">deleted_work</span><span class="o">.</span><span class="n">assignment_id</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">pre_check</span><span class="o">=</span><span class="k">lambda</span> <span class="n">wd</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">wd</span><span class="o">.</span><span class="n">was_latest</span> <span class="ow">and</span> <span class="n">wd</span><span class="o">.</span><span class="n">new_latest</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="n">pre_checker</span><span class="p">(</span><span class="n">wd</span><span class="o">.</span><span class="n">assignment</span><span class="p">)</span>
            <span class="p">),</span>
        <span class="p">)(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_delete_submission</span><span class="p">)</span>

        <span class="n">signals</span><span class="o">.</span><span class="n">GRADE_UPDATED</span><span class="o">.</span><span class="n">connect_celery</span><span class="p">(</span>
            <span class="n">pre_check</span><span class="o">=</span><span class="k">lambda</span> <span class="n">work</span><span class="p">:</span> <span class="n">pre_checker</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">assignment</span><span class="p">),</span>
            <span class="n">converter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">work</span><span class="p">:</span> <span class="p">(</span>
                <span class="p">[</span><span class="n">work</span><span class="o">.</span><span class="n">id</span><span class="p">],</span>
                <span class="n">work</span><span class="o">.</span><span class="n">assignment_id</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">task_args</span><span class="o">=</span><span class="n">_PASSBACK_CELERY_OPTS</span><span class="p">,</span>
        <span class="p">)(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_passback_grades</span><span class="p">)</span>

        <span class="n">signals</span><span class="o">.</span><span class="n">ASSIGNMENT_STATE_CHANGED</span><span class="o">.</span><span class="n">connect_celery</span><span class="p">(</span>
            <span class="n">pre_check</span><span class="o">=</span><span class="n">pre_checker</span><span class="p">,</span>
            <span class="n">converter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="p">(</span>
                <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">get_all_latest_submissions</span><span class="p">()],</span>
                <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">task_args</span><span class="o">=</span><span class="n">_PASSBACK_CELERY_OPTS</span><span class="p">,</span>
        <span class="p">)(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_passback_grades</span><span class="p">)</span>

        <span class="n">signals</span><span class="o">.</span><span class="n">WORK_CREATED</span><span class="o">.</span><span class="n">connect_celery</span><span class="p">(</span>
            <span class="n">pre_check</span><span class="o">=</span><span class="k">lambda</span> <span class="n">work</span><span class="p">:</span> <span class="n">pre_checker</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">assignment</span><span class="p">),</span>
            <span class="n">converter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">work</span><span class="p">:</span> <span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">assignment_id</span><span class="p">),</span>
            <span class="n">task_args</span><span class="o">=</span><span class="n">_PASSBACK_CELERY_OPTS</span><span class="p">,</span>
        <span class="p">)(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_create_submission_in_lms</span><span class="p">)</span></div></div>


<span class="n">LTI1p1Provider</span><span class="o">.</span><span class="n">setup_signals</span><span class="p">()</span>


<div class="viewcode-block" id="LTI1p3Provider"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p3Provider">[docs]</a><span class="nd">@lti_provider_handlers</span><span class="o">.</span><span class="n">register_table</span>
<span class="k">class</span> <span class="nc">LTI1p3Provider</span><span class="p">(</span><span class="n">LTIProviderBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class represents a connection between an LMS and CodeGrade using</span>
<span class="sd">        the LTI 1.3 protocol.</span>

<span class="sd">    .. seealso: module :mod:`psef.lti.v1_3` for the implementation of the LTI</span>
<span class="sd">        1.3 launches.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="s1">&#39;lti1.3&#39;</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">client_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;client_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lms_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LMSCapabilities</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The capabilities of the lms connect to this provider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">lti_1_3_lms_capabilities</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lms_name</span><span class="p">]</span>

<div class="viewcode-block" id="LTI1p3Provider.get_launch_url"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p3Provider.get_launch_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_launch_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goto_latest_sub</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">furl</span><span class="o">.</span><span class="n">furl</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the launch url for this provider.</span>

<span class="sd">        :param goto_latest_sub: Get the url that navigates a user to the latest</span>
<span class="sd">            submission.</span>
<span class="sd">        :returns: The launch url for this provider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">furl</span><span class="o">.</span><span class="n">furl</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;EXTERNAL_URL&#39;</span><span class="p">])</span>

        <span class="n">to_add</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="s1">&#39;v1&#39;</span><span class="p">,</span> <span class="s1">&#39;lti1.3&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">goto_latest_sub</span><span class="p">:</span>
            <span class="n">to_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;launch_to_latest_submission&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">to_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;launch&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lms_capabilities</span><span class="o">.</span><span class="n">use_id_in_urls</span><span class="p">:</span>
            <span class="n">to_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">base_url</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">to_add</span><span class="p">)</span></div>

    <span class="n">_lms_name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;lms_name&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="o">*</span><span class="n">lti_1_3_lms_capabilities</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lti1p3lmsnames&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">_auth_login_url</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;auth_login_url&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">_auth_token_url</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;auth_token_url&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">_auth_audience</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;auth_audience&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">_key_set_url</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;key_set_url&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>

    <span class="n">_crypto_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;crypto_key&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">LargeBinary</span><span class="p">)</span>

    <span class="n">_finalized</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;finalized&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">server_default</span><span class="o">=</span><span class="s1">&#39;true&#39;</span>
    <span class="p">)</span>

    <span class="n">_intended_use</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;intended_use&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">server_default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">_edit_secret</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;edit_secret&#39;</span><span class="p">,</span>
        <span class="n">UUIDType</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">,</span>
        <span class="n">server_default</span><span class="o">=</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">uuid_generate_v4</span><span class="p">(),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">_updates_lti1p1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="n">LTI1p1Provider</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">LTIProviderBase</span><span class="o">.</span><span class="n">_updates_lti1p1_id</span><span class="p">,</span>
        <span class="n">remote_side</span><span class="o">=</span><span class="p">[</span><span class="n">LTIProviderBase</span><span class="o">.</span><span class="n">id</span><span class="p">],</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;upgraded_to_lti1p3&#39;</span><span class="p">,</span>
        <span class="n">uselist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">updates_lti1p1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">LTI1p1Provider</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The LTI 1.1 provider this provider updates.</span>

<span class="sd">        This allows us to reuse users from that provider, so we will not create</span>
<span class="sd">        duplicate users.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updates_lti1p1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">edit_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The secret which you can use to edit this provider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edit_secret</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">member_sourcedid_required</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Passback works using user ids, so no sourcedids required.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lms_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The name of the lms of this provider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lms_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lms_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Is this provider finalized and ready for use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalized</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">key_set_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The location where you can find the public key of the LMS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_set_url</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">auth_audience</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The OAuth2 Audience for this provider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">handle_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_auth_audience</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_token_url</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">auth_token_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The url where you can get an access token.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_token_url</span>

<div class="viewcode-block" id="LTI1p3Provider.update_registration"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p3Provider.update_registration">[docs]</a>    <span class="k">def</span> <span class="nf">update_registration</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">iss</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">auth_login_url</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">auth_token_url</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">client_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">key_set_url</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">auth_audience</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">finalize</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update this lti provider.</span>

<span class="sd">        :param auth_login_url: The new auth login url, pass ``None`` to keep</span>
<span class="sd">            the old one.</span>
<span class="sd">        :param auth_token_url: The new auth token url, pass ``None`` to keep</span>
<span class="sd">            the old one.</span>
<span class="sd">        :param client_id: The new client id, pass ``None`` to keep the old one.</span>
<span class="sd">        :param key_set_url: The new key set url, pass ``None`` to keep the old</span>
<span class="sd">            one.</span>
<span class="sd">        :param auth_audience: The new OAuth2 Audience this is not required for</span>
<span class="sd">            all LMSes. Pass ``None`` to keep the old value.</span>
<span class="sd">        :param finalize: Pass ``True`` to seal this provider, and make it ready</span>
<span class="sd">            for use.</span>

<span class="sd">        :returns: Nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalized</span>

        <span class="k">if</span> <span class="n">iss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">iss</span>
        <span class="k">if</span> <span class="n">client_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="n">client_id</span>
        <span class="k">if</span> <span class="n">auth_login_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auth_login_url</span> <span class="o">=</span> <span class="n">auth_login_url</span>
        <span class="k">if</span> <span class="n">auth_token_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auth_token_url</span> <span class="o">=</span> <span class="n">auth_token_url</span>
        <span class="k">if</span> <span class="n">key_set_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_key_set_url</span> <span class="o">=</span> <span class="n">key_set_url</span>
        <span class="k">if</span> <span class="n">auth_audience</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auth_audience</span> <span class="o">=</span> <span class="n">auth_audience</span>

        <span class="k">if</span> <span class="n">finalize</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">all_opts</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_login_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_token_url</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_key_set_url</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lms_capabilities</span><span class="o">.</span><span class="n">auth_audience_required</span><span class="p">:</span>
                <span class="n">all_opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_auth_audience</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">opt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">all_opts</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">psef</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">APIException</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s1">&#39;Cannot finalize registration as not all required&#39;</span>
                        <span class="s1">&#39; options are set&#39;</span>
                    <span class="p">),</span> <span class="s1">&#39;Some of the required options are not yet set&#39;</span><span class="p">,</span>
                    <span class="n">psef</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_STATE</span><span class="p">,</span> <span class="mi">400</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_finalized</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="LTI1p3Provider.create_and_generate_keys"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p3Provider.create_and_generate_keys">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_and_generate_keys</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">iss</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">lms_capabilities</span><span class="p">:</span> <span class="n">LMSCapabilities</span><span class="p">,</span>
        <span class="n">intended_use</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;LTI1p3Provider&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a new LTI1p3 provider with the given ``iss``.</span>

<span class="sd">        :param iss: The iss of the new provider.</span>
<span class="sd">        :param lms_capabilities: The capabilities of the new provider.</span>
<span class="sd">        :param intended_use: A string describing who will be using this</span>
<span class="sd">            provider, this is only for human consumption.</span>
<span class="sd">        :returns: The non finalized created provider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">generate_private_key</span><span class="p">(</span>
            <span class="n">public_exponent</span><span class="o">=</span><span class="mi">65537</span><span class="p">,</span>
            <span class="n">key_size</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span>
            <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">lms_name</span> <span class="o">=</span> <span class="n">lms_capabilities</span><span class="o">.</span><span class="n">lms</span>
        <span class="k">assert</span> <span class="n">lms_name</span> <span class="ow">in</span> <span class="n">lti_1_3_lms_capabilities</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="n">iss</span><span class="p">,</span>
            <span class="n">_finalized</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">_lms_name</span><span class="o">=</span><span class="n">lms_name</span><span class="p">,</span>
            <span class="n">_intended_use</span><span class="o">=</span><span class="n">intended_use</span><span class="p">,</span>
            <span class="n">_crypto_key</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">private_bytes</span><span class="p">(</span>
                <span class="n">encoding</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">PEM</span><span class="p">,</span>
                <span class="nb">format</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">PrivateFormat</span><span class="o">.</span><span class="n">PKCS8</span><span class="p">,</span>
                <span class="n">encryption_algorithm</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">NoEncryption</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LTI1p3Provider.find_course"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p3Provider.find_course">[docs]</a>    <span class="k">def</span> <span class="nf">find_course</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">lti_course_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">old_lti_course_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;CourseLTIProvider&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Find a course in this LTI connection.</span>

<span class="sd">        This method will also upgrade an existing LTI 1.1 course to a LTI 1.3</span>
<span class="sd">        course if possible. In this case the database will be mutated.</span>

<span class="sd">        :param lti_course_id: The course id that was present in the LTI 1.3</span>
<span class="sd">            launch.</span>
<span class="sd">        :param deployment_id: The deployment id that was present in the LTI 1.3</span>
<span class="sd">            launch.</span>
<span class="sd">        :param old_lti_course_id: The old LTI 1.1 course id that we should use</span>
<span class="sd">            to find old LTI 1.1 courses. This is only used if this provider</span>
<span class="sd">            updates a LTI 1.1 provider.</span>

<span class="sd">        :returns: The connection object between the course and this LTI</span>
<span class="sd">                  provider if a course was found. If it was not found ``None``</span>
<span class="sd">                  is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">CourseLTIProvider</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">CourseLTIProvider</span><span class="o">.</span><span class="n">deployment_id</span> <span class="o">==</span> <span class="n">deployment_id</span><span class="p">,</span>
            <span class="n">CourseLTIProvider</span><span class="o">.</span><span class="n">lti_course_id</span> <span class="o">==</span> <span class="n">lti_course_id</span><span class="p">,</span>
            <span class="n">CourseLTIProvider</span><span class="o">.</span><span class="n">lti_provider</span> <span class="o">==</span> <span class="bp">self</span><span class="p">,</span>
            <span class="o">~</span><span class="n">CourseLTIProvider</span><span class="o">.</span><span class="n">old_connection</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">updates_lti1p1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">old_conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">updates_lti1p1</span><span class="o">.</span><span class="n">find_course</span><span class="p">(</span>
                <span class="n">lti_course_id</span><span class="o">=</span><span class="n">old_lti_course_id</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">old_conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">old_conn</span><span class="o">.</span><span class="n">old_connection</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">CourseLTIProvider</span><span class="o">.</span><span class="n">create_and_add</span><span class="p">(</span>
                    <span class="n">course</span><span class="o">=</span><span class="n">old_conn</span><span class="o">.</span><span class="n">course</span><span class="p">,</span>
                    <span class="n">lti_provider</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">lti_context_id</span><span class="o">=</span><span class="n">lti_course_id</span><span class="p">,</span>
                    <span class="n">deployment_id</span><span class="o">=</span><span class="n">deployment_id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="LTI1p3Provider.find_assignment"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p3Provider.find_assignment">[docs]</a>    <span class="k">def</span> <span class="nf">find_assignment</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">course</span><span class="p">:</span> <span class="s1">&#39;course_models.Course&#39;</span><span class="p">,</span>
        <span class="n">resource_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">old_resource_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;assignment_models.Assignment&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Find an assignment in this LTI connection.</span>

<span class="sd">        This method will also upgrade an existing LTI 1.1 assignment to a LTI</span>
<span class="sd">        1.3 assignment if possible. In this case the database will be mutated.</span>

<span class="sd">        :param course: The course in which we should find the assignment.</span>
<span class="sd">        :param resource_id: The assignment id that was present in the LTI 1.3</span>
<span class="sd">            launch.</span>
<span class="sd">        :param old_resource_id: The old LTI 1.1 assignment id that we should</span>
<span class="sd">            use to find old LTI 1.1 assignments. This is only used if this</span>
<span class="sd">            provider updates a LTI 1.1 provider.</span>

<span class="sd">        :returns: The found assignment or ``None`` if no assignment could be</span>
<span class="sd">                  found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">resource_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="n">lti_assid_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;assignment_models.Assignment&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignments</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">assignment_models</span><span class="o">.</span><span class="n">Assignment</span><span class="o">.</span><span class="n">lti_assignment_id</span> <span class="o">==</span> <span class="n">lti_assid_id</span><span class="p">,</span>
                <span class="n">assignment_models</span><span class="o">.</span><span class="n">Assignment</span><span class="o">.</span><span class="n">lti_assignment_id</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                <span class="n">assignment_models</span><span class="o">.</span><span class="n">Assignment</span><span class="o">.</span><span class="n">is_lti</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">with_for_update</span><span class="p">(</span>
                <span class="n">read</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">of</span><span class="o">=</span><span class="n">assignment_models</span><span class="o">.</span><span class="n">Assignment</span>
            <span class="p">)</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>

        <span class="n">found_assig</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">found_assig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">updates_lti1p1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">CourseLTIProvider</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">CourseLTIProvider</span><span class="o">.</span><span class="n">course</span> <span class="o">==</span> <span class="n">course</span><span class="p">,</span>
                    <span class="n">CourseLTIProvider</span><span class="o">.</span><span class="n">lti_provider</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">updates_lti1p1</span><span class="p">,</span>
                    <span class="n">CourseLTIProvider</span><span class="o">.</span><span class="n">old_connection</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                <span class="n">found_assig</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">old_resource_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">found_assig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Make sure we always upgrade this assignment to the latest lti 1.3</span>
            <span class="c1"># resource id.</span>
            <span class="n">found_assig</span><span class="o">.</span><span class="n">lti_assignment_id</span> <span class="o">=</span> <span class="n">resource_id</span>

        <span class="k">return</span> <span class="n">found_assig</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_private_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rsa</span><span class="o">.</span><span class="n">RSAPrivateKeyWithSerialization</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crypto_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_private_key</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_crypto_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">default_backend</span><span class="p">()</span>
        <span class="p">)</span>

<div class="viewcode-block" id="LTI1p3Provider.get_public_key"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p3Provider.get_public_key">[docs]</a>    <span class="k">def</span> <span class="nf">get_public_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the public key that is associated with this LTIProvider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">PEM</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">PublicFormat</span><span class="o">.</span><span class="n">SubjectPublicKeyInfo</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LTI1p3Provider.get_public_jwk"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p3Provider.get_public_jwk">[docs]</a>    <span class="k">def</span> <span class="nf">get_public_jwk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the public part of key used to communicate with the LMS</span>
<span class="sd">            represented as jwk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pub_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_public_key</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="n">jwk</span> <span class="o">=</span> <span class="n">jwcrypto</span><span class="o">.</span><span class="n">jwk</span><span class="o">.</span><span class="n">JWK</span><span class="o">.</span><span class="n">from_pem</span><span class="p">(</span><span class="n">pub_key</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">jwk</span><span class="o">.</span><span class="n">has_private</span>

        <span class="c1"># For Canvas, and maybe others too, we need to set the `alg` and `use`</span>
        <span class="c1"># field of the jwk, however the python library doesn&#39;t export this. We</span>
        <span class="c1"># now that for now this is always &#39;RS256&#39; and &#39;sig&#39;. This assertion is</span>
        <span class="c1"># simply to make sure we don&#39;t accidentally start creating these keys</span>
        <span class="c1"># differently without noticing.</span>
        <span class="k">assert</span> <span class="n">jwk</span><span class="o">.</span><span class="n">key_type</span> <span class="o">==</span> <span class="s1">&#39;RSA&#39;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jwk</span><span class="o">.</span><span class="n">export_public</span><span class="p">()),</span>
            <span class="s1">&#39;alg&#39;</span><span class="p">:</span> <span class="s1">&#39;RS256&#39;</span><span class="p">,</span>
            <span class="s1">&#39;use&#39;</span><span class="p">:</span> <span class="s1">&#39;sig&#39;</span><span class="p">,</span>
        <span class="p">}</span></div>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">iss</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the ``iss`` of this lms.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            DO NOT rely on this being unique, it is not! The tuple of the</span>
<span class="sd">            ``iss``, ``client_id`` is unique for each provider, but please</span>
<span class="sd">            simply use the id of this provider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>

<div class="viewcode-block" id="LTI1p3Provider.get_registration"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p3Provider.get_registration">[docs]</a>    <span class="k">def</span> <span class="nf">get_registration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;lti_v1_3.CGRegistration&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a registration object for this provider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">lti_v1_3</span><span class="o">.</span><span class="n">CGRegistration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="LTI1p3Provider.get_service_connector"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p3Provider.get_service_connector">[docs]</a>    <span class="k">def</span> <span class="nf">get_service_connector</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">lti_v1_3</span><span class="o">.</span><span class="n">CGServiceConnector</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the connector to talk to the LMS with.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">lti_v1_3</span><span class="o">.</span><span class="n">CGServiceConnector</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="LTI1p3Provider.supports_max_points"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p3Provider.supports_max_points">[docs]</a>    <span class="k">def</span> <span class="nf">supports_max_points</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;All LTI 1.3 providers support bonus points.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="c1"># The next methods all are handlers for signals we setup in `setup_signals`</span>
    <span class="c1"># at the end of the class</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_delete_submission</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">work_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">work</span> <span class="o">=</span> <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">work_id</span><span class="p">)</span>
        <span class="n">assig</span><span class="p">,</span> <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_self_from_assignment_id</span><span class="p">(</span>
            <span class="kc">None</span> <span class="k">if</span> <span class="n">work</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">work</span><span class="o">.</span><span class="n">assignment_id</span>
        <span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">DatetimeWithTimezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">assig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">work</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">work</span><span class="o">.</span><span class="n">deleted</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Work was not deleted&#39;</span><span class="p">,</span> <span class="n">work</span><span class="o">=</span><span class="n">work</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">group_of_user</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">group</span>
        <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">work</span><span class="o">.</span><span class="n">get_all_authors</span><span class="p">():</span>
            <span class="c1"># pylint: disable=protected-access</span>
            <span class="n">latest_sub</span> <span class="o">=</span> <span class="n">assig</span><span class="o">.</span><span class="n">get_latest_submission_for_user</span><span class="p">(</span>
                <span class="n">author</span><span class="p">,</span> <span class="n">group_of_user</span><span class="o">=</span><span class="n">group_of_user</span>
            <span class="p">)</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">latest_sub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_passback_grade</span><span class="p">(</span>
                    <span class="n">user</span><span class="o">=</span><span class="n">author</span><span class="p">,</span> <span class="n">assignment</span><span class="o">=</span><span class="n">assig</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">now</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_passback_grade</span><span class="p">(</span>
                    <span class="n">sub</span><span class="o">=</span><span class="n">latest_sub</span><span class="p">,</span> <span class="n">assignment</span><span class="o">=</span><span class="n">assig</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">now</span>
                <span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_passback_new_user</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">user_course_id_tsp</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user_id</span><span class="p">,</span> <span class="n">course_id</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">user_course_id_tsp</span>

        <span class="n">course</span> <span class="o">=</span> <span class="n">course_models</span><span class="o">.</span><span class="n">Course</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_self_from_course</span><span class="p">(</span><span class="n">course</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">course</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
            <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_enrolled</span><span class="p">(</span><span class="n">course</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">assig</span> <span class="ow">in</span> <span class="n">course</span><span class="o">.</span><span class="n">get_assignments</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">assignment_models</span><span class="o">.</span><span class="n">Assignment</span><span class="o">.</span><span class="n">is_lti</span><span class="p">,</span>
            <span class="n">assignment_models</span><span class="o">.</span><span class="n">Assignment</span><span class="o">.</span><span class="n">is_visible</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="c1"># pylint: disable=protected-access</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_passback_grade</span><span class="p">(</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                <span class="n">assignment</span><span class="o">=</span><span class="n">assig</span><span class="p">,</span>
                <span class="c1"># The user might already have a submission by the time this</span>
                <span class="c1"># passback is done, however this passback should be ignored in</span>
                <span class="c1"># that case as the timestamp should be older.</span>
                <span class="n">timestamp</span><span class="o">=</span><span class="n">DatetimeWithTimezone</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span>
            <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_passback_submission</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">work_assignment_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">work_id</span><span class="p">,</span> <span class="n">assignment_id</span> <span class="o">=</span> <span class="n">work_assignment_id</span>
        <span class="n">assig</span><span class="p">,</span> <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_self_from_assignment_id</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">DatetimeWithTimezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">assig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Could not find self or assignment&#39;</span><span class="p">,</span>
                <span class="n">found_self</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">found_assignment</span><span class="o">=</span><span class="n">assig</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">work</span> <span class="o">=</span> <span class="n">assig</span><span class="o">.</span><span class="n">get_all_latest_submissions</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">work_id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">work</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Submission is not the latest&#39;</span><span class="p">,</span>
                <span class="n">assignment</span><span class="o">=</span><span class="n">assig</span><span class="p">,</span>
                <span class="n">work_id</span><span class="o">=</span><span class="n">work_id</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># pylint: disable=protected-access</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_passback_grade</span><span class="p">(</span>
            <span class="n">sub</span><span class="o">=</span><span class="n">work</span><span class="p">,</span>
            <span class="n">assignment</span><span class="o">=</span><span class="n">assig</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_passback_grades</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">assignment_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">assig</span><span class="p">,</span> <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_self_from_assignment_id</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">DatetimeWithTimezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">assig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">assig</span><span class="o">.</span><span class="n">should_passback</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">subs</span> <span class="o">=</span> <span class="n">assig</span><span class="o">.</span><span class="n">get_all_latest_submissions</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Passback grades&#39;</span><span class="p">,</span> <span class="n">gotten_submission</span><span class="o">=</span><span class="n">subs</span><span class="p">)</span>
        <span class="n">found_user_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subs</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">get_all_authors</span><span class="p">())</span>

        <span class="c1"># pylint: disable=protected-access</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_passback_grade</span><span class="p">(</span><span class="n">sub</span><span class="o">=</span><span class="n">sub</span><span class="p">,</span> <span class="n">assignment</span><span class="o">=</span><span class="n">assig</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">assig</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">get_all_users_in_course</span><span class="p">(</span>
            <span class="n">include_test_students</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">notin_</span><span class="p">(</span><span class="n">found_user_ids</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_passback_grade</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">assignment</span><span class="o">=</span><span class="n">assig</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="nd">@t</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="nf">_passback_grade</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">assignment</span><span class="p">:</span> <span class="s1">&#39;assignment_models.Assignment&#39;</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="s1">&#39;user_models.User&#39;</span><span class="p">,</span>
        <span class="n">timestamp</span><span class="p">:</span> <span class="n">DatetimeWithTimezone</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="nd">@t</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="nf">_passback_grade</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">assignment</span><span class="p">:</span> <span class="s1">&#39;assignment_models.Assignment&#39;</span><span class="p">,</span>
        <span class="n">sub</span><span class="p">:</span> <span class="s1">&#39;Work&#39;</span><span class="p">,</span>
        <span class="n">timestamp</span><span class="p">:</span> <span class="n">DatetimeWithTimezone</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;work_models.GradeHistory&#39;</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">_passback_grade</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">assignment</span><span class="p">:</span> <span class="s1">&#39;assignment_models.Assignment&#39;</span><span class="p">,</span>
        <span class="n">sub</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;Work&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;user_models.User&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timestamp</span><span class="p">:</span> <span class="n">DatetimeWithTimezone</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;work_models.GradeHistory&#39;</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">sub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sub</span><span class="o">.</span><span class="n">deleted</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Submission is deleted, not passing back&#39;</span><span class="p">,</span> <span class="n">work</span><span class="o">=</span><span class="n">sub</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Passing back submission&#39;</span><span class="p">,</span> <span class="n">work</span><span class="o">=</span><span class="n">sub</span><span class="p">)</span>

        <span class="n">grade</span> <span class="o">=</span> <span class="n">lti_v1_3</span><span class="o">.</span><span class="n">CGGrade</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grade</span><span class="o">.</span><span class="n">set_grading_progress</span><span class="p">(</span><span class="s1">&#39;NotReady&#39;</span><span class="p">)</span>
            <span class="n">grade</span><span class="o">.</span><span class="n">set_activity_progress</span><span class="p">(</span><span class="s1">&#39;Initialized&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">assignment</span><span class="o">.</span><span class="n">should_passback</span> <span class="ow">and</span> <span class="n">sub</span><span class="o">.</span><span class="n">grade</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grade</span><span class="o">.</span><span class="n">set_score_given</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">grade</span><span class="p">)</span>
            <span class="n">grade</span><span class="o">.</span><span class="n">set_grading_progress</span><span class="p">(</span><span class="s1">&#39;FullyGraded&#39;</span><span class="p">)</span>
            <span class="n">grade</span><span class="o">.</span><span class="n">set_activity_progress</span><span class="p">(</span><span class="s1">&#39;Completed&#39;</span><span class="p">)</span>
            <span class="n">grade</span><span class="o">.</span><span class="n">set_extra_claims</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s1">&#39;https://canvas.instructure.com/lti/submission&#39;</span><span class="p">:</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;submission_type&#39;</span><span class="p">:</span> <span class="s1">&#39;basic_lti_launch&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;submission_data&#39;</span><span class="p">:</span>
                                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_launch_url</span><span class="p">(</span><span class="n">goto_latest_sub</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
                        <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Setting extra claims&#39;</span><span class="p">,</span> <span class="n">extra_claims</span><span class="o">=</span><span class="n">grade</span><span class="o">.</span><span class="n">get_extra_claims</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">grade</span><span class="o">.</span><span class="n">set_grading_progress</span><span class="p">(</span><span class="s1">&#39;Pending&#39;</span><span class="p">)</span>
            <span class="c1"># This is not really the case. Submitted means that a user is still</span>
            <span class="c1"># able to make more submissions, but if a user does not have the</span>
            <span class="c1"># permission to submit again this is not the case. In this case we</span>
            <span class="c1"># should use &#39;Completed&#39;.</span>
            <span class="n">grade</span><span class="o">.</span><span class="n">set_activity_progress</span><span class="p">(</span><span class="s1">&#39;Submitted&#39;</span><span class="p">)</span>

        <span class="n">service_connector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_service_connector</span><span class="p">()</span>
        <span class="n">grades_service</span> <span class="o">=</span> <span class="n">psef</span><span class="o">.</span><span class="n">lti</span><span class="o">.</span><span class="n">v1_3</span><span class="o">.</span><span class="n">CGAssignmentsGradesService</span><span class="p">(</span>
            <span class="n">service_connector</span><span class="p">,</span> <span class="n">assignment</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">sub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># This is assured by the mypy overloads</span>
            <span class="k">assert</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">authors</span> <span class="o">=</span> <span class="p">[</span><span class="n">user</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">authors</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">get_all_authors</span><span class="p">()</span>

        <span class="n">author_lookup</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">UserLTIProvider</span><span class="o">.</span><span class="n">user_id</span><span class="p">),</span>
                <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">UserLTIProvider</span><span class="o">.</span><span class="n">lti_user_id</span><span class="p">),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">UserLTIProvider</span><span class="o">.</span><span class="n">lti_provider</span> <span class="o">==</span> <span class="bp">self</span><span class="p">,</span>
                <span class="n">UserLTIProvider</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">authors</span><span class="p">]),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">passed_back_once</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">authors</span><span class="p">:</span>
            <span class="n">lti_user_id</span> <span class="o">=</span> <span class="n">author_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">author</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lti_user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Author does not have an LTI user id&#39;</span><span class="p">,</span>
                    <span class="n">author</span><span class="o">=</span><span class="n">author</span><span class="p">,</span>
                    <span class="n">lti_provider</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">grade</span><span class="o">.</span><span class="n">set_user_id</span><span class="p">(</span><span class="n">lti_user_id</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># The ``grade`` is mutable, and we also mutate it in the</span>
                <span class="c1"># loop. The call ``put_grade`` shouldn&#39;t mutate ``grade`` and</span>
                <span class="c1"># it shouldn&#39;t keep a reference after the call, so not copying</span>
                <span class="c1"># should be safe. The advantage of copying is that in testing</span>
                <span class="c1"># it is easier with a copy to see for whom a grade was passed</span>
                <span class="c1"># back, furthermore it is also nice and defensive for if the</span>
                <span class="c1"># library ever changes its implementation.</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">grades_service</span><span class="o">.</span><span class="n">put_grade</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">grade</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">pylti1p3</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">LtiException</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Passing back grade failed&#39;</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">report_to_sentry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Successfully passed back grade&#39;</span><span class="p">,</span>
                    <span class="n">work</span><span class="o">=</span><span class="n">sub</span><span class="p">,</span>
                    <span class="n">passback_result</span><span class="o">=</span><span class="n">res</span>
                <span class="p">)</span>
                <span class="n">passed_back_once</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">sub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">passed_back_once</span> <span class="ow">and</span>
            <span class="n">grade</span><span class="o">.</span><span class="n">get_score_given</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_history_sub</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_retrieve_users_in_course</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">course_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">course_models</span><span class="o">.</span><span class="n">Course</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">course_id</span><span class="p">)</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_self_from_course</span><span class="p">(</span><span class="n">course</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">course</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">course_lti_provider</span> <span class="o">=</span> <span class="n">course</span><span class="o">.</span><span class="n">course_lti_provider</span>
        <span class="k">assert</span> <span class="n">course_lti_provider</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">service_connector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_service_connector</span><span class="p">()</span>
        <span class="n">members</span> <span class="o">=</span> <span class="n">course_lti_provider</span><span class="o">.</span><span class="n">get_members</span><span class="p">(</span><span class="n">service_connector</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Got members&#39;</span><span class="p">,</span> <span class="n">found_members</span><span class="o">=</span><span class="n">members</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Got member&#39;</span><span class="p">,</span> <span class="n">member</span><span class="o">=</span><span class="n">member</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">member</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;Active&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;Active&#39;</span><span class="p">,</span> <span class="s1">&#39;Inactive&#39;</span><span class="p">}:</span>  <span class="c1"># pragma: no cover</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Got unsupported status&#39;</span><span class="p">,</span> <span class="n">member</span><span class="o">=</span><span class="n">member</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># This is NOT a typo, the claim is really called &#39;message&#39; and it</span>
            <span class="c1"># contains an array of messages. However, for some strange reason</span>
            <span class="c1"># some LMS (looking at you Blackboard) don&#39;t send an array, but</span>
            <span class="c1"># send a single object. So we wrap it in a list if this is the</span>
            <span class="c1"># case.</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="n">member</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="p">[])</span>

            <span class="n">get_claim_data</span> <span class="o">=</span> <span class="n">psef</span><span class="o">.</span><span class="n">lti</span><span class="o">.</span><span class="n">v1_3</span><span class="o">.</span><span class="n">CGCustomClaims</span><span class="o">.</span><span class="n">get_custom_claim_data</span>
            <span class="n">custom_claim</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">psef</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">maybe_wrap_in_list</span><span class="p">(</span><span class="n">messages</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">custom_claim</span> <span class="o">=</span> <span class="n">get_claim_data</span><span class="p">(</span>
                        <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ltiv1_3_claims</span><span class="o">.</span><span class="n">CUSTOM</span><span class="p">,</span> <span class="p">{})),</span>
                        <span class="n">base_data</span><span class="o">=</span><span class="n">member</span>
                    <span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>  <span class="c1"># pylint: disable=bare-except</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;Could not parse message&#39;</span><span class="p">,</span>
                        <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="n">message</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Adding member to course&#39;</span><span class="p">,</span>
                <span class="n">member</span><span class="o">=</span><span class="n">member</span><span class="p">,</span>
                <span class="n">custom_claim</span><span class="o">=</span><span class="n">custom_claim</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">UserLTIProvider</span><span class="o">.</span><span class="n">get_or_create_user</span><span class="p">(</span>
                    <span class="n">lti_user_id</span><span class="o">=</span><span class="n">member</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
                    <span class="n">lti_provider</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">wanted_username</span><span class="o">=</span><span class="n">psef</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">on_not_none</span><span class="p">(</span>
                        <span class="n">custom_claim</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">claim</span><span class="p">:</span> <span class="n">claim</span><span class="o">.</span><span class="n">username</span>
                    <span class="p">),</span>
                    <span class="n">email</span><span class="o">=</span><span class="n">lti_v1_3</span><span class="o">.</span><span class="n">get_email_for_user</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="bp">self</span><span class="p">),</span>
                    <span class="n">full_name</span><span class="o">=</span><span class="n">member</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                    <span class="n">old_lti_user_id</span><span class="o">=</span><span class="n">member</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lti11_legacy_user_id&#39;</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>  <span class="c1"># pylint: disable=bare-except</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not add new user&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">course_lti_provider</span><span class="o">.</span><span class="n">maybe_add_user_to_course</span><span class="p">(</span>
                    <span class="n">user</span><span class="p">,</span>
                    <span class="n">member</span><span class="p">[</span><span class="s1">&#39;roles&#39;</span><span class="p">],</span>
                <span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># End of all signal handlers.</span>

<div class="viewcode-block" id="LTI1p3Provider.supports_setting_deadline"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p3Provider.supports_setting_deadline">[docs]</a>    <span class="k">def</span> <span class="nf">supports_setting_deadline</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Does this lms supports setting deadline.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            class :class:`psef.lti.v1_3.lms_capabilities.LMSCapabilities`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lms_capabilities</span><span class="o">.</span><span class="n">set_deadline</span></div>

<div class="viewcode-block" id="LTI1p3Provider.supports_setting_state"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p3Provider.supports_setting_state">[docs]</a>    <span class="k">def</span> <span class="nf">supports_setting_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Does the LMS support the available at.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lms_capabilities</span><span class="o">.</span><span class="n">set_state</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_custom_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">psef</span><span class="o">.</span><span class="n">lti</span><span class="o">.</span><span class="n">v1_3</span><span class="o">.</span><span class="n">CGCustomClaims</span><span class="o">.</span><span class="n">get_variable_claims_config</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lms_capabilities</span>
        <span class="p">)</span>

<div class="viewcode-block" id="LTI1p3Provider.get_json_config"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p3Provider.get_json_config">[docs]</a>    <span class="k">def</span> <span class="nf">get_json_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the config used by this lti provider for setup.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="o">*</span><span class="n">to_add</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">furl</span><span class="o">.</span><span class="n">furl</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;EXTERNAL_URL&quot;</span><span class="p">]</span>
                             <span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">to_add</span><span class="p">)</span><span class="o">.</span><span class="n">tostr</span><span class="p">()</span>

        <span class="n">target_link_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_launch_url</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">tostr</span><span class="p">()</span>
        <span class="n">icon_url</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="s1">&#39;/static/favicon/android-chrome-512x512.png&#39;</span><span class="p">)</span>
        <span class="n">placement</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;Add CodeGrade assignment&#39;</span><span class="p">,</span>
            <span class="s1">&#39;enabled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;placement&#39;</span><span class="p">:</span> <span class="s1">&#39;assignment_selection&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message_type&#39;</span><span class="p">:</span> <span class="s1">&#39;LtiDeepLinkingRequest&#39;</span><span class="p">,</span>
            <span class="s1">&#39;target_link_uri&#39;</span><span class="p">:</span> <span class="n">target_link_uri</span><span class="p">,</span>
            <span class="s1">&#39;icon_url&#39;</span><span class="p">:</span> <span class="n">icon_url</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;CodeGrade&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Deliver engaging feedback on code.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;oidc_initiation_url&#39;</span><span class="p">:</span> <span class="n">get_url</span><span class="p">(</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="s1">&#39;v1&#39;</span><span class="p">,</span> <span class="s1">&#39;lti1.3&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">),</span>
            <span class="s1">&#39;target_link_uri&#39;</span><span class="p">:</span> <span class="n">target_link_uri</span><span class="p">,</span>
            <span class="s1">&#39;scopes&#39;</span><span class="p">:</span> <span class="n">psef</span><span class="o">.</span><span class="n">lti</span><span class="o">.</span><span class="n">v1_3</span><span class="o">.</span><span class="n">NEEDED_SCOPES</span><span class="p">,</span>
            <span class="s1">&#39;extensions&#39;</span><span class="p">:</span>
                <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;domain&#39;</span><span class="p">:</span> <span class="n">get_url</span><span class="p">(),</span>
                        <span class="s1">&#39;tool_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                        <span class="s1">&#39;platform&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">iss</span><span class="p">,</span>
                        <span class="s1">&#39;privacy_level&#39;</span><span class="p">:</span> <span class="s1">&#39;public&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;settings&#39;</span><span class="p">:</span>
                            <span class="p">{</span>
                                <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;CodeGrade&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;icon_url&#39;</span><span class="p">:</span> <span class="n">icon_url</span><span class="p">,</span>
                                <span class="s1">&#39;placements&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">placement</span><span class="p">],</span>
                            <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">],</span>
            <span class="s1">&#39;public_jwk_url&#39;</span><span class="p">:</span>
                <span class="n">get_url</span><span class="p">(</span>
                    <span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="s1">&#39;v1&#39;</span><span class="p">,</span> <span class="s1">&#39;lti1.3&#39;</span><span class="p">,</span> <span class="s1">&#39;providers&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="s1">&#39;jwks&#39;</span>
                <span class="p">),</span>
            <span class="s1">&#39;custom_fields&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom_fields</span><span class="p">,</span>
        <span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__to_json__</span><span class="p">()</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">base</span><span class="p">,</span>
            <span class="s1">&#39;finalized&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalized</span><span class="p">,</span>
            <span class="s1">&#39;intended_use&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intended_use</span><span class="p">,</span>
            <span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lms_capabilities</span><span class="p">,</span>
            <span class="s1">&#39;edit_secret&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;iss&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">iss</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalized</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">auth</span><span class="o">.</span><span class="n">LTI1p3ProviderPermissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">ensure_may_edit</span><span class="o">.</span><span class="n">as_bool</span><span class="p">():</span>
                <span class="n">res</span><span class="p">[</span><span class="s1">&#39;edit_secret&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_secret</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">res</span><span class="p">,</span>
                <span class="s1">&#39;auth_login_url&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_login_url</span><span class="p">,</span>
                <span class="s1">&#39;auth_token_url&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_token_url</span><span class="p">,</span>
                <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
                <span class="s1">&#39;key_set_url&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_set_url</span><span class="p">,</span>
                <span class="s1">&#39;auth_audience&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_audience</span><span class="p">,</span>
                <span class="s1">&#39;custom_fields&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom_fields</span><span class="p">,</span>
                <span class="s1">&#39;public_jwk&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_public_jwk</span><span class="p">(),</span>
                <span class="s1">&#39;public_key&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_public_key</span><span class="p">(),</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="LTI1p3Provider.setup_signals"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.LTI1p3Provider.setup_signals">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setup_signals</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Setup the signals used by the LTI 1.3 providers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_SIGNALS_SETUP</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">return</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_SIGNALS_SETUP</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">pre_checker</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_signal_assignment_pre_check</span>

        <span class="n">signals</span><span class="o">.</span><span class="n">ASSIGNMENT_STATE_CHANGED</span><span class="o">.</span><span class="n">connect_celery</span><span class="p">(</span>
            <span class="n">pre_check</span><span class="o">=</span><span class="n">pre_checker</span><span class="p">,</span>
            <span class="n">converter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">task_args</span><span class="o">=</span><span class="n">_PASSBACK_CELERY_OPTS</span><span class="p">,</span>
        <span class="p">)(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_passback_grades</span><span class="p">)</span>

        <span class="n">signals</span><span class="o">.</span><span class="n">WORK_DELETED</span><span class="o">.</span><span class="n">connect_celery</span><span class="p">(</span>
            <span class="n">pre_check</span><span class="o">=</span><span class="k">lambda</span> <span class="n">wd</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">wd</span><span class="o">.</span><span class="n">was_latest</span> <span class="ow">and</span> <span class="n">pre_checker</span><span class="p">(</span><span class="n">wd</span><span class="o">.</span><span class="n">deleted_work</span><span class="o">.</span><span class="n">assignment</span><span class="p">)</span>
            <span class="p">),</span>  <span class="c1"># yapf: disable</span>
            <span class="n">converter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">wd</span><span class="p">:</span> <span class="n">wd</span><span class="o">.</span><span class="n">deleted_work</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">task_args</span><span class="o">=</span><span class="n">_PASSBACK_CELERY_OPTS</span>
        <span class="p">)(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_delete_submission</span><span class="p">)</span>

        <span class="n">signals</span><span class="o">.</span><span class="n">WORK_CREATED</span><span class="o">.</span><span class="n">connect_celery</span><span class="p">(</span>
            <span class="n">pre_check</span><span class="o">=</span><span class="k">lambda</span> <span class="n">work</span><span class="p">:</span> <span class="n">pre_checker</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">assignment</span><span class="p">),</span>
            <span class="n">converter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">work</span><span class="p">:</span> <span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">assignment_id</span><span class="p">),</span>
            <span class="n">task_args</span><span class="o">=</span><span class="n">_PASSBACK_CELERY_OPTS</span><span class="p">,</span>
        <span class="p">)(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_passback_submission</span><span class="p">)</span>

        <span class="n">signals</span><span class="o">.</span><span class="n">GRADE_UPDATED</span><span class="o">.</span><span class="n">connect_celery</span><span class="p">(</span>
            <span class="n">pre_check</span><span class="o">=</span><span class="k">lambda</span> <span class="n">work</span><span class="p">:</span> <span class="n">pre_checker</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">assignment</span><span class="p">),</span>
            <span class="n">converter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">work</span><span class="p">:</span> <span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">assignment_id</span><span class="p">),</span>
            <span class="n">task_args</span><span class="o">=</span><span class="n">_PASSBACK_CELERY_OPTS</span><span class="p">,</span>
        <span class="p">)(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_passback_submission</span><span class="p">)</span>

        <span class="n">signals</span><span class="o">.</span><span class="n">USER_ADDED_TO_COURSE</span><span class="o">.</span><span class="n">connect_celery</span><span class="p">(</span>
            <span class="n">converter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">uc</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">uc</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">uc</span><span class="o">.</span><span class="n">course_role</span><span class="o">.</span><span class="n">course_id</span><span class="p">,</span>
                <span class="n">DatetimeWithTimezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="p">),</span>
            <span class="n">pre_check</span><span class="o">=</span><span class="k">lambda</span> <span class="n">uc</span><span class="p">:</span> <span class="n">uc</span><span class="o">.</span><span class="n">course_role</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">is_lti</span><span class="p">,</span>
            <span class="n">task_args</span><span class="o">=</span><span class="n">_PASSBACK_CELERY_OPTS</span><span class="p">,</span>
            <span class="n">prevent_recursion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_passback_new_user</span><span class="p">)</span>

        <span class="n">signals</span><span class="o">.</span><span class="n">USER_ADDED_TO_COURSE</span><span class="o">.</span><span class="n">connect_celery</span><span class="p">(</span>
            <span class="n">converter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">uc</span><span class="p">:</span> <span class="n">uc</span><span class="o">.</span><span class="n">course_role</span><span class="o">.</span><span class="n">course_id</span><span class="p">,</span>
            <span class="n">pre_check</span><span class="o">=</span><span class="k">lambda</span> <span class="n">uc</span><span class="p">:</span> <span class="n">uc</span><span class="o">.</span><span class="n">course_role</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">is_lti</span><span class="p">,</span>
            <span class="n">task_args</span><span class="o">=</span><span class="n">_PASSBACK_CELERY_OPTS</span><span class="p">,</span>
            <span class="n">prevent_recursion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_retrieve_users_in_course</span><span class="p">)</span>

        <span class="n">signals</span><span class="o">.</span><span class="n">ASSIGNMENT_CREATED</span><span class="o">.</span><span class="n">connect_celery</span><span class="p">(</span>
            <span class="n">converter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">course_id</span><span class="p">,</span>
            <span class="n">pre_check</span><span class="o">=</span><span class="n">pre_checker</span><span class="p">,</span>
            <span class="n">task_args</span><span class="o">=</span><span class="n">_PASSBACK_CELERY_OPTS</span><span class="p">,</span>
        <span class="p">)(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_retrieve_users_in_course</span><span class="p">)</span></div></div>


<span class="n">LTI1p3Provider</span><span class="o">.</span><span class="n">setup_signals</span><span class="p">()</span>
<span class="n">lti_provider_handlers</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>

<span class="c1"># Begin of classes that provide connections between other classes and the LTI</span>
<span class="c1"># classes.</span>


<div class="viewcode-block" id="UserLTIProvider"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.UserLTIProvider">[docs]</a><span class="k">class</span> <span class="nc">UserLTIProvider</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">TimestampMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class connects a :class:`.user_models.User` to a</span>
<span class="sd">        :class:`.LTIProviderBase`.</span>

<span class="sd">    This class makes sure that it is possible to have two users with the same</span>
<span class="sd">    lti user id, but from different LMSes. Each user can be linked to at most</span>
<span class="sd">    one LTIProvider, and eacher ``lti_user_id`` has to be unique within the</span>
<span class="sd">    LMS.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;user_lti-provider&#39;</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;User.id&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">lti_provider_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;lti_provider_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">UUID_LENGTH</span><span class="p">),</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">LTIProviderBase</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="c1">#: The id of the user given to us by the LMS. Not globally unique!</span>
    <span class="n">lti_user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;lti_user_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c1"># A user can only be connected once to an LTI Provider</span>
        <span class="n">db</span><span class="o">.</span><span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">lti_provider_id</span><span class="p">),</span>
        <span class="c1"># LTI user ids should be unique for a single LTI provider, however they</span>
        <span class="c1"># are NOT (!) globally unique between LMSes.</span>
        <span class="n">db</span><span class="o">.</span><span class="n">UniqueConstraint</span><span class="p">(</span><span class="n">lti_provider_id</span><span class="p">,</span> <span class="n">lti_user_id</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">lti_provider</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="n">LTIProviderBase</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">lti_provider_id</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="s1">&#39;user_models.User&#39;</span><span class="p">,</span> <span class="n">lti_provider</span><span class="p">:</span> <span class="n">LTIProviderBase</span><span class="p">,</span>
        <span class="n">lti_user_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lti_provider</span> <span class="o">=</span> <span class="n">lti_provider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lti_user_id</span> <span class="o">=</span> <span class="n">lti_user_id</span>

<div class="viewcode-block" id="UserLTIProvider.user_is_linked"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.UserLTIProvider.user_is_linked">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">user_is_linked</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="s1">&#39;user_models.User&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Is the given user known in any LTIProvider</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_create_user</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">lti_user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">lti_provider</span><span class="p">:</span> <span class="n">LTIProviderBase</span><span class="p">,</span>
        <span class="n">wanted_username</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="s1">&#39;user_models.User&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Creating new user for lti user id&#39;</span><span class="p">,</span>
            <span class="n">lti_user_id</span><span class="o">=</span><span class="n">lti_user_id</span><span class="p">,</span>
            <span class="n">wanted_username</span><span class="o">=</span><span class="n">wanted_username</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">wanted_username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">psef</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">APIException</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s1">&#39;Cannot create new user as a username was not provided in&#39;</span>
                    <span class="s1">&#39; the LTI launch. This probably occurred because the LTI&#39;</span>
                    <span class="s1">&#39; provider was not configured correctly.&#39;</span>
                <span class="p">),</span> <span class="s1">&#39;The LTI launch did not include a username&#39;</span><span class="p">,</span>
                <span class="n">psef</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">APICodes</span><span class="o">.</span><span class="n">MISSING_REQUIRED_PARAM</span><span class="p">,</span> <span class="mi">400</span>
            <span class="p">)</span>

        <span class="c1"># New LTI user id is found and no user is logged in or the current</span>
        <span class="c1"># user has a different LTI user id. A new user is created and</span>
        <span class="c1"># logged in.</span>

        <span class="n">username</span> <span class="o">=</span> <span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">find_possible_username</span><span class="p">(</span><span class="n">wanted_username</span><span class="p">)</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">user_models</span><span class="o">.</span><span class="n">User</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">full_name</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
            <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">(</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                <span class="n">lti_provider</span><span class="o">=</span><span class="n">lti_provider</span><span class="p">,</span>
                <span class="n">lti_user_id</span><span class="o">=</span><span class="n">lti_user_id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="n">token</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">make_access_token</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="n">token</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_maybe_migrate_lti1p1_user</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">lti_1p3_user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lti_1p1_user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">lti_provider</span><span class="p">:</span> <span class="n">LTI1p3Provider</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;user_models.User&#39;</span><span class="p">]:</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">lti_provider</span><span class="o">.</span><span class="n">updates_lti1p1</span>
        <span class="k">if</span> <span class="n">provider</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">lti_user</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">find_user</span><span class="p">(</span><span class="n">lti_1p1_user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lti_user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="bp">cls</span><span class="p">(</span>
                    <span class="n">user</span><span class="o">=</span><span class="n">lti_user</span><span class="p">,</span>
                    <span class="n">lti_provider</span><span class="o">=</span><span class="n">lti_provider</span><span class="p">,</span>
                    <span class="n">lti_user_id</span><span class="o">=</span><span class="n">lti_1p3_user_id</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">lti_user</span>

    <span class="nd">@t</span><span class="o">.</span><span class="n">overload</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_or_create_user</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">lti_user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">lti_provider</span><span class="p">:</span> <span class="n">LTI1p1Provider</span><span class="p">,</span>
        <span class="n">wanted_username</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="s1">&#39;user_models.User&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="o">...</span>

    <span class="nd">@t</span><span class="o">.</span><span class="n">overload</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_or_create_user</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">lti_user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">lti_provider</span><span class="p">:</span> <span class="n">LTI1p3Provider</span><span class="p">,</span>
        <span class="n">wanted_username</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">old_lti_user_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="s1">&#39;user_models.User&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="o">...</span>

<div class="viewcode-block" id="UserLTIProvider.get_or_create_user"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.UserLTIProvider.get_or_create_user">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_or_create_user</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">lti_user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">lti_provider</span><span class="p">:</span> <span class="n">LTIProviderBase</span><span class="p">,</span>
        <span class="n">wanted_username</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">old_lti_user_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="s1">&#39;user_models.User&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Get or create a new user for the given LTI Provider</span>

<span class="sd">        :param lti_user_id: The user id that we received from the LMS.</span>
<span class="sd">        :param lti_provider: The provider of the lauchn.</span>
<span class="sd">        :param wanted_username: The username the user wants if it is created.</span>
<span class="sd">        :param full_name: The full name of the launching user.</span>
<span class="sd">        :param email: The email of the user that does this launch.</span>
<span class="sd">        :returns: A tuple containing, in this order: the found or created user,</span>
<span class="sd">            optionally an access token to login the new user (this is only</span>
<span class="sd">            returned if the current user is not the resulting user).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_user</span> <span class="o">=</span> <span class="n">psef</span><span class="o">.</span><span class="n">current_user</span>
        <span class="n">is_logged_in</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">auth</span><span class="o">.</span><span class="n">user_active</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="ow">and</span>
            <span class="c1"># Never connect the global admin user to an LTI course</span>
            <span class="ow">not</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_global_admin_user</span>
        <span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">lti_user</span> <span class="o">=</span> <span class="n">lti_provider</span><span class="o">.</span><span class="n">find_user</span><span class="p">(</span><span class="n">lti_user_id</span><span class="o">=</span><span class="n">lti_user_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lti_user</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lti_provider</span><span class="p">,</span> <span class="n">LTI1p3Provider</span><span class="p">):</span>
            <span class="n">lti_user</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_maybe_migrate_lti1p1_user</span><span class="p">(</span>
                <span class="n">lti_1p3_user_id</span><span class="o">=</span><span class="n">lti_user_id</span><span class="p">,</span>
                <span class="c1"># According to the spec the lti 1.1 user id should **not** be</span>
                <span class="c1"># specified if it is the same as the lti 1.3 user id.</span>
                <span class="n">lti_1p1_user_id</span><span class="o">=</span><span class="n">handle_none</span><span class="p">(</span><span class="n">old_lti_user_id</span><span class="p">,</span> <span class="n">lti_user_id</span><span class="p">),</span>
                <span class="n">lti_provider</span><span class="o">=</span><span class="n">lti_provider</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">is_logged_in</span> <span class="ow">and</span> <span class="n">lti_user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">current_user</span> <span class="o">==</span> <span class="n">lti_user</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Currently logged in user is user doing launch&#39;</span><span class="p">)</span>
            <span class="c1"># The currently logged in user is now using LTI</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>
        <span class="k">elif</span> <span class="n">lti_user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_logged_in</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;Found different LTI user than logged in user&#39;</span><span class="p">,</span>
                    <span class="n">lti_user</span><span class="o">=</span><span class="n">lti_user</span>
                <span class="p">)</span>
            <span class="c1"># LTI users are used before the current logged user.</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">lti_user</span><span class="o">.</span><span class="n">make_access_token</span><span class="p">()</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">lti_user</span>
        <span class="k">elif</span> <span class="n">is_logged_in</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">user_is_linked</span><span class="p">(</span><span class="n">current_user</span><span class="p">):</span>
            <span class="c1"># TODO show some sort of screen if this linking is wanted</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Found no LTI user, linking current user&#39;</span><span class="p">,</span>
                <span class="n">lti_user_id</span><span class="o">=</span><span class="n">lti_user_id</span>
            <span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="bp">cls</span><span class="p">(</span>
                    <span class="n">user</span><span class="o">=</span><span class="n">current_user</span><span class="p">,</span>
                    <span class="n">lti_provider</span><span class="o">=</span><span class="n">lti_provider</span><span class="p">,</span>
                    <span class="n">lti_user_id</span><span class="o">=</span><span class="n">lti_user_id</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">user</span><span class="p">,</span> <span class="n">token</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_create_user</span><span class="p">(</span>
                <span class="n">lti_user_id</span><span class="p">,</span> <span class="n">lti_provider</span><span class="p">,</span> <span class="n">wanted_username</span><span class="p">,</span> <span class="n">full_name</span><span class="p">,</span> <span class="n">email</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="n">token</span></div></div>


<div class="viewcode-block" id="CourseLTIProvider"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.CourseLTIProvider">[docs]</a><span class="k">class</span> <span class="nc">CourseLTIProvider</span><span class="p">(</span><span class="n">UUIDMixin</span><span class="p">,</span> <span class="n">TimestampMixin</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This models connects a :class:`.course_models.Course` to a</span>
<span class="sd">        :class:`.LTIProviderBase`.</span>

<span class="sd">    This class also makes sure that only course is created inside CodeGrade for</span>
<span class="sd">    each course inside the LMS, and it makes sure that courses from one LMS are</span>
<span class="sd">    not used as courses for another one. Please see the `__table_args__` unique</span>
<span class="sd">    constraints for more info.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">course_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;course_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Course.id&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">lti_provider_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;lti_provider_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">UUID_LENGTH</span><span class="p">),</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">LTIProviderBase</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">lti_course_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;lti_course_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">old_connection</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;old_connection&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">server_default</span><span class="o">=</span><span class="s1">&#39;false&#39;</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># For LTI1.1: the deployment_id is always the same as `lti_course_id`.</span>
    <span class="n">deployment_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;deployment_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">last_names_roles_poll</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;last_names_roles_poll&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">TIMESTAMP</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">names_roles_claim</span><span class="p">:</span> <span class="n">ColumnProxy</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;_NamesAndRolesData&#39;</span><span class="p">]</span>
                                   <span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
                                       <span class="s1">&#39;names_roles_claim&#39;</span><span class="p">,</span>
                                       <span class="n">JSON</span><span class="p">,</span>
                                       <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span>
                                   <span class="p">)</span>

    <span class="n">lti_provider</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="n">LTIProviderBase</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">lti_provider_id</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">course</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">course_models</span><span class="o">.</span><span class="n">Course</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">course_id</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c1"># For LTI1.1: the deployment_id is always the same as `lti_course_id`.</span>

        <span class="c1"># For LTI1.3: A lti_course_id (context_id in LTI terminology) is</span>
        <span class="c1"># locally (so for a single lti_provider (platform)) unique for a</span>
        <span class="c1"># deployment_id.</span>
        <span class="n">db</span><span class="o">.</span><span class="n">UniqueConstraint</span><span class="p">(</span><span class="n">lti_provider_id</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">,</span> <span class="n">lti_course_id</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">lti_course_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">course</span><span class="p">:</span> <span class="s1">&#39;course_models.Course&#39;</span><span class="p">,</span>
        <span class="n">lti_provider</span><span class="p">:</span> <span class="n">LTIProviderBase</span><span class="p">,</span>
        <span class="n">deployment_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">lti_course_id</span><span class="o">=</span><span class="n">lti_course_id</span><span class="p">,</span>
            <span class="n">course</span><span class="o">=</span><span class="n">course</span><span class="p">,</span>
            <span class="n">lti_provider</span><span class="o">=</span><span class="n">lti_provider</span><span class="p">,</span>
            <span class="n">deployment_id</span><span class="o">=</span><span class="n">deployment_id</span><span class="p">,</span>
            <span class="n">old_connection</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="CourseLTIProvider.can_poll_names_again"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.CourseLTIProvider.can_poll_names_again">[docs]</a>    <span class="k">def</span> <span class="nf">can_poll_names_again</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if we may poll the names again from the LMS.</span>

<span class="sd">        This method checks if the last poll was long enough ago to poll the</span>
<span class="sd">        names again.</span>

<span class="sd">        :returns: ``True`` if we can poll again.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_names_roles_poll</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">DatetimeWithTimezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_names_roles_poll</span>
        <span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;LTI1.3_MIN_POLL_INTERVAL&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="CourseLTIProvider.get_members"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.CourseLTIProvider.get_members">[docs]</a>    <span class="k">def</span> <span class="nf">get_members</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">service_connector</span><span class="p">:</span> <span class="n">pylti1p3</span><span class="o">.</span><span class="n">service_connector</span><span class="o">.</span><span class="n">ServiceConnector</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="s1">&#39;_Member&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Poll the LMS for the members in this course.</span>

<span class="sd">        :param service_connector: The connection to the LMS which we will use</span>
<span class="sd">            the poll the members.</span>
<span class="sd">        :param force: Always poll, even if</span>
<span class="sd">            :func:`CourseLTIProvider.can_poll_names_again` returns ``False``.</span>

<span class="sd">        :returns: The members as retrieved from the LMS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_poll_names_again</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Not polling again as last poll was a short while ago&#39;</span><span class="p">,</span>
                <span class="n">last_names_roles_poll</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">last_names_roles_poll</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names_roles_claim</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="n">claim</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names_roles_claim</span><span class="p">)</span>
        <span class="n">rlid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">get_assignments</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">assignment_models</span><span class="o">.</span><span class="n">Assignment</span><span class="o">.</span><span class="n">lti_assignment_id</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
            <span class="n">assignment_models</span><span class="o">.</span><span class="n">Assignment</span><span class="o">.</span><span class="n">is_visible</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
            <span class="n">assignment_models</span><span class="o">.</span><span class="n">Assignment</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">desc</span><span class="p">(),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">with_entities</span><span class="p">(</span>
            <span class="n">assignment_models</span><span class="o">.</span><span class="n">Assignment</span><span class="o">.</span><span class="n">lti_assignment_id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>

        <span class="n">mem_url_claim</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="s1">&#39;context_memberships_url&#39;</span>
        <span class="k">if</span> <span class="n">rlid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">claim</span><span class="p">[</span><span class="n">mem_url_claim</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">claim</span><span class="p">[</span><span class="n">mem_url_claim</span><span class="p">]</span> <span class="o">=</span> <span class="n">furl</span><span class="o">.</span><span class="n">furl</span><span class="p">(</span><span class="n">claim</span><span class="p">[</span><span class="n">mem_url_claim</span><span class="p">])</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;rlid&#39;</span><span class="p">:</span> <span class="n">rlid</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;No rlid found or claim is missing url&#39;</span><span class="p">,</span>
                <span class="n">claim</span><span class="o">=</span><span class="n">claim</span><span class="p">,</span>
                <span class="n">rlid</span><span class="o">=</span><span class="n">rlid</span><span class="p">,</span>
                <span class="n">report_to_sentry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">pylti1p3</span><span class="o">.</span><span class="n">names_roles</span><span class="o">.</span><span class="n">NamesRolesProvisioningService</span><span class="p">(</span>
            <span class="n">service_connector</span><span class="p">,</span> <span class="n">claim</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get_members</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_names_roles_poll</span> <span class="o">=</span> <span class="n">DatetimeWithTimezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="CourseLTIProvider.create_and_add"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.CourseLTIProvider.create_and_add">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_and_add</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">course</span><span class="p">:</span> <span class="s1">&#39;course_models.Course&#39;</span><span class="p">,</span>
        <span class="n">lti_provider</span><span class="p">:</span> <span class="n">LTIProviderBase</span><span class="p">,</span>
        <span class="n">lti_context_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">deployment_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;CourseLTIProvider&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a :class:`CourseLTIProvider` and add it to the current session.</span>

<span class="sd">        :param course: The course which has to be connected to the</span>
<span class="sd">            ``lti_provider``.</span>
<span class="sd">        :param lti_provder: The LTI provider in which this course is defined.</span>
<span class="sd">        :param lti_context_id: The LTI id of the course.</span>
<span class="sd">        :param deployment_id: The deployment id of the course. This is only</span>
<span class="sd">            defined for LTI1.3.</span>
<span class="sd">        :returns: The created object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">course_lti_provider</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">lti_course_id</span><span class="o">=</span><span class="n">lti_context_id</span><span class="p">,</span>
            <span class="n">course</span><span class="o">=</span><span class="n">course</span><span class="p">,</span>
            <span class="n">lti_provider</span><span class="o">=</span><span class="n">lti_provider</span><span class="p">,</span>
            <span class="n">deployment_id</span><span class="o">=</span><span class="n">deployment_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">course_lti_provider</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">course_lti_provider</span></div>

<div class="viewcode-block" id="CourseLTIProvider.maybe_add_user_to_course"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.lti_provider.CourseLTIProvider.maybe_add_user_to_course">[docs]</a>    <span class="k">def</span> <span class="nf">maybe_add_user_to_course</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="s1">&#39;user_models.User&#39;</span><span class="p">,</span> <span class="n">roles_claim</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Maybe add the given user to the course.</span>

<span class="sd">        This method adds the given user to the course, determining its role</span>
<span class="sd">        based on the given ``roles_claim``, if the user is not already enrolled</span>
<span class="sd">        in the course.</span>

<span class="sd">        .. todo::</span>

<span class="sd">            Move this method to the LTI 1.3 implementation, as this only makes</span>
<span class="sd">            sense when you have an LTI 1.3 roles claim.</span>

<span class="sd">        :param user: The user to possibly enrol in the course connected to this</span>
<span class="sd">            ``CourseLTIProvider``.</span>
<span class="sd">        :param roles_claim: The LTI1p3 roles claim that we should use to</span>
<span class="sd">            determine the role of the given user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_enrolled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">roles</span> <span class="o">=</span> <span class="n">psef</span><span class="o">.</span><span class="n">lti</span><span class="o">.</span><span class="n">v1_3</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">ContextRole</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">.</span><span class="n">parse_roles</span><span class="p">(</span><span class="n">roles_claim</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Finding role for user&#39;</span><span class="p">,</span>
            <span class="n">roles_claim</span><span class="o">=</span><span class="n">roles_claim</span><span class="p">,</span>
            <span class="n">parsed_context_roles</span><span class="o">=</span><span class="n">roles</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">roles</span><span class="p">:</span>
            <span class="n">user</span><span class="o">.</span><span class="n">enroll_in_course</span><span class="p">(</span>
                <span class="n">course_role</span><span class="o">=</span><span class="n">psef</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">CourseRole</span><span class="o">.</span><span class="n">get_by_name</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="p">,</span>
                    <span class="n">roles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">codegrade_role_name</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">unmapped_roles</span> <span class="o">=</span> <span class="n">psef</span><span class="o">.</span><span class="n">lti</span><span class="o">.</span><span class="n">v1_3</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">ContextRole</span><span class="p">[</span>
            <span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">get_unmapped_roles</span><span class="p">(</span><span class="n">roles_claim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">unmapped_roles</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;No mapped LTI roles found, searching for unmapped roles&#39;</span><span class="p">,</span>
                <span class="n">unmapped_roles</span><span class="o">=</span><span class="n">unmapped_roles</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">base</span> <span class="o">=</span> <span class="s1">&#39;Unmapped LTI Role (</span><span class="si">{}</span><span class="s1">)&#39;</span>
            <span class="k">for</span> <span class="n">unmapped_role</span> <span class="ow">in</span> <span class="n">unmapped_roles</span><span class="p">:</span>
                <span class="n">role</span> <span class="o">=</span> <span class="n">psef</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">CourseRole</span><span class="o">.</span><span class="n">get_by_name</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unmapped_role</span><span class="o">.</span><span class="n">stripped_name</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">role</span><span class="p">:</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">enroll_in_course</span><span class="p">(</span><span class="n">course_role</span><span class="o">=</span><span class="n">role</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>

            <span class="n">new_role_name</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unmapped_roles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stripped_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="s1">&#39;New LTI Role&#39;</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                    <span class="n">psef</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">CourseRole</span><span class="o">.</span><span class="n">get_by_name</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">),</span> <span class="n">include_hidden</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
                <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>
                    <span class="k">break</span>
                <span class="n">base</span> <span class="o">=</span> <span class="s1">&#39;New LTI Role (</span><span class="si">{idx}</span><span class="s1">)&#39;</span>
            <span class="n">new_role_name</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating new role&#39;</span><span class="p">,</span> <span class="n">new_role_name</span><span class="o">=</span><span class="n">new_role_name</span><span class="p">)</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">psef</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">CourseRole</span><span class="p">(</span>
            <span class="n">course</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">new_role_name</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="n">user</span><span class="o">.</span><span class="n">enroll_in_course</span><span class="p">(</span><span class="n">course_role</span><span class="o">=</span><span class="n">role</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">role</span><span class="o">.</span><span class="n">name</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, CodeGrade

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>