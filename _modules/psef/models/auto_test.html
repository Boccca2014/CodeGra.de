

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>psef.models.auto_test &mdash; CodeGrade v1.18.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href="../../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                v1.18.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/use-codegrade-as-a-student.html">How to use CodeGrade as a student</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/getting-started-with-codegrade.html">Getting started with CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/autotest-best-practices.html">Best Practices for AutoTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/creating-an-assignment.html">Create a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/set-up-a-rubric-for-an-assignment.html">Set up a rubric for an assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/setting-up-autotest.html">Setting up AutoTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/enabling-continuous-feedback-for-an-assignment.html">Enabling Continuous Feedback for an assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/set-up-group-assignment.html">Set up a CodeGrade group assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/setting-up-hand-in-requirements.html">Set up hand-in requirements for a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/setting-up-git-uploads.html">Set up Git uploads for a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/checking-for-plagiarism.html">Check for plagiarism in a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/dividing-submissions.html">Divide submissions over graders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/pass-back-grades-to-canvas-blackboard-moodle-brightspace.html">Pass back grades to Canvas, Blackboard, Moodle or Brightspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/creating-managing-and-using-snippets.html">Create, manage and use snippets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/setup-password-for-codegrade-account.html">Set up a password for my CodeGrade account</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/using-shortcuts.html">Using shortcuts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/cannot-find-feature-in-codegrade.html">I cannot find a feature in CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/installing-codegrade-filesystem.html">Install the CodeGrade Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/use-codegrade-filesystem.html">Use the CodeGrade Filesystem to locally mount CodeGrade</a></li>
</ul>
<p class="caption"><span class="caption-text">User Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user/overview.html">Overview of CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/codeviewer.html">Code Viewer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/management.html">Course and Assignment Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/plagiarism.html">Plagiarism Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/groups.html">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/permissions.html">Permissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/preferences.html">Settings and Site Preferences</a></li>
<li class="toctree-l1"><a class="reference external" href="https://fs-docs.codegra.de">Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/lms.html">LMS Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/autotest/overview.html">AutoTest</a></li>
</ul>
<p class="caption"><span class="caption-text">About CodeGrade</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../about/about.html">About CodeGrade</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../developerdocs.html">Developer documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CodeGrade</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../psef.html">psef</a> &raquo;</li>
        
      <li>psef.models.auto_test</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for psef.models.auto_test</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This module defines all models needed for auto tests.</span>

<span class="sd">SPDX-License-Identifier: AGPL-3.0-only</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">t</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="kn">import</span> <span class="nn">structlog</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">orm</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span> <span class="k">as</span> <span class="n">sql_func</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">distinct</span>
<span class="kn">from</span> <span class="nn">sqlalchemy_utils</span> <span class="kn">import</span> <span class="n">UUIDType</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">or_</span><span class="p">,</span> <span class="n">and_</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">nullsfirst</span>

<span class="kn">import</span> <span class="nn">psef</span>
<span class="kn">from</span> <span class="nn">cg_flask_helpers</span> <span class="kn">import</span> <span class="n">callback_after_this_request</span>
<span class="kn">from</span> <span class="nn">cg_sqlalchemy_helpers.mixins</span> <span class="kn">import</span> <span class="n">IdMixin</span><span class="p">,</span> <span class="n">UUIDMixin</span><span class="p">,</span> <span class="n">TimestampMixin</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Base</span><span class="p">,</span> <span class="n">MyQuery</span><span class="p">,</span> <span class="n">DbColumn</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">work</span> <span class="k">as</span> <span class="n">work_models</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">auto_test_step</span> <span class="k">as</span> <span class="n">auto_test_step_models</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">auth</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">auto_test</span> <span class="k">as</span> <span class="n">auto_test_module</span>
<span class="kn">from</span> <span class="nn">..helpers</span> <span class="kn">import</span> <span class="n">NotEqualMixin</span>
<span class="kn">from</span> <span class="nn">..registry</span> <span class="kn">import</span> <span class="n">auto_test_handlers</span><span class="p">,</span> <span class="n">auto_test_grade_calculators</span>
<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">APICodes</span><span class="p">,</span> <span class="n">APIException</span><span class="p">,</span> <span class="n">PermissionException</span><span class="p">,</span> <span class="n">InvalidStateException</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">..permissions</span> <span class="kn">import</span> <span class="n">CoursePermission</span> <span class="k">as</span> <span class="n">CPerm</span>

<span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="c1"># pylint: disable=unused-import</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">rubric</span> <span class="k">as</span> <span class="n">rubric_models</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">file</span> <span class="k">as</span> <span class="n">file_models</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">assignment</span> <span class="k">as</span> <span class="n">assignment_models</span>
    <span class="n">hybrid_property</span> <span class="o">=</span> <span class="nb">property</span>  <span class="c1"># pylint: disable=invalid-name</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="kn">import</span> <span class="n">hybrid_property</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>

<span class="n">GradeCalculator</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="s1">&#39;rubric_models.RubricItem&#39;</span><span class="p">],</span> <span class="nb">float</span><span class="p">],</span>
                             <span class="s1">&#39;rubric_models.RubricItem&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="AutoTestSuite"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestSuite">[docs]</a><span class="k">class</span> <span class="nc">AutoTestSuite</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">TimestampMixin</span><span class="p">,</span> <span class="n">IdMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class represents a Suite (also known as category) in an AutoTest.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">ClassVar</span><span class="p">[</span><span class="n">MyQuery</span><span class="p">[</span><span class="s1">&#39;AutoTestSuite&#39;</span><span class="p">]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;AutoTestSuite&#39;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">rubric_row_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;rubric_row_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;RubricRow.id&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">rubric_row</span><span class="p">:</span> <span class="s1">&#39;rubric_models.RubricRow&#39;</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;RubricRow&#39;</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">rubric_row_id</span><span class="p">,</span>
        <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">network_disabled</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;network_disabled&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">server_default</span><span class="o">=</span><span class="s1">&#39;FALSE&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">auto_test_set_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;auto_test_set_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;AutoTestSet.id&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">auto_test_set</span><span class="p">:</span> <span class="s1">&#39;AutoTestSet&#39;</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;AutoTestSet&#39;</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">auto_test_set_id</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;suites&#39;</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">,</span>
        <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">steps</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;AutoTestStepBase&quot;</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;suite&quot;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all,delete,delete-orphan&#39;</span><span class="p">,</span>
        <span class="n">order_by</span><span class="o">=</span><span class="s1">&#39;AutoTestStepBase.order&#39;</span>
    <span class="p">)</span>  <span class="c1"># type: t.MutableSequence[auto_test_step_models.AutoTestStepBase]</span>

    <span class="n">command_time_limit</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;command_time_limit&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>

<div class="viewcode-block" id="AutoTestSuite.get_instructions"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestSuite.get_instructions">[docs]</a>    <span class="k">def</span> <span class="nf">get_instructions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="s1">&#39;AutoTestRun&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">auto_test_module</span><span class="o">.</span><span class="n">SuiteInstructions</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the instructions to run this suite.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">show_hidden</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">run_hidden_steps</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="k">if</span> <span class="n">show_hidden</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">hidden</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;steps&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">get_instructions</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">],</span>
            <span class="s1">&#39;network_disabled&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_disabled</span><span class="p">,</span>
        <span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;steps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">,</span>
            <span class="s1">&#39;rubric_row&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rubric_row</span><span class="p">,</span>
            <span class="s1">&#39;network_disabled&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_disabled</span><span class="p">,</span>
            <span class="s1">&#39;command_time_limit&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_time_limit</span><span class="p">,</span>
        <span class="p">}</span>

<div class="viewcode-block" id="AutoTestSuite.set_steps"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestSuite.set_steps">[docs]</a>    <span class="k">def</span> <span class="nf">set_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="s1">&#39;psef.helpers.JSONType&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the steps of this suite.</span>

<span class="sd">        :param steps: The json data that should be parsed into the steps of</span>
<span class="sd">            this suite. They will be checked by this function.</span>
<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">step_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">psef</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_from_map_transaction</span><span class="p">(</span>
                <span class="n">psef</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">ensure_json_dict</span><span class="p">(</span><span class="n">step_data</span><span class="p">)</span>
            <span class="p">)</span> <span class="k">as</span> <span class="p">[</span><span class="n">get</span><span class="p">,</span> <span class="n">opt</span><span class="p">]:</span>

                <span class="n">step_id</span> <span class="o">=</span> <span class="n">opt</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="c1"># data gets validated in the `step.update_data_from_json`</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                <span class="n">typ_str</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="n">hidden</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
                    <span class="nb">float</span><span class="p">,</span>
                    <span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Real</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">step_type</span> <span class="o">=</span> <span class="n">auto_test_handlers</span><span class="p">[</span><span class="n">typ_str</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                    <span class="s1">&#39;The given test type is not valid&#39;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;The given test type &quot;</span><span class="si">{typ_str}</span><span class="s1">&quot; is not known&#39;</span><span class="p">,</span>
                    <span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_PARAM</span><span class="p">,</span> <span class="mi">400</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">step_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="n">step_type</span><span class="p">()</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="n">psef</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="n">step_type</span><span class="p">,</span> <span class="n">step_id</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">step_type</span><span class="p">)</span>

            <span class="n">step</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="n">hidden</span>
            <span class="n">step</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">idx</span>
            <span class="n">step</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="n">step</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>

            <span class="n">step</span><span class="o">.</span><span class="n">update_data_from_json</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">new_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="n">new_steps</span></div>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;AutoTestSuite&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">AutoTestSuite</span><span class="p">(</span>
            <span class="n">rubric_row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rubric_row</span><span class="p">,</span>
            <span class="n">network_disabled</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network_disabled</span><span class="p">,</span>
            <span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">],</span>
            <span class="n">command_time_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">command_time_limit</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AutoTestSet"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestSet">[docs]</a><span class="k">class</span> <span class="nc">AutoTestSet</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">TimestampMixin</span><span class="p">,</span> <span class="n">IdMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class represents a set (also known as level) of an AutoTest.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">ClassVar</span><span class="p">[</span><span class="n">MyQuery</span><span class="p">[</span><span class="s1">&#39;AutoTestSet&#39;</span><span class="p">]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;AutoTestSet&#39;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">stop_points</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;stop_points&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
    <span class="n">auto_test_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;auto_test_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;AutoTest.id&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">auto_test</span><span class="p">:</span> <span class="s1">&#39;AutoTest&#39;</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;AutoTest&#39;</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">auto_test_id</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;sets&#39;</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">,</span>
        <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">suites</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;AutoTestSuite&quot;</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;auto_test_set&quot;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all,delete,delete-orphan&#39;</span><span class="p">,</span>
        <span class="n">order_by</span><span class="o">=</span><span class="s1">&#39;AutoTestSuite.created_at&#39;</span>
    <span class="p">)</span>  <span class="c1"># type: t.MutableSequence[AutoTestSuite]</span>

<div class="viewcode-block" id="AutoTestSet.get_instructions"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestSet.get_instructions">[docs]</a>    <span class="k">def</span> <span class="nf">get_instructions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="s1">&#39;AutoTestRun&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">auto_test_module</span><span class="o">.</span><span class="n">SetInstructions</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the instructions to run this set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;suites&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">get_instructions</span><span class="p">(</span><span class="n">run</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">suites</span><span class="p">],</span>
            <span class="s1">&#39;stop_points&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_points</span><span class="p">,</span>
        <span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;suites&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">suites</span><span class="p">,</span>
            <span class="s1">&#39;stop_points&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_points</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;AutoTestSet&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">AutoTestSet</span><span class="p">(</span>
            <span class="n">suites</span><span class="o">=</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">suites</span><span class="p">],</span>
            <span class="n">stop_points</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_points</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AutoTestResult"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestResult">[docs]</a><span class="k">class</span> <span class="nc">AutoTestResult</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">TimestampMixin</span><span class="p">,</span> <span class="n">IdMixin</span><span class="p">,</span> <span class="n">NotEqualMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The result for a single submission (:class:`.work_models.Work`) of a</span>
<span class="sd">    :class:`.AutoTestRun`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;AutoTestResult&#39;</span>

    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">ClassVar</span><span class="p">[</span><span class="n">MyQuery</span><span class="p">[</span><span class="s1">&#39;AutoTestResult&#39;</span><span class="p">]]</span>

    <span class="n">auto_test_run_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;auto_test_run_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;AutoTestRun.id&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">run</span><span class="p">:</span> <span class="s1">&#39;AutoTestRun&#39;</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;AutoTestRun&#39;</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">auto_test_run_id</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;results&#39;</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;select&#39;</span><span class="p">,</span>
        <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">auto_test_runner_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;auto_test_runner_id&#39;</span><span class="p">,</span>
        <span class="n">UUIDType</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;AutoTestRunner.id&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">runner</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;AutoTestRunner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;AutoTestRunner&#39;</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">auto_test_runner_id</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;selectin&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">setup_stdout</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">deferred</span><span class="p">(</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
            <span class="s1">&#39;setup_stdout&#39;</span><span class="p">,</span>
            <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">started_at</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;started_at&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">setup_stderr</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">deferred</span><span class="p">(</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
            <span class="s1">&#39;setup_stderr&#39;</span><span class="p">,</span>
            <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">step_results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;AutoTestStepResult&#39;</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;result&#39;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all,delete,delete-orphan&#39;</span><span class="p">,</span>
        <span class="n">order_by</span><span class="o">=</span><span class="s1">&#39;AutoTestStepResult.created_at&#39;</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;selectin&#39;</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># type: t.MutableSequence[auto_test_step_models.AutoTestStepResult]</span>

    <span class="n">_state</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;state&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">auto_test_step_models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="n">auto_test_step_models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="o">.</span><span class="n">not_started</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">work_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;work_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Work.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">work</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;Work&#39;</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">work_id</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;selectin&#39;</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># type: work_models.Work</span>

    <span class="n">final_result</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;final_result&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># This variable is generated from the backref from all files</span>
    <span class="n">files</span><span class="p">:</span> <span class="n">MyQuery</span><span class="p">[</span><span class="s2">&quot;file_models.AutoTestOutputFile&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">AutoTestResult</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">auto_test_step_models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the state of this result</span>

<span class="sd">        &gt;&gt;&gt; called = False</span>
<span class="sd">        &gt;&gt;&gt; def fun(_):</span>
<span class="sd">        ...  global called</span>
<span class="sd">        ...  called = True</span>
<span class="sd">        &gt;&gt;&gt; psef.tasks.adjust_amount_runners = fun</span>
<span class="sd">        &gt;&gt;&gt; r = AutoTestResult(run=AutoTestRun())</span>
<span class="sd">        &gt;&gt;&gt; not_set = object()</span>
<span class="sd">        &gt;&gt;&gt; r.started_at = not_set</span>
<span class="sd">        &gt;&gt;&gt; r.state = auto_test_step_models.AutoTestStepResultState.running</span>
<span class="sd">        &gt;&gt;&gt; isinstance(r.started_at, datetime.datetime)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; called</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; r.state = 6</span>
<span class="sd">        &gt;&gt;&gt; r.started_at is None</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; r.started_at = not_set</span>
<span class="sd">        &gt;&gt;&gt; r.state = 6</span>
<span class="sd">        &gt;&gt;&gt; r.started_at is not_set</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>

    <span class="nd">@state</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">new_state</span><span class="p">:</span> <span class="n">auto_test_step_models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">new_state</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">new_state</span>
        <span class="k">if</span> <span class="n">new_state</span> <span class="o">==</span> <span class="n">auto_test_step_models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">started_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">adjust_amount_runners</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">new_state</span> <span class="ow">in</span>
            <span class="n">auto_test_step_models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="o">.</span><span class="n">get_finished_states</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_rubric</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">started_at</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">is_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Has this state passed?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span>
            <span class="n">auto_test_step_models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="o">.</span><span class="n">get_finished_states</span><span class="p">()</span>
        <span class="p">)</span>

<div class="viewcode-block" id="AutoTestResult.clear"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestResult.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Clear this result and set it state back to ``not_started``.</span>

<span class="sd">        .. note:: This also clears the rubric</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">auto_test_step_models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="o">.</span><span class="n">not_started</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_stderr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_stdout</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_result</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_rubric</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">get_locked_work</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;work_models.Work&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">work_id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">with_for_update</span><span class="p">(</span><span class="n">of</span><span class="o">=</span><span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>

<div class="viewcode-block" id="AutoTestResult.clear_rubric"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestResult.clear_rubric">[docs]</a>    <span class="k">def</span> <span class="nf">clear_rubric</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Clear all the rubric categories connected to this AutoTest for this</span>
<span class="sd">        result.</span>

<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locked_work</span><span class="p">()</span>
        <span class="n">own_rubric_rows</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">suite</span><span class="o">.</span><span class="n">rubric_row_id</span> <span class="k">for</span> <span class="n">suite</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">auto_test</span><span class="o">.</span><span class="n">all_suites</span>
        <span class="p">)</span>

        <span class="n">work</span><span class="o">.</span><span class="n">selected_items</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">work</span><span class="o">.</span><span class="n">selected_items</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">rubricrow_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">own_rubric_rows</span>
        <span class="p">]</span>
        <span class="n">work</span><span class="o">.</span><span class="n">set_grade</span><span class="p">(</span><span class="n">grade_origin</span><span class="o">=</span><span class="n">work_models</span><span class="o">.</span><span class="n">GradeOrigin</span><span class="o">.</span><span class="n">auto_test</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutoTestResult.update_rubric"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestResult.update_rubric">[docs]</a>    <span class="k">def</span> <span class="nf">update_rubric</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update the rubric of the connected submission according to this</span>
<span class="sd">        AutoTest result.</span>

<span class="sd">        .. note:: This might pass back the grade to the LMS if required.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Lock the work we want to update,</span>
        <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locked_work</span><span class="p">()</span>
        <span class="n">old_selected_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">selected_items</span><span class="p">)</span>
        <span class="n">new_items</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="o">.</span><span class="n">rubricrow_id</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">work</span><span class="o">.</span><span class="n">selected_items</span><span class="p">}</span>
        <span class="n">changed_item</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">suite</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">auto_test</span><span class="o">.</span><span class="n">all_suites</span><span class="p">:</span>
            <span class="n">got</span><span class="p">,</span> <span class="n">possible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_amount_points_in_suites</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>
            <span class="n">percentage</span> <span class="o">=</span> <span class="n">got</span> <span class="o">/</span> <span class="n">possible</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">suite</span><span class="o">.</span><span class="n">rubric_row</span><span class="o">.</span><span class="n">items</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">auto_test</span><span class="o">.</span><span class="n">grade_calculator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">new_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">auto_test</span><span class="o">.</span><span class="n">grade_calculator</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">percentage</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">new_item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old_selected_items</span><span class="p">:</span>
                <span class="n">new_items</span><span class="p">[</span><span class="n">suite</span><span class="o">.</span><span class="n">rubric_row_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_item</span>
                <span class="n">changed_item</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">changed_item</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">work</span><span class="o">.</span><span class="n">selected_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_items</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">work</span><span class="o">.</span><span class="n">set_grade</span><span class="p">(</span><span class="n">grade_origin</span><span class="o">=</span><span class="n">work_models</span><span class="o">.</span><span class="n">GradeOrigin</span><span class="o">.</span><span class="n">auto_test</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutoTestResult.get_amount_points_in_suites"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestResult.get_amount_points_in_suites">[docs]</a>    <span class="k">def</span> <span class="nf">get_amount_points_in_suites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">suites</span><span class="p">:</span> <span class="s1">&#39;AutoTestSuite&#39;</span>
                                    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the amount of points in the given suites, and how many points</span>
<span class="sd">        where achieved.</span>

<span class="sd">        :param suites: The suites to calculate the amount of points for.</span>
<span class="sd">        :returns: A tuple where the first value is the amount of points</span>
<span class="sd">            achieved in the given suites, and the second value is the amount of</span>
<span class="sd">            points possible in the given suites.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">suite</span><span class="o">.</span><span class="n">steps</span> <span class="k">for</span> <span class="n">suite</span> <span class="ow">in</span> <span class="n">suites</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">step_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">)</span>
        <span class="n">possible</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">weight</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">)</span>
        <span class="n">achieved</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">step_result</span><span class="o">.</span><span class="n">achieved_points</span> <span class="k">for</span> <span class="n">step_result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_results</span>
            <span class="k">if</span> <span class="n">step_result</span><span class="o">.</span><span class="n">auto_test_step_id</span> <span class="ow">in</span> <span class="n">step_ids</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">achieved</span><span class="p">,</span> <span class="n">possible</span></div>

    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Convert this result to a json object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">points_achieved</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_amount_points_in_suites</span><span class="p">(</span>
            <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">auto_test</span><span class="o">.</span><span class="n">all_suites</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;started_at&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">started_at</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">started_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;work_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_id</span><span class="p">,</span>
            <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;points_achieved&#39;</span><span class="p">:</span> <span class="n">points_achieved</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__extended_to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="n">approx_before</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span>
            <span class="n">auto_test_step_models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="o">.</span><span class="n">not_started</span>
        <span class="p">):</span>
            <span class="n">approx_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">get_results_to_run</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">AutoTestResult</span><span class="o">.</span><span class="n">created_at</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span>
            <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="n">step_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_results</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">auth</span><span class="o">.</span><span class="n">ensure_can_see_grade</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">PermissionException</span><span class="p">:</span>
            <span class="n">step_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">step_results</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">hidden</span><span class="p">]</span>
            <span class="n">final_result</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_result</span>

        <span class="n">suite_files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">assig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">auto_test</span><span class="o">.</span><span class="n">assignment</span>
        <span class="k">if</span> <span class="n">assig</span><span class="o">.</span><span class="n">is_done</span> <span class="ow">or</span> <span class="n">psef</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span>
            <span class="n">CPerm</span><span class="o">.</span><span class="n">can_view_autotest_output_files_before_done</span><span class="p">,</span> <span class="n">assig</span><span class="o">.</span><span class="n">course_id</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">parent_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="n">entries</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">list_contents</span><span class="p">()</span><span class="o">.</span><span class="n">entries</span>
                <span class="k">if</span> <span class="n">entries</span><span class="p">:</span>
                    <span class="n">suite_files</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">auto_test_suite_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">entries</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">__to_json__</span><span class="p">(),</span>
            <span class="s1">&#39;setup_stdout&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_stdout</span><span class="p">,</span>
            <span class="s1">&#39;setup_stderr&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_stderr</span><span class="p">,</span>
            <span class="s1">&#39;step_results&#39;</span><span class="p">:</span> <span class="n">step_results</span><span class="p">,</span>
            <span class="s1">&#39;approx_waiting_before&#39;</span><span class="p">:</span> <span class="n">approx_before</span><span class="p">,</span>
            <span class="s1">&#39;final_result&#39;</span><span class="p">:</span> <span class="n">final_result</span><span class="p">,</span>
            <span class="s1">&#39;suite_files&#39;</span><span class="p">:</span> <span class="n">suite_files</span><span class="p">,</span>
        <span class="p">}</span>

<div class="viewcode-block" id="AutoTestResult.get_results_by_user"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestResult.get_results_by_user">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_results_by_user</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">student_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MyQuery[AutoTestResult]&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the :class:`.AutoTestResult` s for the given student.</span>

<span class="sd">        :returns: A query that gets all results by the given user. Notice that</span>
<span class="sd">            these results are for all :class:`.AutoTestRun` s.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="bp">cls</span><span class="o">.</span><span class="n">work_id</span><span class="p">)</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                                 <span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">student_id</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="AutoTestRunner"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestRunner">[docs]</a><span class="k">class</span> <span class="nc">AutoTestRunner</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">TimestampMixin</span><span class="p">,</span> <span class="n">UUIDMixin</span><span class="p">,</span> <span class="n">NotEqualMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class represents the runner of a :class:`.AutoTestRun`.</span>

<span class="sd">    A single run might have multiple runners, as a runner might crash and in</span>
<span class="sd">    this case it is replaced by a new runner.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">ClassVar</span><span class="p">[</span><span class="n">MyQuery</span><span class="p">[</span><span class="s1">&#39;AutoTestRunner&#39;</span><span class="p">]]</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;AutoTestRunner&#39;</span>

    <span class="n">_ipaddr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;ipaddr&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">last_heartbeat</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;last_heartbeat&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span>
    <span class="p">)</span>

    <span class="n">_job_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;job_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>

    <span class="n">run_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;run_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;AutoTestRun.id&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">run</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;AutoTestRun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;AutoTestRun&#39;</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">run_id</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;runners&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">AutoTestRunner</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">job_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the job id of this runner.</span>

<span class="sd">        &gt;&gt;&gt; AutoTestRunner().job_id.startswith(&#39;INVALID-&#39;)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; AutoTestRunner(_job_id=&#39;hello&#39;).job_id</span>
<span class="sd">        &#39;hello&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_id</span> <span class="ow">or</span> <span class="sa">f</span><span class="s1">&#39;INVALID-{uuid.uuid4().hex}&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ipaddr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The ip address of this runner.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ipaddr</span>

<div class="viewcode-block" id="AutoTestRunner.create"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestRunner.create">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">ipaddr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">run</span><span class="p">:</span> <span class="s1">&#39;AutoTestRun&#39;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;AutoTestRunner&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create an :class:`.AutoTestRunner`.</span>

<span class="sd">        :param ipdaddr: The ip address of this runner.</span>
<span class="sd">        :param run: The run of this runner.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">_ipaddr</span><span class="o">=</span><span class="n">ipaddr</span><span class="p">,</span> <span class="n">_job_id</span><span class="o">=</span><span class="n">run</span><span class="o">.</span><span class="n">get_job_id</span><span class="p">(),</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AutoTestRun"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestRun">[docs]</a><span class="k">class</span> <span class="nc">AutoTestRun</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">TimestampMixin</span><span class="p">,</span> <span class="n">IdMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class represents a single run of an AutoTest configuration.</span>

<span class="sd">    At the moment each AutoTest will always only have one AutoTestRun.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;AutoTestRun&#39;</span>

    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">ClassVar</span><span class="p">[</span><span class="n">MyQuery</span><span class="p">[</span><span class="s1">&#39;AutoTestRun&#39;</span><span class="p">]]</span>

    <span class="n">auto_test_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;auto_test_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;AutoTest.id&#39;</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">setup_stdout</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">deferred</span><span class="p">(</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
            <span class="s1">&#39;setup_stdout&#39;</span><span class="p">,</span>
            <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">setup_stderr</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">deferred</span><span class="p">(</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
            <span class="s1">&#39;setup_stderr&#39;</span><span class="p">,</span>
            <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">runners</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="s1">&#39;AutoTestRunner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;AutoTestRunner&#39;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;run&#39;</span>
    <span class="p">)</span>

    <span class="n">auto_test</span><span class="p">:</span> <span class="s1">&#39;AutoTest&#39;</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;AutoTest&#39;</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">auto_test_id</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;_runs&#39;</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">,</span>
        <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;AutoTestResult&#39;</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;run&#39;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all,delete&#39;</span><span class="p">,</span>
        <span class="n">order_by</span><span class="o">=</span><span class="s1">&#39;AutoTestResult.created_at&#39;</span>
    <span class="p">)</span>  <span class="c1"># type: t.MutableSequence[AutoTestResult]</span>

    <span class="n">started_date</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;started_date&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>

    <span class="n">kill_date</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;kill_date&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>

    <span class="n">_job_number</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;job_number&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">_job_id</span><span class="p">:</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;job_id&#39;</span><span class="p">,</span> <span class="n">UUIDType</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">)</span>

    <span class="n">runners_requested</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;runners_requested&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">server_default</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">batch_run_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;batch_run_done&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">run_hidden_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Should we run the hidden steps of this run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the batch run is done we must make sure that all future runners</span>
        <span class="c1"># will execute the hidden steps, as otherwise they might not get</span>
        <span class="c1"># executed. See the method `make_result` for more explanation.</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_run_done</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_test</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">deadline_expired</span>
        <span class="p">)</span>

<div class="viewcode-block" id="AutoTestRun.increment_job_id"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestRun.increment_job_id">[docs]</a>    <span class="k">def</span> <span class="nf">increment_job_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Increment the job id of this runner.</span>

<span class="sd">        This should be done when creating a new runner for this run, so we can</span>
<span class="sd">        track each runner by this id. This is different from creating a</span>
<span class="sd">        completely new job id, as this will make sure we keep the same base job</span>
<span class="sd">        id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cur_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_number</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_job_number</span> <span class="o">=</span> <span class="n">cur_number</span> <span class="o">+</span> <span class="mi">1</span></div>

    <span class="k">def</span> <span class="nf">get_job_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{self._job_id.hex}</span><span class="s1">-{self._job_number or 0}&#39;</span>

<div class="viewcode-block" id="AutoTestRun.stop_runners"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestRun.stop_runners">[docs]</a>    <span class="k">def</span> <span class="nf">stop_runners</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runners</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">AutoTestRunner</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Stop the given runners of this run.</span>

<span class="sd">        This function also stops the entire job at the broker if needed, or</span>
<span class="sd">        adjust the amount of runners requested at the broker, if needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">runner</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runners</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">runners</span><span class="p">)</span>
        <span class="n">all_deleted</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">runners</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runners</span><span class="p">)</span>
        <span class="n">any_cleared</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">runners</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runners</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">runner</span><span class="p">)</span>
            <span class="n">runner</span><span class="o">.</span><span class="n">run_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># This function has side effects so make sure short circuiting</span>
            <span class="c1"># doesn&#39;t cause the function not to be called.</span>
            <span class="n">cleared</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clear_non_passed_results</span><span class="p">(</span><span class="n">runner</span><span class="p">)</span>
            <span class="n">any_cleared</span> <span class="o">=</span> <span class="n">cleared</span> <span class="ow">or</span> <span class="n">any_cleared</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">any_results_left</span> <span class="o">=</span> <span class="n">any_cleared</span> <span class="ow">or</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_results_to_run</span><span class="p">()</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">False</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Killed runners&#39;</span><span class="p">,</span>
            <span class="n">all_deleted</span><span class="o">=</span><span class="n">all_deleted</span><span class="p">,</span>
            <span class="n">any_results_left</span><span class="o">=</span><span class="n">any_results_left</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">all_deleted</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">any_results_left</span><span class="p">:</span>
            <span class="c1"># We don&#39;t need to kill each individual runner, as the end of job</span>
            <span class="c1"># will kill all associated runners.</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job_id</span><span class="p">()</span>
            <span class="n">callback_after_this_request</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">notify_broker_end_of_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runners_requested</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">increment_job_id</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">to_kill</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">hex</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">runners</span><span class="p">]</span>
            <span class="n">run_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
            <span class="n">callback_after_this_request</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">kill_runners_and_adjust</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">to_kill</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">any_results_left</span></div>

<div class="viewcode-block" id="AutoTestRun.get_broker_metadata"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestRun.get_broker_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_broker_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get metadata that is useful for the broker of this run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_test</span><span class="o">.</span><span class="n">assignment</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;course&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">assig</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">assig</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;assignment&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">assig</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">assig</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;NS&#39;</span><span class="p">,</span>  <span class="c1"># NS=NewStyle</span>
        <span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">_clear_non_passed_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runner</span><span class="p">:</span> <span class="n">AutoTestRunner</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Clear all results of the given ``runner`` that are not yet finished.</span>

<span class="sd">        :param runner: The runner to clear the non finished results of.</span>
<span class="sd">        :returns: ``True`` if any results where cleared, ``False`` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">any_cleared</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">runner</span> <span class="o">==</span> <span class="n">runner</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">is_finished</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">any_cleared</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">any_cleared</span>

<div class="viewcode-block" id="AutoTestRun.get_amount_needed_runners"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestRun.get_amount_needed_runners">[docs]</a>    <span class="k">def</span> <span class="nf">get_amount_needed_runners</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the amount of runners this run needs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">amount_not_done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results_to_run</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
            <span class="n">amount_not_done</span> <span class="o">/</span> <span class="n">psef</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;AUTO_TEST_MAX_JOBS_PER_RUNNER&#39;</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AutoTestRun.get_runs_that_need_runners"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestRun.get_runs_that_need_runners">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_runs_that_need_runners</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="s1">&#39;AutoTestRun&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get all runs that need more runners.</span>

<span class="sd">        This function gets all runs that have fewer runners than they should,</span>
<span class="sd">        which is calculated using the amount of results that have not yet</span>
<span class="sd">        started.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ARR</span> <span class="o">=</span> <span class="n">AutoTestRunner</span>
        <span class="n">ARS</span> <span class="o">=</span> <span class="n">AutoTestResult</span>

        <span class="n">amount_results</span> <span class="o">=</span> <span class="n">sql_func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">distinct</span><span class="p">(</span><span class="n">ARS</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="n">amount_runners</span> <span class="o">=</span> <span class="n">sql_func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">distinct</span><span class="p">(</span><span class="n">ARR</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

        <span class="n">runs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">ARS</span><span class="p">,</span>
            <span class="n">and_</span><span class="p">(</span>
                <span class="n">ARS</span><span class="o">.</span><span class="n">auto_test_run_id</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">ARS</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span>  <span class="c1"># pylint: disable=protected-access</span>
                    <span class="n">auto_test_step_models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="o">.</span><span class="n">not_started</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">ARR</span><span class="p">,</span>
            <span class="n">ARR</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">isouter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">having</span><span class="p">(</span>
            <span class="n">or_</span><span class="p">(</span>
                <span class="n">amount_runners</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">amount_results</span> <span class="o">/</span> <span class="n">amount_runners</span> <span class="o">&gt;</span>
                <span class="n">psef</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;AUTO_TEST_MAX_JOBS_PER_RUNNER&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
            <span class="n">nullsfirst</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">amount_results</span> <span class="o">/</span> <span class="n">case</span><span class="p">(</span>
                        <span class="p">[(</span><span class="n">amount_runners</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)],</span>
                        <span class="n">else_</span><span class="o">=</span><span class="n">amount_runners</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">noload</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">auto_test</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">runs</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>

<div class="viewcode-block" id="AutoTestRun.get_results_latest_submissions"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestRun.get_results_latest_submissions">[docs]</a>    <span class="k">def</span> <span class="nf">get_results_latest_submissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MyQuery</span><span class="p">[</span><span class="n">AutoTestResult</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the results for the latest submissions.</span>

<span class="sd">        :returns: A query that returns the results for the latest submissions</span>
<span class="sd">            of the connected assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">latest_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_test</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">get_from_latest_submissions</span><span class="p">(</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">AutoTestResult</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="n">auto_test_run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">AutoTestResult</span><span class="o">.</span><span class="n">work_id</span><span class="p">)</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">latest_ids</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">AutoTestResult</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutoTestRun.get_results_to_run"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestRun.get_results_to_run">[docs]</a>    <span class="k">def</span> <span class="nf">get_results_to_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MyQuery</span><span class="p">[</span><span class="n">AutoTestResult</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get a query to get the :py:class:`.AutoTestResult` items that still</span>
<span class="sd">            need to be run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results_latest_submissions</span><span class="p">()</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="n">_state</span><span class="o">=</span><span class="n">auto_test_step_models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="o">.</span><span class="n">not_started</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AutoTestRun.add_active_runner"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestRun.add_active_runner">[docs]</a>    <span class="k">def</span> <span class="nf">add_active_runner</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">runner_ipaddr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AutoTestRunner</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Start this run.</span>

<span class="sd">        This means setting the ``started_date``, creating a runner object for</span>
<span class="sd">        this run, and scheduling some tasks that will kill the runner after</span>
<span class="sd">        some period of time.</span>

<span class="sd">        .. note::</span>

<span class="sd">            To start an entire run you should use :meth:`.AutoTest.start_run`.</span>

<span class="sd">        :param runner_ipaddr: The ip address of the runner that will perform</span>
<span class="sd">            this run. This is used for authentication purposes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This run was not started before this runner, so set all the auxiliary</span>
        <span class="c1"># data.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">started_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">started_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            <span class="c1"># Continuous feedback runs don&#39;t get killed because of time, so</span>
            <span class="c1"># don&#39;t set this data.</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="n">AutoTestRunner</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">runner_ipaddr</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">runner</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">runner_hex_id</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">hex</span>

        <span class="nd">@psef</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">callback_after_this_request</span>
        <span class="k">def</span> <span class="nf">__start_tasks</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">check_heartbeat_auto_test_run</span><span class="p">((</span><span class="n">runner_hex_id</span><span class="p">,</span> <span class="p">))</span>

        <span class="k">return</span> <span class="n">runner</span></div>

<div class="viewcode-block" id="AutoTestRun.get_instructions"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestRun.get_instructions">[docs]</a>    <span class="k">def</span> <span class="nf">get_instructions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">for_runner</span><span class="p">:</span> <span class="n">AutoTestRunner</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">auto_test_module</span><span class="o">.</span><span class="n">RunnerInstructions</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the instructions to run this AutoTestRun.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results_to_run</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;runner_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">for_runner</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
            <span class="s1">&#39;run_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;auto_test_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_test_id</span><span class="p">,</span>
            <span class="s1">&#39;result_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span>
            <span class="s1">&#39;student_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">user_id</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span>
            <span class="s1">&#39;sets&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">get_instructions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_test</span><span class="o">.</span><span class="n">sets</span><span class="p">],</span>
            <span class="s1">&#39;fixtures&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_test</span><span class="o">.</span><span class="n">fixtures</span><span class="p">],</span>
            <span class="s1">&#39;setup_script&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_test</span><span class="o">.</span><span class="n">setup_script</span><span class="p">,</span>
            <span class="s1">&#39;heartbeat_interval&#39;</span><span class="p">:</span>
                <span class="n">psef</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;AUTO_TEST_HEARTBEAT_INTERVAL&#39;</span><span class="p">],</span>
            <span class="s1">&#39;run_setup_script&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_test</span><span class="o">.</span><span class="n">run_setup_script</span><span class="p">,</span>
            <span class="c1"># TODO: Set this in a more intelligent way</span>
            <span class="s1">&#39;poll_after_done&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="s1">&#39;running&#39;</span><span class="p">,</span>
            <span class="s1">&#39;is_continuous&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__extended_to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">all_results</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">AutoTestResult</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">psef</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">jsonify_options</span><span class="o">.</span><span class="n">get_options</span><span class="p">()</span><span class="o">.</span><span class="n">latest_only</span><span class="p">:</span>
            <span class="n">all_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results_latest_submissions</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">deleted</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">all_results</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">auth</span><span class="o">.</span><span class="n">ensure_can_view_autotest_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">PermissionException</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="c1"># TODO: Check permissions for setup_stdout/setup_stderr</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">__to_json__</span><span class="p">(),</span>
            <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
            <span class="s1">&#39;setup_stdout&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_stdout</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;setup_stderr&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_stderr</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">}</span>

<div class="viewcode-block" id="AutoTestRun.delete_and_clear_rubric"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestRun.delete_and_clear_rubric">[docs]</a>    <span class="k">def</span> <span class="nf">delete_and_clear_rubric</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Delete this AutoTestRun and clear all the results and rubrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">clear_rubric</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">new_results_should_be_final</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Should new results (or newly clear results) be final results.</span>

<span class="sd">        :returns: The result should the value of ``final_result`` of the</span>
<span class="sd">            :class:`.AutoTestResult`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_run_done</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_test</span><span class="o">.</span><span class="n">has_hidden_steps</span>

<div class="viewcode-block" id="AutoTestRun.make_result"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestRun.make_result">[docs]</a>    <span class="k">def</span> <span class="nf">make_result</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">work_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;work_models.Work&#39;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AutoTestResult</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Make a result for this run.</span>

<span class="sd">        :param work_id: The work, or its id, for which we should make a result.</span>
<span class="sd">        :returns: The created result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Setting `final_result` here is a bit tricky. We know we can start</span>
        <span class="c1"># making final results when the deadline expired. However, there might</span>
        <span class="c1"># be a runner active that was started **before** the deadline, so this</span>
        <span class="c1"># runner didn&#39;t receive the hidden steps. This runner might run this</span>
        <span class="c1"># final result before it is stopped (as there can be quite a</span>
        <span class="c1"># significant delay before the _run_autotest_batch_runs_1 celery task</span>
        <span class="c1"># is executed), and the result would be the hidden steps are not yet</span>
        <span class="c1"># run. So for the moment we simply set it to the value of</span>
        <span class="c1"># `batch_run_done`, as we know that all runners have the hidden steps</span>
        <span class="c1"># if this value is `True`. Finally, if a test does not have hidden</span>
        <span class="c1"># steps, we always execute the complete test, so we can simply</span>
        <span class="c1"># `final_result` to `True`.</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">work_id</span><span class="p">,</span> <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">AutoTestResult</span><span class="p">(</span>
                <span class="n">work</span><span class="o">=</span><span class="n">work_id</span><span class="p">,</span>
                <span class="n">auto_test_run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">final_result</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">new_results_should_be_final</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">AutoTestResult</span><span class="p">(</span>
            <span class="n">work_id</span><span class="o">=</span><span class="n">work_id</span><span class="p">,</span>
            <span class="n">auto_test_run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">final_result</span><span class="o">=</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">batch_run_done</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_test</span><span class="o">.</span><span class="n">has_hidden_steps</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AutoTestRun.do_batch_run"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTestRun.do_batch_run">[docs]</a>    <span class="k">def</span> <span class="nf">do_batch_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Do the batch run for this run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_test</span><span class="o">.</span><span class="n">has_hidden_steps</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Doing batch run&#39;</span><span class="p">,</span> <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">has_hidden_steps</span><span class="o">=</span><span class="n">hidden</span><span class="p">)</span>
        <span class="c1"># We do not need to clear if the config has no hidden steps, are</span>
        <span class="c1"># already run in this case.</span>
        <span class="k">if</span> <span class="n">hidden</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results_latest_submissions</span><span class="p">():</span>
                <span class="n">result</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">result</span><span class="o">.</span><span class="n">final_result</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="c1"># This also starts new runners if needed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_runners</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runners</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">batch_run_done</span> <span class="o">=</span> <span class="kc">True</span></div></div>


<span class="nd">@auto_test_grade_calculators</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_full_grade_calculator</span><span class="p">(</span>
    <span class="n">items</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="s1">&#39;rubric_models.RubricItem&#39;</span><span class="p">],</span> <span class="n">percentage</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;rubric_models.RubricItem&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate a grade based on the ``full`` policy.</span>

<span class="sd">    &gt;&gt;&gt; _full_grade_calculator([0,1,2,3], 0.25)</span>
<span class="sd">    0</span>
<span class="sd">    &gt;&gt;&gt; _full_grade_calculator([0,1,2,3], 0.5)</span>
<span class="sd">    1</span>
<span class="sd">    &gt;&gt;&gt; _full_grade_calculator([0,1,2,3], 0.75)</span>
<span class="sd">    2</span>
<span class="sd">    &gt;&gt;&gt; _full_grade_calculator([0,1,2,3], 1)</span>
<span class="sd">    3</span>
<span class="sd">    &gt;&gt;&gt; _full_grade_calculator([0,1,2,3], 0.9)</span>
<span class="sd">    2</span>
<span class="sd">    &gt;&gt;&gt; _full_grade_calculator([0,1,2,3], 0)</span>
<span class="sd">    0</span>
<span class="sd">    &gt;&gt;&gt; _full_grade_calculator([0,1,2,3], 0.1)</span>
<span class="sd">    0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">*</span> <span class="n">percentage</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>


<span class="nd">@auto_test_grade_calculators</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;partial&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_partial_grade_calculator</span><span class="p">(</span>
    <span class="n">items</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="s1">&#39;rubric_models.RubricItem&#39;</span><span class="p">],</span> <span class="n">percentage</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;rubric_models.RubricItem&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate a grade based on the ``partial`` policy.</span>

<span class="sd">    &gt;&gt;&gt; _partial_grade_calculator([0,1,2,3], 1)</span>
<span class="sd">    3</span>
<span class="sd">    &gt;&gt;&gt; _partial_grade_calculator([0,1,2,3], 0.9)</span>
<span class="sd">    3</span>
<span class="sd">    &gt;&gt;&gt; _partial_grade_calculator([0,1,2,3], 0)</span>
<span class="sd">    0</span>
<span class="sd">    &gt;&gt;&gt; _partial_grade_calculator([0,1,2,3], 0.1)</span>
<span class="sd">    0</span>
<span class="sd">    &gt;&gt;&gt; _partial_grade_calculator([0,1,2,3], 0.25)</span>
<span class="sd">    1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">*</span> <span class="n">percentage</span><span class="p">))]</span>


<div class="viewcode-block" id="AutoTest"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTest">[docs]</a><span class="k">class</span> <span class="nc">AutoTest</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">TimestampMixin</span><span class="p">,</span> <span class="n">IdMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class represents a auto test.</span>

<span class="sd">    A group set is a single wrapper over all groups. Every group is part of a</span>
<span class="sd">    group set. The group set itself is connected to a single course and zero or</span>
<span class="sd">    more assignments in this course.</span>

<span class="sd">    :ivar minimum_size: The minimum size of that group should have before it</span>
<span class="sd">        can be used to submit a submission.</span>
<span class="sd">    :ivar maximum_size: The maximum amount of members a group can ever have.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">ClassVar</span><span class="p">[</span><span class="n">MyQuery</span><span class="p">[</span><span class="s1">&#39;AutoTest&#39;</span><span class="p">]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;AutoTest&#39;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">assignment</span><span class="p">:</span> <span class="s1">&#39;assignment_models.Assignment&#39;</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;Assignment&#39;</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;auto_test&#39;</span><span class="p">,</span>
        <span class="n">innerjoin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">uselist</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">sets</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;AutoTestSet&quot;</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;auto_test&quot;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all,delete,delete-orphan&#39;</span><span class="p">,</span>
        <span class="n">order_by</span><span class="o">=</span><span class="s1">&#39;AutoTestSet.created_at&#39;</span>
    <span class="p">)</span>  <span class="c1"># type: t.MutableSequence[AutoTestSet]</span>

    <span class="n">_runs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;AutoTestRun&quot;</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;auto_test&quot;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all,delete,delete-orphan&#39;</span><span class="p">,</span>
        <span class="n">order_by</span><span class="o">=</span><span class="s1">&#39;AutoTestRun.created_at&#39;</span>
    <span class="p">)</span>  <span class="c1"># type: t.MutableSequence[AutoTestRun]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">AutoTestRun</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The final run of this AutoTest.</span>

<span class="sd">        :returns: The final run of this AutoTest or ``None`` if there is none.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_all_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">AutoTestRun</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span>

    <span class="n">fixtures</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;AutoTestFixture&#39;</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;auto_test&quot;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all,delete&#39;</span><span class="p">,</span>
        <span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;AutoTestFixture.name&quot;</span>
    <span class="p">)</span>  <span class="c1"># type: t.MutableSequence[file_models.AutoTestFixture]</span>

    <span class="n">setup_script</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;setup_script&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="p">)</span>
    <span class="n">run_setup_script</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;run_setup_script&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="p">)</span>
    <span class="n">finalize_script</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;finalize_script&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="p">)</span>

    <span class="n">_grade_calculation</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;grade_calculation&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span>
            <span class="o">*</span><span class="n">auto_test_grade_calculators</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;grade_calculation_enum&#39;</span>
        <span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">results_always_visible</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;results_always_visible&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

<div class="viewcode-block" id="AutoTest.ensure_no_runs"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTest.ensure_no_runs">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_no_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Ensure that this AutoTest has no runs.</span>

<span class="sd">        :raises APIException: If the AutoTest has one or more runs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                <span class="s1">&#39;You cannot update an AutoTest which has runs&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;The given AutoTest &quot;</span><span class="si">{self.id}</span><span class="s1">&quot; has a run&#39;</span><span class="p">,</span>
                <span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_STATE</span><span class="p">,</span> <span class="mi">409</span>
            <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">grade_calculator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">GradeCalculator</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the grade calculator for this AutoTest.</span>

<span class="sd">        &gt;&gt;&gt; AutoTest().grade_calculator is None</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grade_calculation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">auto_test_grade_calculators</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_grade_calculation</span><span class="p">)</span>

    <span class="nd">@grade_calculator</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">grade_calculator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_val</span><span class="p">:</span> <span class="n">GradeCalculator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the grade calculator for this AutoTest.</span>

<span class="sd">        This should be a registered grade calculator.</span>

<span class="sd">        :param new_val: The new grade calculator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">auto_test_grade_calculators</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">new_val</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grade_calculation</span> <span class="o">=</span> <span class="n">key</span>

    <span class="k">def</span> <span class="nf">_ensure_can_start_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grade_calculator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidStateException</span><span class="p">(</span>
                <span class="s1">&#39;This AutoTest has no grade_calculation set, but this options&#39;</span>
                <span class="s1">&#39; is required.&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_always_visible</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidStateException</span><span class="p">(</span>
                <span class="s1">&#39;This AutoTest does not have a results_always_visible set, but&#39;</span>
                <span class="s1">&#39; this option is required&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sets</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidStateException</span><span class="p">(</span>
                <span class="s1">&#39;This AutoTest has no sets, so it cannot be started&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_suites</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidStateException</span><span class="p">(</span>
                <span class="s1">&#39;This AutoTest has no suites, so it cannot be started&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">steps</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_suites</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidStateException</span><span class="p">(</span>
                <span class="s1">&#39;This AutoTest has no steps in some suites, so it cannot be&#39;</span>
                <span class="s1">&#39; started&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">weight</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_suites</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidStateException</span><span class="p">(</span>
                <span class="s1">&#39;This AutoTest has zero amount of points possible in some&#39;</span>
                <span class="s1">&#39; suites, so it cannot be started&#39;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="AutoTest.start_test_run"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTest.start_test_run">[docs]</a>    <span class="k">def</span> <span class="nf">start_test_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AutoTestRun</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Start this AutoTest run.</span>

<span class="sd">        This function checks if the AutoTest is in a state where a run can be</span>
<span class="sd">        started, and if this is the case it starts the run. It also schedules a</span>
<span class="sd">        task to notify our broker that we need a runner. The changes to the</span>
<span class="sd">        database are not committed!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_can_start_run</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                <span class="s1">&#39;You cannot start an AutoTest which has runs&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;The given AutoTest &quot;</span><span class="si">{self.id}</span><span class="s1">&quot; has a run&#39;</span><span class="p">,</span>
                <span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_STATE</span><span class="p">,</span> <span class="mi">409</span>
            <span class="p">)</span>

        <span class="n">run</span> <span class="o">=</span> <span class="n">AutoTestRun</span><span class="p">(</span>
            <span class="n">batch_run_done</span><span class="o">=</span><span class="p">(</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_hidden_steps</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">deadline_expired</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="n">work_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">get_from_latest_submissions</span><span class="p">(</span>
            <span class="n">work_models</span><span class="o">.</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">run</span><span class="o">.</span><span class="n">make_result</span><span class="p">(</span><span class="n">work_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">work_id</span><span class="p">,</span> <span class="ow">in</span> <span class="n">work_ids</span><span class="p">]</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">bulk_save_objects</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">callback_after_this_request</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">notify_broker_of_new_job</span><span class="p">(</span>
                    <span class="n">run</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">get_amount_needed_runners</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">run</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_hidden_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Are there hidden steps in this AutoTest.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
            <span class="nb">any</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">hidden</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">suite</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">suite</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_suites</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_suites</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterator</span><span class="p">[</span><span class="n">AutoTestSuite</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get all the suites from this AutoTest as an iterator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">suites</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sets</span><span class="p">)</span>

<div class="viewcode-block" id="AutoTest.add_to_run"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTest.add_to_run">[docs]</a>    <span class="k">def</span> <span class="nf">add_to_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">:</span> <span class="s1">&#39;work_models.Work&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add the given work to the continuous feedback run.</span>

<span class="sd">        This function only does something if there is an continuous feedback</span>
<span class="sd">        run.</span>

<span class="sd">        :param work: The work to add to the continuous feedback run.</span>
<span class="sd">        :returns: ``True`` if the work was added to the continuous feedback</span>
<span class="sd">            run.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            This function changes the session if it returns ``True``, so a</span>
<span class="sd">            commit is necessary in that case.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span>
        <span class="k">if</span> <span class="n">run</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">run_id</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">id</span>
        <span class="n">AutoTestResult</span><span class="o">.</span><span class="n">get_results_by_user</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">AutoTestResult</span><span class="o">.</span><span class="n">auto_test_run_id</span> <span class="o">==</span> <span class="n">run</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">object</span><span class="p">],</span> <span class="n">AutoTestResult</span><span class="o">.</span><span class="n">state</span><span class="p">)</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span>
                <span class="n">auto_test_step_models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="o">.</span>
                <span class="n">get_not_finished_states</span><span class="p">()</span>
            <span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">,</span> <span class="n">AutoTestResult</span><span class="o">.</span><span class="n">state</span><span class="p">):</span>
                    <span class="n">auto_test_step_models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="o">.</span><span class="n">skipped</span><span class="p">,</span>
            <span class="p">},</span> <span class="kc">False</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">callbacks</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">adjust_amount_runners</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">update_latest_results_in_broker</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>

        <span class="n">psef</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">callback_after_this_request</span><span class="p">(</span><span class="n">callbacks</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">make_result</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="AutoTest.reset_work"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTest.reset_work">[docs]</a>    <span class="k">def</span> <span class="nf">reset_work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">:</span> <span class="s1">&#39;work_models.Work&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Reset the result beloning to the given work.</span>

<span class="sd">        If there is not result for the given result, a result is created.</span>

<span class="sd">        :param work: The work for which we should reset the work.</span>
<span class="sd">        :returns: Nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span>
        <span class="n">run_id</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">id</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">AutoTestResult</span><span class="o">.</span><span class="n">get_results_by_user</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="n">auto_test_run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">,</span> <span class="n">work_id</span><span class="o">=</span><span class="n">work</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_to_run</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">final_result</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">final_result</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">new_results_should_be_final</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">callback_after_this_request</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">adjust_amount_runners</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Covert this AutoTest to json.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fixtures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fixture</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixtures</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">auth</span><span class="o">.</span><span class="n">ensure_can_view_fixture</span><span class="p">(</span><span class="n">fixture</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">auth</span><span class="o">.</span><span class="n">PermissionException</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fixtures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fixture</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;fixtures&#39;</span><span class="p">:</span> <span class="n">fixtures</span><span class="p">,</span>
            <span class="s1">&#39;setup_script&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_script</span><span class="p">,</span>
            <span class="s1">&#39;run_setup_script&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_setup_script</span><span class="p">,</span>
            <span class="s1">&#39;finalize_script&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_script</span><span class="p">,</span>
            <span class="s1">&#39;grade_calculation&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grade_calculation</span><span class="p">,</span>
            <span class="s1">&#39;sets&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sets</span><span class="p">,</span>
            <span class="s1">&#39;assignment_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;runs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="p">,</span>
            <span class="s1">&#39;results_always_visible&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_always_visible</span><span class="p">,</span>
        <span class="p">}</span>

<div class="viewcode-block" id="AutoTest.copy"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.models.auto_test.AutoTest.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rubric_mapping</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="s1">&#39;rubric_models.RubricRow&#39;</span><span class="p">,</span> <span class="s1">&#39;rubric_models.RubricRow&#39;</span><span class="p">]</span>
        <span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;AutoTest&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Copy this AutoTest configuration.</span>

<span class="sd">        :param rubric_mapping: The mapping how the rubric was copied, if suite</span>
<span class="sd">            ``A`` was copied to suite ``B`` then suite ``B`` is connected to</span>
<span class="sd">            rubric row ``rubric_mapping[A.rubric_row]``.</span>
<span class="sd">        :returns: The copied AutoTest config.</span>

<span class="sd">        .. note::</span>

<span class="sd">            The caller still needs to connect the copied config to an</span>
<span class="sd">            assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">AutoTest</span><span class="p">(</span>
            <span class="n">sets</span><span class="o">=</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sets</span><span class="p">],</span>
            <span class="n">fixtures</span><span class="o">=</span><span class="p">[</span><span class="n">fixture</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">fixture</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixtures</span><span class="p">],</span>
            <span class="n">setup_script</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_script</span><span class="p">,</span>
            <span class="n">run_setup_script</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_setup_script</span><span class="p">,</span>
            <span class="n">finalize_script</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">finalize_script</span><span class="p">,</span>
            <span class="n">results_always_visible</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">results_always_visible</span><span class="p">,</span>
            <span class="n">_grade_calculation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grade_calculation</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">suite</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">all_suites</span><span class="p">:</span>
            <span class="n">suite</span><span class="o">.</span><span class="n">rubric_row</span> <span class="o">=</span> <span class="n">rubric_mapping</span><span class="p">[</span><span class="n">suite</span><span class="o">.</span><span class="n">rubric_row</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">res</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, CodeGrade

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>