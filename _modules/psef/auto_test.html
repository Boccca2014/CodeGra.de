

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>psef.auto_test &mdash; CodeGrade v1.17.2 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                v1.17.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../guides/use-codegrade-as-a-student.html">How to use CodeGrade as a student</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/getting-started-with-codegrade.html">Getting started with CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/autotest-best-practices.html">Best Practices for AutoTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/creating-an-assignment.html">Create a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/set-up-a-rubric-for-an-assignment.html">Set up a rubric for an assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/setting-up-autotest.html">Setting up AutoTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/enabling-continuous-feedback-for-an-assignment.html">Enabling Continuous Feedback for an assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/set-up-group-assignment.html">Set up a CodeGrade group assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/setting-up-hand-in-requirements.html">Set up hand-in requirements for a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/setting-up-git-uploads.html">Set up Git uploads for a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/checking-for-plagiarism.html">Check for plagiarism in a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/dividing-submissions.html">Divide submissions over graders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/pass-back-grades-to-canvas-blackboard-moodle-brightspace.html">Pass back grades to Canvas, Blackboard, Moodle or Brightspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/creating-managing-and-using-snippets.html">Create, manage and use snippets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/setup-password-for-codegrade-account.html">Set up a password for my CodeGrade account</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/using-shortcuts.html">Using shortcuts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/cannot-find-feature-in-codegrade.html">I cannot find a feature in CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/installing-codegrade-filesystem.html">Install the CodeGrade Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/use-codegrade-filesystem.html">Use the CodeGrade Filesystem to locally mount CodeGrade</a></li>
</ul>
<p class="caption"><span class="caption-text">User Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user/overview.html">Overview of CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/codeviewer.html">Code Viewer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/management.html">Course and Assignment Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/plagiarism.html">Plagiarism Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/groups.html">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/permissions.html">Permissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/preferences.html">Settings and Site Preferences</a></li>
<li class="toctree-l1"><a class="reference external" href="https://fs-docs.codegra.de">Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/lms.html">LMS Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/autotest/overview.html">AutoTest</a></li>
</ul>
<p class="caption"><span class="caption-text">About CodeGrade</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about/about.html">About CodeGrade</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../developerdocs.html">Developer documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">CodeGrade</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../psef.html">psef</a> &raquo;</li>
        
      <li>psef.auto_test</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for psef.auto_test</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This module contains all functionality needed to do an actual AutoTest run.</span>

<span class="sd">SPDX-License-Identifier: AGPL-3.0-only</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>  <span class="c1"># typing: ignore</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">grp</span>
<span class="kn">import</span> <span class="nn">pwd</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">t</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">managers</span>

<span class="kn">import</span> <span class="nn">lxc</span>  <span class="c1"># typing: ignore</span>
<span class="kn">import</span> <span class="nn">urllib3</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">structlog</span>
<span class="kn">from</span> <span class="nn">mypy_extensions</span> <span class="kn">import</span> <span class="n">TypedDict</span>
<span class="kn">from</span> <span class="nn">requests.adapters</span> <span class="kn">import</span> <span class="n">HTTPAdapter</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Protocol</span>
<span class="kn">from</span> <span class="nn">urllib3.util.retry</span> <span class="kn">import</span> <span class="n">Retry</span>

<span class="kn">import</span> <span class="nn">psef</span>
<span class="kn">import</span> <span class="nn">cg_logger</span>
<span class="kn">import</span> <span class="nn">cg_worker_pool</span>
<span class="kn">import</span> <span class="nn">cg_threading_utils</span>
<span class="kn">from</span> <span class="nn">cg_timers</span> <span class="kn">import</span> <span class="n">timed_code</span><span class="p">,</span> <span class="n">timed_function</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">helpers</span>
<span class="kn">from</span> <span class="nn">..helpers</span> <span class="kn">import</span> <span class="n">JSONType</span><span class="p">,</span> <span class="n">RepeatedTimer</span><span class="p">,</span> <span class="n">defer</span>
<span class="kn">from</span> <span class="nn">..registry</span> <span class="kn">import</span> <span class="n">auto_test_handlers</span>
<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="n">APICodes</span><span class="p">,</span> <span class="n">StopRunningStepsException</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>

<span class="n">OutputCallback</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">bytes</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">URL</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;URL&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

<span class="n">_STOP_CONTAINERS</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
<span class="n">_LXC_START_STOP_LOCK</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>

<span class="n">Network</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;Network&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]])</span>

<span class="n">NETWORK_EXCEPTIONS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span><span class="p">,</span> <span class="ne">ConnectionError</span><span class="p">,</span> <span class="n">urllib3</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span>
<span class="p">)</span>
<span class="n">FIXTURES_ROOT</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/.{uuid.uuid4().hex}&#39;</span>
<span class="n">PRE_STUDENT_FIXTURES_DIR</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;{uuid.uuid4().hex}/&#39;</span>

<span class="n">OUTPUT_DIR</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/.{uuid.uuid4().hex}/{uuid.uuid4().hex}&#39;</span>


<div class="viewcode-block" id="UpdateResultFunction"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.UpdateResultFunction">[docs]</a><span class="k">class</span> <span class="nc">UpdateResultFunction</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A protocol for a function that can update the state of a step.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="s1">&#39;models.AutoTestStepResultState&#39;</span><span class="p">,</span>
        <span class="n">log</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span></div>


<div class="viewcode-block" id="YieldCoreCallback"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.YieldCoreCallback">[docs]</a><span class="k">class</span> <span class="nc">YieldCoreCallback</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A protocol for a function that yields the current core.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span></div>


<span class="n">CODEGRADE_USER</span> <span class="o">=</span> <span class="s1">&#39;codegrade&#39;</span>
<span class="n">_SYSTEMD_WAIT_CMD</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;systemd-run&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--property=After=basic.target&#39;</span><span class="p">,</span>
    <span class="s1">&#39;--wait&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/bin/true&#39;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">_REQUEST_TIMEOUT</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">_REQUEST_RETRIES</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">_REQUEST_BACKOFF_FACTOR</span> <span class="o">=</span> <span class="mf">1.2</span>


<div class="viewcode-block" id="LXCProcessError"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.LXCProcessError">[docs]</a><span class="k">class</span> <span class="nc">LXCProcessError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="StopRunningStudentException"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.StopRunningStudentException">[docs]</a><span class="k">class</span> <span class="nc">StopRunningStudentException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="StopRunningTestsException"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.StopRunningTestsException">[docs]</a><span class="k">class</span> <span class="nc">StopRunningTestsException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="AttachTimeoutError"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.AttachTimeoutError">[docs]</a><span class="k">class</span> <span class="nc">AttachTimeoutError</span><span class="p">(</span><span class="n">StopRunningTestsException</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="OutputTail"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.OutputTail">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">OutputTail</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This class represents the tail of an output stream.</span>

<span class="sd">    If ``overflowed`` is ``True`` there was even more data captured, but this</span>
<span class="sd">    was thrown away.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">overflowed</span><span class="p">:</span> <span class="nb">bool</span></div>


<div class="viewcode-block" id="StudentCommandResult"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.StudentCommandResult">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">StudentCommandResult</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;The result of a student command.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exit_code</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">time_spend</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">stdout_tail</span><span class="p">:</span> <span class="n">OutputTail</span></div>


<span class="k">def</span> <span class="nf">_get_home_dir</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get the home dir of the given user</span>

<span class="sd">    &gt;&gt;&gt; _get_home_dir(&#39;height&#39;)</span>
<span class="sd">    &#39;/home/height&#39;</span>
<span class="sd">    &gt;&gt;&gt; _get_home_dir(CODEGRADE_USER)</span>
<span class="sd">    &#39;/home/codegrade&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;/home/</span><span class="si">{name}</span><span class="s1">&#39;</span>


<span class="k">def</span> <span class="nf">_waitpid_noblock</span><span class="p">(</span><span class="n">pid</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Wait for the given pid without blocking.</span>

<span class="sd">    :returns: ``None`` if the process has not exited, -1 if the process</span>
<span class="sd">        signaled and the exit code (which is &gt; 0) if the process exited</span>
<span class="sd">        normally.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_pid</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">WNOHANG</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">new_pid</span> <span class="o">==</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">WIFEXITED</span><span class="p">(</span><span class="n">status</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">WIFSIGNALED</span><span class="p">(</span><span class="n">status</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;Process signaled&#39;</span><span class="p">,</span>
            <span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">,</span>
            <span class="n">new_pid</span><span class="o">=</span><span class="n">new_pid</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">WTERMSIG</span><span class="p">(</span><span class="n">status</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="c1"># This should not be possible, as either the process should either</span>
    <span class="c1"># not be exited (new_pid == status == 0), or should exit normally</span>
    <span class="c1"># (os.WIFEXITED), or it exited through a signal (os.WIFSIGNALED).</span>
    <span class="k">assert</span> <span class="kc">False</span>
    <span class="c1"># Pylint issue https://github.com/PyCQA/pylint/issues/2908</span>
    <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># pragma: no cover</span>


<span class="k">def</span> <span class="nf">_wait_for_attach</span><span class="p">(</span>
    <span class="n">pid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">command_started</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span>
    <span class="n">timeout_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">max_amount_timeouts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Wait on the given pid until it signaled a start.</span>

<span class="sd">    This is done by waiting on the given :class:`.threading.Event` and every</span>
<span class="sd">    ``timeout_time`` seconds checking if the process has not already stopped.</span>

<span class="sd">    :param pid: The pid of the attached container.</span>
<span class="sd">    :param command_started: An event to check for if the attach finished.</span>
<span class="sd">    :param timeout_time: The amount of time that should be between checks if</span>
<span class="sd">        the command exited.</span>
<span class="sd">    :param max_amount_timeouts: The maximal amount of times to check if the</span>
<span class="sd">        command exited. If exceeded an :py:class:`.AttachTimeoutError` is</span>
<span class="sd">        raised.</span>
<span class="sd">    :returns: The exit code if the program exited before the attach finished.</span>

<span class="sd">    &gt;&gt;&gt; import doctest</span>
<span class="sd">    &gt;&gt;&gt; doctest.ELLIPSIS_MARKER = &#39;-etc-&#39;</span>
<span class="sd">    &gt;&gt;&gt; from subprocess import Popen</span>
<span class="sd">    &gt;&gt;&gt; event = threading.Event()</span>
<span class="sd">    &gt;&gt;&gt; p = Popen(&#39;exit 1&#39;, shell=True)</span>
<span class="sd">    &gt;&gt;&gt; assert _wait_for_attach(p.pid, event, 1) == 1</span>
<span class="sd">    -etc-</span>
<span class="sd">    &gt;&gt;&gt; event.set()</span>
<span class="sd">    &gt;&gt;&gt; p = Popen(&#39;exit 2&#39;, shell=True)</span>
<span class="sd">    &gt;&gt;&gt; assert _wait_for_attach(p.pid, event, 1) is None</span>
<span class="sd">    -etc-</span>
<span class="sd">    &gt;&gt;&gt; p = Popen(&#39;sleep 120&#39;, shell=True)</span>
<span class="sd">    &gt;&gt;&gt; event.clear()</span>
<span class="sd">    &gt;&gt;&gt; assert _wait_for_attach(p.pid, event, 1, 1) is None</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    -etc-</span>
<span class="sd">    AttachTimeoutError</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">timed_code</span><span class="p">(</span><span class="s1">&#39;waiting_for_attach&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">helpers</span><span class="o">.</span><span class="n">retry_loop</span><span class="p">(</span>
            <span class="n">max_amount_timeouts</span><span class="p">,</span>
            <span class="n">sleep_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">make_exception</span><span class="o">=</span><span class="n">AttachTimeoutError</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">command_started</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout_time</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Still not attached&#39;</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span>

            <span class="n">code</span> <span class="o">=</span> <span class="n">_waitpid_noblock</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">code</span> <span class="k">if</span> <span class="n">code</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="mi">258</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Program exited before attach&#39;</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">code</span>

    <span class="k">raise</span> <span class="ne">RuntimeError</span>  <span class="c1"># pragma: no cover</span>


<span class="k">def</span> <span class="nf">_wait_for_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Wait for ``pid`` at most ``timeout`` amount of seconds.</span>

<span class="sd">    &gt;&gt;&gt; from subprocess import Popen</span>
<span class="sd">    &gt;&gt;&gt; p = Popen(&#39;sleep 5&#39;, shell=True)</span>
<span class="sd">    &gt;&gt;&gt; _wait_for_pid(p.pid, 0.25)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    CommandTimeoutException</span>
<span class="sd">    &gt;&gt;&gt; p.poll() is not None</span>
<span class="sd">    True</span>

<span class="sd">    It also works when SIGTERM is ignored.</span>
<span class="sd">    &gt;&gt;&gt; p = Popen(&quot;trap &#39;echo SIGTERM!&#39; 15 ; sleep 5&quot;, shell=True)</span>
<span class="sd">    &gt;&gt;&gt; _wait_for_pid(p.pid, 0.25)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    CommandTimeoutException</span>

<span class="sd">    &gt;&gt;&gt; pid = Popen(&#39;exit 32&#39;, shell=True).pid</span>
<span class="sd">    &gt;&gt;&gt; _wait_for_pid(pid, 4)[0]</span>
<span class="sd">    32</span>

<span class="sd">    &gt;&gt;&gt; _wait_for_pid(Popen(&#39;exit 20&#39;, shell=True).pid, 4)[0]</span>
<span class="sd">    20</span>

<span class="sd">    &gt;&gt;&gt; exit, left = _wait_for_pid(Popen([&#39;sleep&#39;, &#39;0.25&#39;]).pid, 1)</span>
<span class="sd">    &gt;&gt;&gt; exit</span>
<span class="sd">    0</span>
<span class="sd">    &gt;&gt;&gt; abs((1 - left) - 0.25) &lt;= 0.05  # Waiting should be fairly accurate</span>
<span class="sd">    True</span>

<span class="sd">    &gt;&gt;&gt; import doctest</span>
<span class="sd">    &gt;&gt;&gt; doctest.ELLIPSIS_MARKER = &#39;-etc-&#39;</span>
<span class="sd">    &gt;&gt;&gt; p = Popen(&#39;kill -11 $$&#39;, shell=True)  # This segfaults</span>
<span class="sd">    &gt;&gt;&gt; _wait_for_pid(p.pid, 1)[0] == -1</span>
<span class="sd">    -etc-Process signaled-etc-</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_time_left</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">time_spend</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="k">return</span> <span class="n">timeout</span> <span class="o">-</span> <span class="n">time_spend</span>

    <span class="k">def</span> <span class="nf">timed_out</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_time_left</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span>

    <span class="c1"># This timeout delay code is very similar to that of the timeout</span>
    <span class="c1"># implementation of `subprocess`. It could probably be improved, but I&#39;m</span>
    <span class="c1"># pretty happy with it for now.</span>
    <span class="n">delay</span> <span class="o">=</span> <span class="mf">0.0005</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">timed_out</span><span class="p">():</span>
        <span class="n">exit_code</span> <span class="o">=</span> <span class="n">_waitpid_noblock</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exit_code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">delay</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">get_time_left</span><span class="p">(),</span> <span class="mf">0.05</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">get_time_left</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Process took too long, killing&#39;</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_waitpid_noblock</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;Process did not listen to SIGTERM, killing the hard way&#39;</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="n">pid</span>
        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">_maybe_quit_running</span><span class="p">()</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Killing done&#39;</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">CommandTimeoutException</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>


<div class="viewcode-block" id="LockableValue"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.LockableValue">[docs]</a><span class="k">class</span> <span class="nc">LockableValue</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;This class essentially contains a lock and a value.</span>

<span class="sd">    It forces you to acquire the lock before you can get or set the value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">_InnerValue</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">Generic</span><span class="p">[</span><span class="n">Y</span><span class="p">]):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__inner_value</span><span class="p">:</span> <span class="s1">&#39;LockableValue._InnerValue[T]&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__value</span> <span class="o">=</span> <span class="n">initial_value</span>

<div class="viewcode-block" id="LockableValue.get"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.LockableValue.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the internal value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__value</span></div>

<div class="viewcode-block" id="LockableValue.set"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.LockableValue.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the internal value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__value</span> <span class="o">=</span> <span class="n">value</span></div>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;LockableValue._InnerValue[T]&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__inner_value</span> <span class="o">=</span> <span class="n">LockableValue</span><span class="o">.</span><span class="n">_InnerValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inner_value</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">traceback</span><span class="p">:</span> <span class="nb">object</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inner_value</span><span class="o">.</span><span class="n">value</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inner_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>


<span class="k">class</span> <span class="nc">_Manager</span><span class="p">(</span><span class="n">managers</span><span class="o">.</span><span class="n">SyncManager</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">_Manager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;FairLock&#39;</span><span class="p">,</span> <span class="n">cg_threading_utils</span><span class="o">.</span><span class="n">FairLock</span><span class="p">)</span>


<div class="viewcode-block" id="CpuCores"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.CpuCores">[docs]</a><span class="k">class</span> <span class="nc">CpuCores</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This class contains a reservation system for cpu cores.</span>

<span class="sd">    With this class you can make sure only one of the containers is using</span>
<span class="sd">    specific core at any specific moment. This also works across multiple</span>
<span class="sd">    processes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CpuCores.Core"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.CpuCores.Core">[docs]</a>    <span class="k">class</span> <span class="nc">Core</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;A class representing the currently reserved core.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This class is mutable, so :meth:`~Core.get_core_number` might</span>
<span class="sd">            change.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cores</span><span class="p">:</span> <span class="s1">&#39;CpuCores&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_core_number</span> <span class="o">=</span> <span class="n">core_number</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cores</span> <span class="o">=</span> <span class="n">cores</span>

<div class="viewcode-block" id="CpuCores.Core.get_core_number"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.CpuCores.Core.get_core_number">[docs]</a>        <span class="k">def</span> <span class="nf">get_core_number</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Get the number of the core that is reserved.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_core_number</span></div>

<div class="viewcode-block" id="CpuCores.Core.yield_core"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.CpuCores.Core.yield_core">[docs]</a>        <span class="k">def</span> <span class="nf">yield_core</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Yield the current core.</span>

<span class="sd">            .. warning::</span>

<span class="sd">                The core that is reserved might be changed after this call. So</span>
<span class="sd">                make sure that you actually lock the container to this core</span>
<span class="sd">                after the call.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">new_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cores</span><span class="o">.</span><span class="n">yield_core</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_core_number</span><span class="p">)</span>
            <span class="n">old_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_core_number</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_core_number</span> <span class="o">=</span> <span class="n">new_number</span>
            <span class="k">return</span> <span class="n">new_number</span> <span class="o">!=</span> <span class="n">old_number</span></div></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">manager</span><span class="p">:</span> <span class="n">_Manager</span><span class="p">,</span>
        <span class="n">number_of_cores</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_number_of_cores</span> <span class="o">=</span> <span class="n">number_of_cores</span> <span class="ow">or</span> <span class="n">_get_amount_cpus</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_available_cores</span><span class="p">:</span> <span class="s1">&#39;Queue[int]&#39;</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_number_of_cores</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span> <span class="n">cg_threading_utils</span><span class="o">.</span><span class="n">FairLock</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">FairLock</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">core</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_number_of_cores</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_available_cores</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">core</span><span class="p">)</span>

<div class="viewcode-block" id="CpuCores.yield_core"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.CpuCores.yield_core">[docs]</a>    <span class="k">def</span> <span class="nf">yield_core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Yield the given core.</span>

<span class="sd">        :returns: The number of the newly reserved core.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_available_cores</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">core_number</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_core</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_get_core</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_available_cores</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<div class="viewcode-block" id="CpuCores.reserved_core"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.CpuCores.reserved_core">[docs]</a>    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">reserved_core</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Generator</span><span class="p">[</span><span class="s1">&#39;CpuCores.Core&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Reserve a core for the duration of the ``with`` block.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">core</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Core</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_core</span><span class="p">(),</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Got core number&#39;</span><span class="p">,</span> <span class="n">core</span><span class="o">=</span><span class="n">core</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">core</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_available_cores</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_core_number</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="StopContainerException"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.StopContainerException">[docs]</a><span class="k">class</span> <span class="nc">StopContainerException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This exception should be raised by each container when they should stop</span>
<span class="sd">    running.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="CommandTimeoutException"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.CommandTimeoutException">[docs]</a><span class="k">class</span> <span class="nc">CommandTimeoutException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This exception is raised when a command takes too much time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">EXIT_CODE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">time_spend</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_spend</span> <span class="o">=</span> <span class="n">time_spend</span></div>


<span class="k">def</span> <span class="nf">_maybe_quit_running</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Throw appropriate exception if container should stop running.</span>

<span class="sd">    &gt;&gt;&gt; _STOP_CONTAINERS.clear()</span>
<span class="sd">    &gt;&gt;&gt; _maybe_quit_running() is None</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; _STOP_CONTAINERS.set()</span>
<span class="sd">    &gt;&gt;&gt; _maybe_quit_running()</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    StopContainerException</span>
<span class="sd">    &gt;&gt;&gt; _STOP_CONTAINERS.clear()</span>
<span class="sd">    &gt;&gt;&gt; _maybe_quit_running() is None</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">_STOP_CONTAINERS</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">StopContainerException</span>


<span class="k">def</span> <span class="nf">_get_new_container_name</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get a new unique container name</span>

<span class="sd">    &gt;&gt;&gt; a = _get_new_container_name()</span>
<span class="sd">    &gt;&gt;&gt; b = _get_new_container_name()</span>
<span class="sd">    &gt;&gt;&gt; type(a)</span>
<span class="sd">    &lt;class &#39;str&#39;&gt;</span>
<span class="sd">    &gt;&gt;&gt; a != b</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">_get_amount_cpus</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get the amount of cpus on this system or 1 if we cannot detect it.</span>

<span class="sd">    This will always be higher than 0.</span>

<span class="sd">    &gt;&gt;&gt; _get_amount_cpus() &gt; 0</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">_get_base_container</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="s1">&#39;psef.FlaskConfig&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;AutoTestContainer&#39;</span><span class="p">:</span>
    <span class="n">helpers</span><span class="o">.</span><span class="n">ensure_on_test_server</span><span class="p">()</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;AUTO_TEST_TEMPLATE_CONTAINER&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">template_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No base template set, creating new container&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">AutoTestContainer</span><span class="p">(</span><span class="n">_get_new_container_name</span><span class="p">(),</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">AutoTestContainer</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">_stop_container</span><span class="p">(</span><span class="n">cont</span><span class="p">:</span> <span class="n">lxc</span><span class="o">.</span><span class="n">Container</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">cont</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">timed_code</span><span class="p">(</span><span class="s1">&#39;stop_container&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">_LXC_START_STOP_LOCK</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cont</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">cg_worker_pool</span><span class="o">.</span><span class="n">KillWorkerException</span>
            <span class="k">assert</span> <span class="n">cont</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="s1">&#39;STOPPED&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_start_container</span><span class="p">(</span>
    <span class="n">cont</span><span class="p">:</span> <span class="n">lxc</span><span class="o">.</span><span class="n">Container</span><span class="p">,</span> <span class="n">check_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">always</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">always</span><span class="p">:</span>
        <span class="n">_maybe_quit_running</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">cont</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">with</span> <span class="n">timed_code</span><span class="p">(</span><span class="s1">&#39;start_container&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">_LXC_START_STOP_LOCK</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">cont</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">cont</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="s1">&#39;RUNNING&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">domain_or_systemd</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">domain_or_systemd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">_SYSTEMD_WAIT_CMD</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># pylint: disable=subprocess-run-check</span>
                    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>

                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># pylint: disable=protected-access</span>
                <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># pylint: disable=protected-access</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">execvp</span><span class="p">(</span><span class="s1">&#39;ping&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;ping&#39;</span><span class="p">,</span> <span class="s1">&#39;-w&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="p">])</span>
            <span class="k">assert</span> <span class="kc">False</span>

        <span class="k">with</span> <span class="n">timed_code</span><span class="p">(</span><span class="s1">&#39;wait_for_system_start&#39;</span><span class="p">):</span>
            <span class="n">out_code</span> <span class="o">=</span> <span class="n">cont</span><span class="o">.</span><span class="n">attach_wait</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Started system&#39;</span><span class="p">,</span> <span class="n">systemd_wait_exit_code</span><span class="o">=</span><span class="n">out_code</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">check_network</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">timed_code</span><span class="p">(</span><span class="s1">&#39;wait_for_network&#39;</span><span class="p">):</span>

                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">helpers</span><span class="o">.</span><span class="n">retry_loop</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">sleep_time</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">always</span><span class="p">:</span>
                        <span class="n">_maybe_quit_running</span><span class="p">()</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">cont</span><span class="o">.</span><span class="n">get_ips</span><span class="p">():</span>
                        <span class="k">continue</span>

                    <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;codegra.de&#39;</span><span class="p">,</span> <span class="s1">&#39;docs.codegra.de&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">cont</span><span class="o">.</span><span class="n">attach_wait</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">return</span>


<div class="viewcode-block" id="StepInstructions"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.StepInstructions">[docs]</a><span class="k">class</span> <span class="nc">StepInstructions</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Instructions on how to run a single AutoTest step.</span>

<span class="sd">    :ivar ~.StepInstructions.id: The id of the step.</span>
<span class="sd">    :ivar weight: The amount of points you can achieve with this step.</span>
<span class="sd">    :ivar test_type_name: The type of step this is.</span>
<span class="sd">    :ivar data: The data of this step, this contains stuff like which command</span>
<span class="sd">        to run and what output to expect.</span>
<span class="sd">    :ivar command_time_limit: What is the maximum amount of time a command may</span>
<span class="sd">        run in this step.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">test_type_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">data</span><span class="p">:</span> <span class="s1">&#39;psef.helpers.JSONType&#39;</span>
    <span class="n">command_time_limit</span><span class="p">:</span> <span class="nb">float</span></div>


<div class="viewcode-block" id="SuiteInstructions"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.SuiteInstructions">[docs]</a><span class="k">class</span> <span class="nc">SuiteInstructions</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Instructions on how to run a single AutoTest suite.</span>

<span class="sd">    :ivar ~.StepInstructions.id: The id of the suite.</span>
<span class="sd">    :ivar steps: The steps of this suite.</span>
<span class="sd">    :ivar network_disabled: Should this suite be run with networking disabled.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">steps</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">StepInstructions</span><span class="p">]</span>
    <span class="n">network_disabled</span><span class="p">:</span> <span class="nb">bool</span></div>


<div class="viewcode-block" id="SetInstructions"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.SetInstructions">[docs]</a><span class="k">class</span> <span class="nc">SetInstructions</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Instructions for a single AutoTest set.</span>

<span class="sd">    :ivar ~.SetInstructions.id: The id of this set.</span>
<span class="sd">    :ivar suites: The suites of this set.</span>
<span class="sd">    :ivar stop_points: The minimum amount of points that we should have to be</span>
<span class="sd">        able to continue running sets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">suites</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">SuiteInstructions</span><span class="p">]</span>
    <span class="n">stop_points</span><span class="p">:</span> <span class="nb">float</span></div>


<div class="viewcode-block" id="RunnerInstructions"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.RunnerInstructions">[docs]</a><span class="k">class</span> <span class="nc">RunnerInstructions</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Instructions for a complete auto test run.</span>

<span class="sd">    :ivar runner_id: The id of this runner.</span>
<span class="sd">    :ivar run_id: The id of this auto test run.</span>
<span class="sd">    :ivar auto_test_id: The id of this AutoTest configuration.</span>
<span class="sd">    :ivar result_ids: The ids of the results this runner should produce. These</span>
<span class="sd">        can be seen as submissions.</span>
<span class="sd">    :ivar sets: The sets that this AutoTest configuration contain.</span>
<span class="sd">    :ivar setup_script: The setup script that should be run for each student.</span>
<span class="sd">    :ivar run_setup_script: The setup script that should be run once.</span>
<span class="sd">    :ivar heartbeat_interval: The interval in seconds to send heartbeats in.</span>
<span class="sd">    :ivar fixtures: A list of tuples where the first item is the name of the</span>
<span class="sd">        fixture and the second item is its id.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">runner_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">run_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">auto_test_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">result_ids</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">student_ids</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">sets</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">SetInstructions</span><span class="p">]</span>
    <span class="n">fixtures</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>
    <span class="n">setup_script</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">heartbeat_interval</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">run_setup_script</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">poll_after_done</span><span class="p">:</span> <span class="nb">bool</span></div>


<div class="viewcode-block" id="ExecuteOptions"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.ExecuteOptions">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ExecuteOptions</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Options passed to the steps when executing them.</span>

<span class="sd">    :ivar update_test_result: A function that can be used to update the step</span>
<span class="sd">        result.</span>
<span class="sd">    :ivar test_instructions: The instructions for how to execute this step.</span>
<span class="sd">    :ivar achieved_percentage: The percentage of points achieved at this point</span>
<span class="sd">        for the current suite.</span>
<span class="sd">    :ivar ~ExecuteOptions.yield_core: A callback that shuts the container down,</span>
<span class="sd">        yields the reserved core and requests a new one, and starts the</span>
<span class="sd">        container back up.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">update_test_result</span><span class="p">:</span> <span class="n">UpdateResultFunction</span>
    <span class="n">test_instructions</span><span class="p">:</span> <span class="n">StepInstructions</span>
    <span class="n">achieved_percentage</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">yield_core</span><span class="p">:</span> <span class="n">YieldCoreCallback</span></div>


<span class="k">def</span> <span class="nf">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="s1">&#39;psef.PsefFlask&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">process_config</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>


<div class="viewcode-block" id="process_config"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.process_config">[docs]</a><span class="k">def</span> <span class="nf">process_config</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="s1">&#39;psef.FlaskConfig&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Process the AutoTest hosts config to the correct format.</span>

<span class="sd">    :param config: The configuration that should be processed. This will be</span>
<span class="sd">        modified in-place.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ipaddr</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;__S_AUTO_TEST_HOSTS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;container_url&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">str</span><span class="p">))</span>
        <span class="n">res</span><span class="p">[</span><span class="n">ipaddr</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">],</span>
            <span class="s1">&#39;container_url&#39;</span><span class="p">:</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;container_url&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;AUTO_TEST_HOSTS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>  <span class="c1"># type: ignore</span></div>


<span class="c1"># This wrapper function is needed for Python multiprocessing</span>
<span class="k">def</span> <span class="nf">_run_student</span><span class="p">(</span>
    <span class="n">cont</span><span class="p">:</span> <span class="s1">&#39;AutoTestRunner&#39;</span><span class="p">,</span>
    <span class="n">bc_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">cores</span><span class="p">:</span> <span class="n">CpuCores</span><span class="p">,</span>
    <span class="n">opts</span><span class="p">:</span> <span class="n">cg_worker_pool</span><span class="o">.</span><span class="n">CallbackArguments</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">cont</span><span class="o">.</span><span class="n">run_student</span><span class="p">(</span><span class="n">bc_name</span><span class="p">,</span> <span class="n">cores</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>


<div class="viewcode-block" id="start_polling"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.start_polling">[docs]</a><span class="k">def</span> <span class="nf">start_polling</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="s1">&#39;psef.FlaskConfig&#39;</span><span class="p">,</span> <span class="n">repeat</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Start polling the configured CodeGrade instances.</span>

<span class="sd">    :param config: The config of this AutoTest runner. This also determines</span>
<span class="sd">        what servers will be polled.</span>
<span class="sd">    :param repeat: Should we repeat the polling after running a single test.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;AUTO_TEST_HOSTS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">sleep_time</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;AUTO_TEST_POLL_TIME&#39;</span><span class="p">]</span>
    <span class="n">broker_url</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;AUTO_TEST_BROKER_URL&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">do_job</span><span class="p">(</span><span class="n">cont</span><span class="p">:</span> <span class="s1">&#39;StartedContainer&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">url</span><span class="p">,</span> <span class="n">url_config</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;CG-Internal-Api-Password&#39;</span><span class="p">:</span> <span class="n">url_config</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">try_unbind</span><span class="p">(</span><span class="s1">&#39;server&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Checking next server&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{url}</span><span class="s1">/api/v-internal/auto_tests/&#39;</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;get&#39;</span><span class="p">:</span> <span class="s1">&#39;tests_to_run&#39;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">_REQUEST_TIMEOUT</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to get server&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Got test&#39;</span><span class="p">,</span>
                    <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                    <span class="n">auto_test_id</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auto_test_id&#39;</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">AutoTestRunner</span><span class="p">(</span>
                        <span class="n">URL</span><span class="p">(</span><span class="n">url_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;container_url&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">url</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span>
                        <span class="n">url_config</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">],</span> <span class="n">config</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span><span class="n">cont</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>  <span class="c1"># pylint: disable=bare-except</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error while running tests&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No tests found&#39;</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">first</span> <span class="ow">or</span> <span class="n">repeat</span><span class="p">:</span>
        <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">_STOP_CONTAINERS</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">_get_base_container</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">started_container</span><span class="p">()</span> <span class="k">as</span> <span class="n">cont</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;AUTO_TEST_TEMPLATE_CONTAINER&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cont</span><span class="o">.</span><span class="n">run_command</span><span class="p">([</span><span class="s1">&#39;apt&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">])</span>
                <span class="n">cont</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
                    <span class="p">[</span><span class="s1">&#39;apt&#39;</span><span class="p">,</span> <span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="s1">&#39;-y&#39;</span><span class="p">,</span> <span class="s1">&#39;wget&#39;</span><span class="p">,</span> <span class="s1">&#39;curl&#39;</span><span class="p">,</span> <span class="s1">&#39;unzip&#39;</span><span class="p">],</span>
                    <span class="n">retry_amount</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">helpers</span><span class="o">.</span><span class="n">retry_loop</span><span class="p">(</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">,</span> <span class="n">sleep_time</span><span class="o">=</span><span class="n">_REQUEST_TIMEOUT</span>
            <span class="p">):</span>
                <span class="k">with</span> <span class="n">helpers</span><span class="o">.</span><span class="n">BrokerSession</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">broker_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">ses</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ses</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                            <span class="s1">&#39;/api/v1/alive/&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">_REQUEST_TIMEOUT</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                    <span class="k">except</span><span class="p">:</span>  <span class="c1"># pylint: disable=bare-except</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Did request to broker&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">do_job</span><span class="p">(</span><span class="n">cont</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span></div>


<div class="viewcode-block" id="StartedContainer"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.StartedContainer">[docs]</a><span class="k">class</span> <span class="nc">StartedContainer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This class represents a started lxc container. It can be used to execute</span>
<span class="sd">    commands.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_NETWORK_LOCK</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
    <span class="n">_SNAPSHOT_LOCK</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="n">lxc</span><span class="o">.</span><span class="n">Container</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="s1">&#39;psef.FlaskConfig&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span> <span class="o">=</span> <span class="n">container</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_network_is_enabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_networks</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">Network</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixtures_dir</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_stop_container</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_stop_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="p">)</span>

<div class="viewcode-block" id="StartedContainer.move_fixtures_dir"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.StartedContainer.move_fixtures_dir">[docs]</a>    <span class="k">def</span> <span class="nf">move_fixtures_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Move the fixtures directory to the given new directory.</span>

<span class="sd">        :param new_dir: The new directory where the fixtures should be</span>
<span class="sd">            located. This directory will be created within ``FIXTURES_ROOT``.</span>
<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{FIXTURES_ROOT}</span><span class="s1">/</span><span class="si">{new_dir}</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s1">&#39;/bin/bash&#39;</span><span class="p">,</span>
                <span class="s1">&#39;-c&#39;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="s1">&#39;mv &quot;</span><span class="si">{old_path}</span><span class="s1">&quot; &quot;</span><span class="si">{new_path}</span><span class="s1">&quot; &amp;&amp; &#39;</span>
                    <span class="s1">&#39;chown </span><span class="si">{user}</span><span class="s1">:&quot;$(id -gn </span><span class="si">{user}</span><span class="s1">)&quot; &quot;</span><span class="si">{new_path}</span><span class="s1">&quot;&#39;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">user</span><span class="o">=</span><span class="n">CODEGRADE_USER</span><span class="p">,</span>
                    <span class="n">old_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fixtures_dir</span><span class="p">,</span>
                    <span class="n">new_path</span><span class="o">=</span><span class="n">new_path</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixtures_dir</span> <span class="o">=</span> <span class="n">new_dir</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fixtures_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The directory where the fixtures are located.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inner_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixtures_dir</span> <span class="ow">or</span> <span class="n">PRE_STUDENT_FIXTURES_DIR</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{FIXTURES_ROOT}</span><span class="s1">/</span><span class="si">{inner_dir}</span><span class="s1">/&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the output dir for this running container.</span>

<span class="sd">        For now this is a global variable, but this might change in a future</span>
<span class="sd">        version.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">OUTPUT_DIR</span>

<div class="viewcode-block" id="StartedContainer.stopped_container"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.StartedContainer.stopped_container">[docs]</a>    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">stopped_container</span><span class="p">(</span><span class="bp">self</span>
                          <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Generator</span><span class="p">[</span><span class="s1">&#39;AutoTestContainer&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Temporarily stop the container.</span>

<span class="sd">        The container will be stopped for the body of the ``with`` block.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_container</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">AutoTestContainer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">_start_container</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="p">,</span>
                <span class="n">always</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">check_network</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_network_is_enabled</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="StartedContainer.destroy_snapshots"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.StartedContainer.destroy_snapshots">[docs]</a>    <span class="k">def</span> <span class="nf">destroy_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Destroy all snapshots of this container.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_container</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SNAPSHOT_LOCK</span><span class="p">,</span> <span class="n">timed_code</span><span class="p">(</span>
            <span class="s1">&#39;destroy_snapshots&#39;</span><span class="p">,</span> <span class="n">snapshot_amount</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">snapshot_destroy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">pin_to_core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cgroup_item</span><span class="p">(</span><span class="s1">&#39;cpuset.cpus&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">core_number</span><span class="p">))</span>

<div class="viewcode-block" id="StartedContainer.set_cgroup_item"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.StartedContainer.set_cgroup_item">[docs]</a>    <span class="k">def</span> <span class="nf">set_cgroup_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set a cgroup option in the given container.</span>

<span class="sd">        :param key: The cgroup key to be set.</span>
<span class="sd">        :param value: The value to set.</span>
<span class="sd">        :raises AssertionError: When the value could not be set successfully.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">cg_logger</span><span class="o">.</span><span class="n">bound_to_logger</span><span class="p">(</span><span class="n">cgroup_key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">cgroup_value</span><span class="o">=</span><span class="n">value</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">helpers</span><span class="o">.</span><span class="n">retry_loop</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">set_cgroup_item</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                    <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_create_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SNAPSHOT_LOCK</span><span class="p">:</span>
            <span class="n">snap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">snap</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snap</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="StartedContainer.disable_network"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.StartedContainer.disable_network">[docs]</a>    <span class="nd">@timed_function</span>
    <span class="k">def</span> <span class="nf">disable_network</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Disable the network of this container.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network_is_enabled</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_network_is_enabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_container</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NETWORK_LOCK</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_networks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">network</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">network</span><span class="p">:</span>
                <span class="n">net</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">network</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="p">[(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">network</span><span class="p">)]</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_networks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Network</span><span class="p">(</span><span class="n">net</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">network_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">network</span><span class="p">)):</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">network_idx</span><span class="p">)</span>

        <span class="n">_start_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="p">,</span> <span class="n">check_network</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="StartedContainer.enable_network"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.StartedContainer.enable_network">[docs]</a>    <span class="nd">@timed_function</span>
    <span class="k">def</span> <span class="nf">enable_network</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Enable the network of this container.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network_is_enabled</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_network_is_enabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_container</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NETWORK_LOCK</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">typ</span><span class="p">,</span> <span class="n">network</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_networks</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>

                <span class="c1"># -1 index doesn&#39;t work, as this isn&#39;t a true list</span>
                <span class="n">last_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">network</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">network</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">network</span><span class="p">[</span><span class="n">last_index</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">_start_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="p">,</span> <span class="n">check_network</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="StartedContainer.as_snapshot"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.StartedContainer.as_snapshot">[docs]</a>    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">as_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">disable_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Generator</span><span class="p">[</span><span class="s1">&#39;StartedContainer&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Create a snapshot of the running container.</span>

<span class="sd">        .. warning::</span>

<span class="sd">          The state of the network of the container will be altered by doing</span>
<span class="sd">          this. To also restore the network use</span>
<span class="sd">          :meth:`.StartedContainer.enable_network` and</span>
<span class="sd">          :meth:`.StartedContainer.disable_network`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: This code never destroys snapshots, as this logic makes the</span>
        <span class="c1"># function way harder to follow. As we keep a dirty flag, only one</span>
        <span class="c1"># snapsnot will probably be created.</span>

        <span class="n">_maybe_quit_running</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">disable_network</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disable_network</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enable_network</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">timed_code</span><span class="p">(</span>
                    <span class="s1">&#39;create_snapshot&#39;</span><span class="p">,</span>
                    <span class="n">container</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                    <span class="n">amount_of_snapshots</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_stop_container</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_create_snapshot</span><span class="p">()</span>
                    <span class="n">_start_container</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="p">,</span> <span class="n">check_network</span><span class="o">=</span><span class="ow">not</span> <span class="n">disable_network</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Snapshot creation not needed&#39;</span><span class="p">,</span>
                    <span class="n">snapshots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">,</span>
                    <span class="n">dirty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span>
                <span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Creating the snapshot, so we might not have a snapshot</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stop_container</span><span class="p">()</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SNAPSHOT_LOCK</span><span class="p">,</span> <span class="n">timed_code</span><span class="p">(</span><span class="s1">&#39;restore_snapshots&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">snapshot_restore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">_start_container</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="p">,</span> <span class="n">check_network</span><span class="o">=</span><span class="ow">not</span> <span class="n">disable_network</span>
                <span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_read_fifo</span><span class="p">(</span>
        <span class="n">files</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">OutputCallback</span><span class="p">],</span> <span class="n">stop</span><span class="p">:</span> <span class="n">LockableValue</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fds</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># We use os primitives here to make sure we get a non blocking</span>
                <span class="c1"># file descriptor.</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_NONBLOCK</span><span class="p">)</span>
                <span class="n">fds</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">callback</span>

            <span class="k">while</span> <span class="n">fds</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">stop</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                <span class="n">reads</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">fds</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">0.5</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">reads</span><span class="p">:</span>
                    <span class="c1"># Read at most 1024, this is a low value as otherwise we</span>
                    <span class="c1"># might fill the limited output buffers with only one of</span>
                    <span class="c1"># the two file descriptors. (see</span>
                    <span class="c1"># ``_make_restricted_append`` for how the shared output</span>
                    <span class="c1"># buffers work).</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                        <span class="c1"># We know that select returns a subset of its</span>
                        <span class="c1"># arguments, so ``f`` should always be in ``fds``.</span>
                        <span class="n">fds</span><span class="p">[</span><span class="n">f</span><span class="p">](</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># This file descriptor is done, so remove it from our</span>
                        <span class="c1"># dictionary. Other fds might still be active so we</span>
                        <span class="c1"># don&#39;t return here.</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                        <span class="k">del</span> <span class="n">fds</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># pylint: disable=bare-except</span>
            <span class="c1"># pragma: no cover</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Something went wrong when reading output&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fds</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_change_user</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="c1"># We cannot cover this as it is run in another process which will</span>
        <span class="c1"># execvp.</span>
        <span class="n">pw_record</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="n">group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">gr_gid</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrall</span><span class="p">()</span> <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">gr_mem</span><span class="p">]</span>
        <span class="n">user_uid</span> <span class="o">=</span> <span class="n">pw_record</span><span class="o">.</span><span class="n">pw_uid</span>
        <span class="n">user_gid</span> <span class="o">=</span> <span class="n">pw_record</span><span class="o">.</span><span class="n">pw_gid</span>

        <span class="n">os</span><span class="o">.</span><span class="n">setgroups</span><span class="p">(</span><span class="n">group_ids</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">setgid</span><span class="p">(</span><span class="n">user_gid</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">setuid</span><span class="p">(</span><span class="n">user_uid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create the env for within a lxc subprocess call</span>

<span class="sd">        &gt;&gt;&gt; import getpass</span>
<span class="sd">        &gt;&gt;&gt; cur_user = getpass.getuser()</span>
<span class="sd">        &gt;&gt;&gt; env = StartedContainer(None, &#39;&#39;, {})._create_env(cur_user)</span>
<span class="sd">        &gt;&gt;&gt; env[&#39;USER&#39;] == cur_user</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; isinstance(env[&#39;USER&#39;], str)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; isinstance(env[&#39;HOME&#39;], str)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; isinstance(env[&#39;FIXTURES&#39;], str)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; isinstance(env[&#39;STUDENT&#39;], str)</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">username</span>
        <span class="n">home_dir</span> <span class="o">=</span> <span class="n">_get_home_dir</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

        <span class="n">extra_path</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;~/bin/:~/.pyenv/bin/:~/.local/bin:</span><span class="si">{home_dir}</span><span class="s1">/.local/bin/&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;:</span><span class="si">{home_dir}</span><span class="s1">/bin/&#39;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;PATH&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{extra_path}</span><span class="s1">:/usr/sbin/:/sbin/:</span><span class="si">{env[&quot;PATH&quot;]}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;USER&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
            <span class="s1">&#39;LOGUSER&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
            <span class="s1">&#39;HOME&#39;</span><span class="p">:</span> <span class="n">home_dir</span><span class="p">,</span>
            <span class="s1">&#39;DEBIAN_FRONTEND&#39;</span><span class="p">:</span> <span class="s1">&#39;noninteractive&#39;</span><span class="p">,</span>
            <span class="s1">&#39;TERM&#39;</span><span class="p">:</span> <span class="s1">&#39;dumb&#39;</span><span class="p">,</span>
            <span class="s1">&#39;FIXTURES&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixtures_dir</span><span class="p">,</span>
            <span class="s1">&#39;STUDENT&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;{_get_home_dir(username)}/student/&#39;</span><span class="p">,</span>
            <span class="s1">&#39;AT_OUTPUT&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
            <span class="s1">&#39;LANG&#39;</span><span class="p">:</span> <span class="s1">&#39;en_US.UTF-8&#39;</span><span class="p">,</span>
            <span class="s1">&#39;LC_ALL&#39;</span><span class="p">:</span> <span class="s1">&#39;en_US.UTF-8&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_signal_start</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lxc</span><span class="o">.</span><span class="n">Container</span><span class="o">.</span><span class="n">signal_start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_run_command</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cmd_user</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">cmd</span><span class="p">,</span> <span class="n">user</span> <span class="o">=</span> <span class="n">cmd_user</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_env</span><span class="p">(</span><span class="n">user</span> <span class="ow">or</span> <span class="n">CODEGRADE_USER</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_change_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_signal_start</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">execvpe</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_shell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_cwd_user</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">user</span> <span class="o">=</span> <span class="n">cmd_cwd_user</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_env</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">home_dir</span> <span class="o">=</span> <span class="n">_get_home_dir</span><span class="p">(</span><span class="n">CODEGRADE_USER</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{home_dir}</span><span class="s1">/student/:</span><span class="si">{self.fixtures_dir}</span><span class="s1">&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_change_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">cmd_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/bin/bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">]</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_signal_start</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">execve</span><span class="p">(</span><span class="n">cmd_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmd_list</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_make_restricted_append</span><span class="p">(</span>
        <span class="n">lst</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span>
        <span class="n">size_left</span><span class="p">:</span> <span class="n">LockableValue</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">callback</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">bytes</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">bytes</span><span class="p">],</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Make a restricted append function.</span>

<span class="sd">        The returned function will append its argument to ``lst`` while</span>
<span class="sd">        ``size_left`` is still higher than 0. It is safe to share ``size_left``</span>
<span class="sd">        between multiple append functions, the total size of all lists will not</span>
<span class="sd">        exceed ``size_left`` in this case. The function ``callback`` is called</span>
<span class="sd">        for every output, no matter how much output we already received.</span>

<span class="sd">        &gt;&gt;&gt; from copy import deepcopy</span>
<span class="sd">        &gt;&gt;&gt; max_size = LockableValue(10)</span>
<span class="sd">        &gt;&gt;&gt; lst = []</span>
<span class="sd">        &gt;&gt;&gt; append = StartedContainer._make_restricted_append(lst, max_size)</span>
<span class="sd">        &gt;&gt;&gt; for i in range(100): append(str(i))</span>
<span class="sd">        &gt;&gt;&gt; len(lst)</span>
<span class="sd">        11</span>
<span class="sd">        &gt;&gt;&gt; lst[-1]</span>
<span class="sd">        b&#39; &lt;OUTPUT TRUNCATED&gt;\n&#39;</span>
<span class="sd">        &gt;&gt;&gt; old_lst = deepcopy(lst)</span>
<span class="sd">        &gt;&gt;&gt; append(&#39;something&#39;)</span>
<span class="sd">        &gt;&gt;&gt; old_lst == lst</span>
<span class="sd">        True</span>

<span class="sd">        &gt;&gt;&gt; max_size = LockableValue(10)</span>
<span class="sd">        &gt;&gt;&gt; lst = []</span>
<span class="sd">        &gt;&gt;&gt; append = StartedContainer._make_restricted_append(lst, max_size)</span>
<span class="sd">        &gt;&gt;&gt; append(&#39;1234567890abcdefghi&#39;)</span>
<span class="sd">        &gt;&gt;&gt; len(lst)</span>
<span class="sd">        2</span>
<span class="sd">        &gt;&gt;&gt; lst[0]</span>
<span class="sd">        &#39;1234567890&#39;</span>
<span class="sd">        &gt;&gt;&gt; lst2 = []</span>
<span class="sd">        &gt;&gt;&gt; append2 = StartedContainer._make_restricted_append(lst2, max_size)</span>
<span class="sd">        &gt;&gt;&gt; append2(&#39;bytes&#39;)</span>
<span class="sd">        &gt;&gt;&gt; append2(&#39;bytes&#39;)</span>
<span class="sd">        &gt;&gt;&gt; lst2</span>
<span class="sd">        [b&#39; &lt;OUTPUT TRUNCATED&gt;\n&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outputed_truncated_emitted</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">def</span> <span class="nf">emit_truncated</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">nonlocal</span> <span class="n">outputed_truncated_emitted</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">outputed_truncated_emitted</span><span class="p">:</span>
                <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39; &lt;OUTPUT TRUNCATED&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">outputed_truncated_emitted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">def</span> <span class="nf">fun</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">outputed_truncated_emitted</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="k">with</span> <span class="n">size_left</span> <span class="k">as</span> <span class="n">inner</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">inner</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">emit_truncated</span><span class="p">()</span>
                    <span class="k">return</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">inner</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="n">new_val</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">inner</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">new_val</span><span class="p">:</span>
                        <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>
                    <span class="n">emit_truncated</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">inner</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">inner</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fun</span>

<div class="viewcode-block" id="StartedContainer.run_student_command"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.StartedContainer.run_student_command">[docs]</a>    <span class="k">def</span> <span class="nf">run_student_command</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">stdin</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_stdout_tail</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StudentCommandResult</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run a command provided by the student or teacher.</span>

<span class="sd">        The main difference between this function and</span>
<span class="sd">        :meth:`StartedContainer.run_command` is that the command here is a</span>
<span class="sd">        string and it will be executed by a shell.</span>

<span class="sd">        :param cmd: The command that should be executed.</span>
<span class="sd">        :param timeout: The maximum amount of time the command may take in</span>
<span class="sd">            seconds.</span>
<span class="sd">        :param stdin: The stdin that should be provided to the command.</span>
<span class="sd">        :param cwd: The location in which the command should be executed.</span>
<span class="sd">        :returns: A tuple of four items, which are respectively the exit code</span>
<span class="sd">            of the command, the produced stdout, the produced stderr and the</span>
<span class="sd">            time taken by the command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stdout</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stderr</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">max_tail_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;AUTO_TEST_MAX_OUTPUT_TAIL&#39;</span><span class="p">]</span>
        <span class="n">stdout_tail</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Deque</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">([],</span> <span class="n">maxlen</span><span class="o">=</span><span class="n">max_tail_len</span><span class="p">)</span>
        <span class="n">tail_overflowed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">CODEGRADE_USER</span>
        <span class="k">if</span> <span class="n">cwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;{_get_home_dir(user)}/student/&#39;</span>

        <span class="k">assert</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">max_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;AUTO_TEST_OUTPUT_LIMIT&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">max_size</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="n">size_left</span> <span class="o">=</span> <span class="n">LockableValue</span><span class="p">(</span><span class="n">max_size</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_stdout_and_stderr</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;backslashreplace&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">]</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="n">keep_stdout_tail</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">on_stdout</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">nonlocal</span> <span class="n">tail_overflowed</span>
                <span class="n">tail_overflowed</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">tail_overflowed</span> <span class="ow">or</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">stdout_tail</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_tail_len</span>
                <span class="p">)</span>
                <span class="n">stdout_tail</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">on_stdout</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pylint: disable=unused-argument</span>
                <span class="k">return</span>

        <span class="n">time_spend</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">timed_code</span><span class="p">(</span><span class="s1">&#39;run_student_command&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">get_time_spend</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="o">=</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">user</span><span class="p">),</span>
                    <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_shell</span><span class="p">,</span>
                    <span class="n">stdout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_restricted_append</span><span class="p">(</span>
                        <span class="n">stdout</span><span class="p">,</span> <span class="n">size_left</span><span class="p">,</span> <span class="n">on_stdout</span>
                    <span class="p">),</span>
                    <span class="n">stderr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_restricted_append</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">size_left</span><span class="p">),</span>
                    <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">,</span>
                    <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">time_spend</span> <span class="o">=</span> <span class="n">get_time_spend</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">CommandTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">stdout_str</span><span class="p">,</span> <span class="n">stderr_str</span> <span class="o">=</span> <span class="n">get_stdout_and_stderr</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">CommandTimeoutException</span><span class="p">(</span>
                <span class="n">cmd</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">stdout_str</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">stderr_str</span><span class="p">,</span>
                <span class="n">time_spend</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">time_spend</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">stdout_str</span><span class="p">,</span> <span class="n">stderr_str</span> <span class="o">=</span> <span class="n">get_stdout_and_stderr</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">StudentCommandResult</span><span class="p">(</span>
            <span class="n">exit_code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">stdout_str</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">stderr_str</span><span class="p">,</span>
            <span class="n">time_spend</span><span class="o">=</span><span class="n">time_spend</span><span class="p">,</span>
            <span class="n">stdout_tail</span><span class="o">=</span><span class="n">OutputTail</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">stdout_tail</span><span class="p">,</span> <span class="n">overflowed</span><span class="o">=</span><span class="n">tail_overflowed</span>
            <span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="StartedContainer.run_command"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.StartedContainer.run_command">[docs]</a>    <span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cmd</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">stdout</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">OutputCallback</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stderr</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">OutputCallback</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stdin</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">retry_amount</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run a command in this started container.</span>

<span class="sd">        :param cmd: The command argument list that should be run.</span>
<span class="sd">        :param stdout: A callback that will be called for when we recieve</span>
<span class="sd">            output on stdout. This might not contain full lines, or it might</span>
<span class="sd">            contain multiple lines. If passed a string this is interpreted as a</span>
<span class="sd">            filename, where ``stdout`` is redirected to.</span>
<span class="sd">        :param stderr: Same as ``stdout`` but for output to stderr, only the</span>
<span class="sd">            file option is not supported.</span>
<span class="sd">        :param stdin: The stdin that should be provided to the container.</span>
<span class="sd">        :param user: The user that should run the command. If not provided the</span>
<span class="sd">            command will be executed by the root user.</span>
<span class="sd">        :param check: If ``true`` and exception will be raised when the exit</span>
<span class="sd">            code of the command is not 0.</span>
<span class="sd">        :param retry_amount: The amount of times the command will be retried</span>
<span class="sd">            when the exit code is not 0. This option has to be 1 if ``check``</span>
<span class="sd">            is ``False``.</span>
<span class="sd">        :returns: The exit code of the command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">retry_amount</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">check</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">helpers</span><span class="o">.</span><span class="n">retry_loop</span><span class="p">(</span>
            <span class="n">retry_amount</span><span class="p">,</span>
            <span class="n">sleep_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">make_exception</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">LXCProcessError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Command &quot;</span><span class="si">{cmd}</span><span class="s1">&quot; crashed: </span><span class="si">{ret}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span>
                <span class="n">cmd</span><span class="o">=</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">user</span><span class="p">),</span>
                <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_command</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">,</span>
                <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">,</span>
                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">check</span> <span class="ow">or</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ret</span>

        <span class="k">raise</span> <span class="ne">RuntimeError</span>  <span class="c1"># pragma: no cover</span></div>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">_prepared_output</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stdout</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">OutputCallback</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">stderr</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">OutputCallback</span><span class="p">],</span>
        <span class="n">stdin</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Generator</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">IO</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">BinaryIO</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">BinaryIO</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span>
                             <span class="n">Event</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">],</span> <span class="kc">None</span><span class="p">]],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>

        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">output_dir</span><span class="p">,</span> <span class="p">(</span>
            <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/dev/null&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stdin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">stdin_file</span><span class="p">:</span>
            <span class="n">local_logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">threadlocal</span><span class="o">.</span><span class="n">as_immutable</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stdin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">stdin_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mo">0o777</span><span class="p">)</span>
                <span class="n">stdin_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">stdin</span><span class="p">)</span>
                <span class="n">stdin_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">stdin_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">_make_log_function</span><span class="p">(</span><span class="n">log_location</span><span class="p">:</span> <span class="nb">str</span>
                                   <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">bytes</span><span class="p">],</span> <span class="kc">None</span><span class="p">]:</span>
                <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">__data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">local_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;Got output from command&#39;</span><span class="p">,</span>
                        <span class="n">location</span><span class="o">=</span><span class="n">log_location</span><span class="p">,</span>
                        <span class="n">output</span><span class="o">=</span><span class="n">__data</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">return</span> <span class="n">inner</span>

            <span class="k">def</span> <span class="nf">stderr_inceptor</span><span class="p">(</span><span class="n">__data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">command_started</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">__data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">__data</span> <span class="o">=</span> <span class="n">__data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">command_started</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

                <span class="n">stderr_callback</span><span class="p">(</span><span class="n">__data</span><span class="p">)</span>

            <span class="n">command_started</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
            <span class="n">stop_reader_threads</span> <span class="o">=</span> <span class="n">LockableValue</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">stderr_callback</span> <span class="o">=</span> <span class="n">stderr</span> <span class="ow">or</span> <span class="n">_make_log_function</span><span class="p">(</span><span class="s1">&#39;stderr&#39;</span><span class="p">)</span>

            <span class="n">stderr_fifo</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;stderr&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkfifo</span><span class="p">(</span><span class="n">stderr_fifo</span><span class="p">)</span>

            <span class="n">reader_fifo_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">stderr_fifo</span><span class="p">:</span> <span class="n">stderr_inceptor</span><span class="p">}</span>

            <span class="c1"># If `stdout` is a string this is the path to the file where stdout</span>
            <span class="c1"># should be redirected to.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">stdout_fifo</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;stdout&#39;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkfifo</span><span class="p">(</span><span class="n">stdout_fifo</span><span class="p">)</span>
                <span class="n">stdout_callback</span> <span class="o">=</span> <span class="n">stdout</span> <span class="ow">or</span> <span class="n">_make_log_function</span><span class="p">(</span><span class="s1">&#39;stdout&#39;</span><span class="p">)</span>
                <span class="n">reader_fifo_files</span><span class="p">[</span><span class="n">stdout_fifo</span><span class="p">]</span> <span class="o">=</span> <span class="n">stdout_callback</span>

            <span class="n">reader_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_fifo</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">reader_fifo_files</span><span class="p">,</span> <span class="n">stop_reader_threads</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">reader_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">stop_reader_thread</span><span class="p">(</span><span class="n">wait_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">reader_thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wait_time</span><span class="p">)</span>
                <span class="n">stop_reader_threads</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># The order is really important here! We first need to close the</span>
            <span class="c1"># two fifo files before we join our threads. As otherwise the</span>
            <span class="c1"># threads will hang because they are still reading from these</span>
            <span class="c1"># files.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                    <span class="n">stdout</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">stdout_fifo</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">stderr_fifo</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">(</span>
                        <span class="n">stdin_file</span><span class="p">,</span>
                        <span class="n">out</span><span class="p">,</span>
                        <span class="n">err</span><span class="p">,</span>
                        <span class="n">command_started</span><span class="p">,</span>
                        <span class="n">stop_reader_thread</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">reader_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cmd</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="n">T</span><span class="p">],</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">stdout</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">OutputCallback</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">stderr</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">OutputCallback</span><span class="p">],</span>
        <span class="n">stdin</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span>
        <span class="n">check</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">assert</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="k">with</span> <span class="n">cg_logger</span><span class="o">.</span><span class="n">bound_to_logger</span><span class="p">(</span>
            <span class="n">cmd</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
        <span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepared_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">stdin</span><span class="p">)</span> <span class="k">as</span> <span class="p">[</span>
            <span class="n">stdin_file</span><span class="p">,</span> <span class="n">stdout_file</span><span class="p">,</span> <span class="n">stderr_file</span><span class="p">,</span> <span class="n">command_started</span><span class="p">,</span> <span class="n">stop_reading</span>
        <span class="p">]:</span>
            <span class="n">_maybe_quit_running</span><span class="p">()</span>

            <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span>
                <span class="n">callback</span><span class="p">,</span>
                <span class="n">cmd</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">stdout_file</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">stderr_file</span><span class="p">,</span>
                <span class="n">stdin</span><span class="o">=</span><span class="n">stdin_file</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">left</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">_wait_for_attach</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">command_started</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">res</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="n">_wait_for_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">CommandTimeoutException</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Exception occurred when waiting&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># Wait for 1 second to clear all remaining output.</span>
                <span class="n">left</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Wait for at most a minute to clear all remaining output.</span>
                <span class="n">left</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
                <span class="n">stderr_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">stdout_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">stop_reading</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>

        <span class="n">_maybe_quit_running</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">check</span> <span class="ow">and</span> <span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LXCProcessError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Command &quot;</span><span class="si">{cmd}</span><span class="s1">&quot; crashed: </span><span class="si">{res}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="AutoTestContainer"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.AutoTestContainer">[docs]</a><span class="k">class</span> <span class="nc">AutoTestContainer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This class represents a lxc container that will be used in an AutoTest.</span>

<span class="sd">    This container might be started, not started. To execute commands you</span>
<span class="sd">    should use the :class:`StartedContainer` class which can be obtained using</span>
<span class="sd">    the :meth:`AutoTestContainer.started_container` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="s1">&#39;psef.FlaskConfig&#39;</span><span class="p">,</span>
        <span class="n">cont</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">lxc</span><span class="o">.</span><span class="n">Container</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="k">if</span> <span class="n">cont</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cont</span> <span class="o">=</span> <span class="n">lxc</span><span class="o">.</span><span class="n">Container</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cont</span> <span class="o">=</span> <span class="n">cont</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the name of this container.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

<div class="viewcode-block" id="AutoTestContainer.create"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.AutoTestContainer.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a backing lxc container for this AutoTestContainer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cont</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="s1">&#39;download&#39;</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="p">{</span>
                <span class="s1">&#39;dist&#39;</span><span class="p">:</span> <span class="s1">&#39;ubuntu&#39;</span><span class="p">,</span>
                <span class="s1">&#39;release&#39;</span><span class="p">:</span> <span class="s1">&#39;bionic&#39;</span><span class="p">,</span>
                <span class="s1">&#39;arch&#39;</span><span class="p">:</span> <span class="s1">&#39;amd64&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">bdevtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;AUTO_TEST_BDEVTYPE&#39;</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AutoTestContainer.started_container"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.AutoTestContainer.started_container">[docs]</a>    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">started_container</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Generator</span><span class="p">[</span><span class="n">StartedContainer</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Start a block wherein this container is started.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">started</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_container</span><span class="p">()</span>
            <span class="n">started</span> <span class="o">=</span> <span class="n">StartedContainer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cont</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">started</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_container</span><span class="p">(</span><span class="n">started</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">start_container</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_start_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cont</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">destroy_container</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cont</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_stop_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cont</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">StartedContainer</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">cg_logger</span><span class="o">.</span><span class="n">bound_to_logger</span><span class="p">(</span><span class="n">cont</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_stop_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cont</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cont</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Destroying snapshots&#39;</span><span class="p">)</span>
                    <span class="n">cont</span><span class="o">.</span><span class="n">destroy_snapshots</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">timed_code</span><span class="p">(</span><span class="s1">&#39;destroy_container&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">destroy_container</span><span class="p">()</span>

<div class="viewcode-block" id="AutoTestContainer.clone"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.AutoTestContainer.clone">[docs]</a>    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">new_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;AutoTestContainer&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Clone this container to a new container.</span>

<span class="sd">        :param new_name: The name of the new container, will be randomly</span>
<span class="sd">            generated if not provided.</span>
<span class="sd">        :returns: A clone of this container with the provided name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_maybe_quit_running</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">,</span> <span class="n">timed_code</span><span class="p">(</span><span class="s1">&#39;clone_container&#39;</span><span class="p">):</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">new_name</span> <span class="ow">or</span> <span class="n">_get_new_container_name</span><span class="p">()</span>
            <span class="n">cont</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cont</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cont</span><span class="p">,</span> <span class="n">lxc</span><span class="o">.</span><span class="n">Container</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">new_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span> <span class="n">cont</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AutoTestRunner"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.AutoTestRunner">[docs]</a><span class="k">class</span> <span class="nc">AutoTestRunner</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This class contains all functionality needed to run a single AutoTest.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span> <span class="n">instructions</span><span class="p">:</span> <span class="n">RunnerInstructions</span><span class="p">,</span>
        <span class="n">global_password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="s1">&#39;psef.FlaskConfig&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_global_password</span> <span class="o">=</span> <span class="n">global_password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span> <span class="o">=</span> <span class="n">instructions</span>
        <span class="n">result_ids</span> <span class="o">=</span> <span class="n">instructions</span><span class="p">[</span><span class="s1">&#39;result_ids&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">cg_worker_pool</span><span class="o">.</span><span class="n">Work</span><span class="p">(</span><span class="n">result_id</span><span class="o">=</span><span class="n">result_id</span><span class="p">,</span> <span class="n">student_id</span><span class="o">=</span><span class="n">student_id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">result_id</span><span class="p">,</span> <span class="n">student_id</span> <span class="ow">in</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">result_ids</span><span class="p">,</span> <span class="n">instructions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;student_ids&#39;</span><span class="p">,</span> <span class="n">result_ids</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_test_id</span> <span class="o">=</span> <span class="n">instructions</span><span class="p">[</span><span class="s1">&#39;auto_test_id&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_script</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="s1">&#39;setup_script&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{base_url}</span><span class="s1">/api/v-internal/auto_tests/</span><span class="si">{self.auto_test_id}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fixtures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="s1">&#39;fixtures&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reqs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_amount_of_needed_workers</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the amount of needed workers.</span>

<span class="sd">        &gt;&gt;&gt; AutoTestRunner._get_amount_of_needed_workers() &gt;= 4</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_get_amount_cpus</span><span class="p">()</span> <span class="o">+</span> <span class="mi">4</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_should_poll_after_done</span><span class="p">(</span><span class="n">instructions</span><span class="p">:</span> <span class="n">RunnerInstructions</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Should we poll after done.</span>

<span class="sd">        &gt;&gt;&gt; AutoTestRunner._should_poll_after_done({})</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; AutoTestRunner._should_poll_after_done({&#39;poll_after_done&#39;: True})</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">instructions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;poll_after_done&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_worker_pool</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">base_container_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">cpu_cores</span><span class="p">:</span> <span class="n">CpuCores</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cg_worker_pool</span><span class="o">.</span><span class="n">WorkerPool</span><span class="p">:</span>
        <span class="n">mult</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_should_poll_after_done</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cg_worker_pool</span><span class="o">.</span><span class="n">WorkerPool</span><span class="p">(</span>
            <span class="c1"># Over provision a bit so clones can be made quicker.</span>
            <span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_amount_of_needed_workers</span><span class="p">(),</span>
            <span class="n">function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">get_work</span><span class="p">:</span>
            <span class="n">_run_student</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_container_name</span><span class="p">,</span> <span class="n">cpu_cores</span><span class="p">,</span> <span class="n">get_work</span><span class="p">),</span>
            <span class="n">sleep_time</span><span class="o">=</span><span class="n">mult</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;AUTO_TEST_CF_SLEEP_TIME&#39;</span><span class="p">],</span>
            <span class="n">extra_amount</span><span class="o">=</span><span class="n">mult</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;AUTO_TEST_CF_EXTRA_AMOUNT&#39;</span><span class="p">],</span>
            <span class="n">initial_work</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_work_producer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">last_call</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">cg_worker_pool</span><span class="o">.</span><span class="n">Work</span><span class="p">]:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{self.base_url}</span><span class="s1">/runs/</span><span class="si">{self.instructions[&quot;run_id&quot;]}</span><span class="s1">/&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;results/?last_call=</span><span class="si">{last_call}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">_REQUEST_TIMEOUT</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">cg_worker_pool</span><span class="o">.</span><span class="n">Work</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_make_req_key</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &gt;&gt;&gt; import threading, multiprocessing</span>
<span class="sd">        &gt;&gt;&gt; key = AutoTestRunner._make_req_key()</span>
<span class="sd">        &gt;&gt;&gt; key == AutoTestRunner._make_req_key()</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; def test_f(): print(AutoTestRunner._make_req_key() == key)</span>
<span class="sd">        &gt;&gt;&gt; def test_ff(): assert AutoTestRunner._make_req_key() == key</span>
<span class="sd">        &gt;&gt;&gt; t = threading.Thread(target=test_f)</span>
<span class="sd">        &gt;&gt;&gt; t.start(); t.join()</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; p = multiprocessing.Process(target=test_ff)</span>
<span class="sd">        &gt;&gt;&gt; p.start(); p.join()</span>
<span class="sd">        &gt;&gt;&gt; p.exitcode == 1</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; key == AutoTestRunner._make_req_key()</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_retry_adapter</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">HTTPAdapter</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HTTPAdapter</span><span class="p">(</span>
            <span class="n">max_retries</span><span class="o">=</span><span class="n">Retry</span><span class="p">(</span>
                <span class="n">total</span><span class="o">=</span><span class="n">_REQUEST_RETRIES</span><span class="p">,</span>
                <span class="n">read</span><span class="o">=</span><span class="n">_REQUEST_RETRIES</span><span class="p">,</span>
                <span class="n">connect</span><span class="o">=</span><span class="n">_REQUEST_RETRIES</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="n">_REQUEST_RETRIES</span><span class="p">,</span>
                <span class="n">backoff_factor</span><span class="o">=</span><span class="n">_REQUEST_BACKOFF_FACTOR</span><span class="p">,</span>
                <span class="n">method_whitelist</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(</span>
                    <span class="p">[</span><span class="o">*</span><span class="n">Retry</span><span class="o">.</span><span class="n">DEFAULT_METHOD_WHITELIST</span><span class="p">,</span> <span class="s1">&#39;PATCH&#39;</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">status_forcelist</span><span class="o">=</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">501</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">504</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">req</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a request session unique for this thread and process.</span>

<span class="sd">        :returns: A requests session unique for this thread and process that</span>
<span class="sd">            has the correct headers for authentication.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_req_key</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reqs</span><span class="p">:</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
            <span class="n">req</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s1">&#39;CG-Internal-Api-Password&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_password</span><span class="p">,</span>
                    <span class="s1">&#39;CG-Internal-Api-Runner-Password&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_password</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">adapter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_retry_adapter</span><span class="p">()</span>
            <span class="n">req</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;http://&#39;</span><span class="p">,</span> <span class="n">adapter</span><span class="p">)</span>
            <span class="n">req</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;https://&#39;</span><span class="p">,</span> <span class="n">adapter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reqs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reqs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_local_password</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="s2">&quot;runner_id&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_wget_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">&#39;--header&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;CG-Internal-Api-Password: </span><span class="si">{self._global_password}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--header&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;CG-Internal-Api-Runner-Password: </span><span class="si">{self._local_password}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">]</span>

<div class="viewcode-block" id="AutoTestRunner.download_file"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.AutoTestRunner.download_file">[docs]</a>    <span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cont</span><span class="p">:</span> <span class="n">StartedContainer</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">dst</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">from_home</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Download the given url to the given destination.</span>

<span class="sd">        :param cont: The container in which to download the files.</span>
<span class="sd">        :param url: The url from which to download the files.</span>
<span class="sd">        :param dst: The path in the container where to store the file.</span>
<span class="sd">        :param from_home: Should the ``dst`` path be interpreted as a relative</span>
<span class="sd">            path from the home directory of the codegrade user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">from_home</span><span class="p">:</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;{_get_home_dir(CODEGRADE_USER)}/</span><span class="si">{dst}</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">helpers</span><span class="o">.</span><span class="n">retry_loop</span><span class="p">(</span>
            <span class="n">_REQUEST_RETRIES</span><span class="p">,</span>
            <span class="n">sleep_time</span><span class="o">=</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span>
                <span class="n">_REQUEST_BACKOFF_FACTOR</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="n">Retry</span><span class="o">.</span><span class="n">BACKOFF_MAX</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">make_exception</span><span class="o">=</span><span class="n">StopRunningStudentException</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">cont</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s1">&#39;wget&#39;</span><span class="p">,</span>
                    <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_wget_headers</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{self.base_url}</span><span class="s1">/</span><span class="si">{url}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;-O&#39;</span><span class="p">,</span>
                    <span class="n">dst</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">user</span><span class="o">=</span><span class="n">CODEGRADE_USER</span><span class="p">,</span>
                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">cont</span><span class="o">.</span><span class="n">run_command</span><span class="p">([</span><span class="s1">&#39;chmod&#39;</span><span class="p">,</span> <span class="s1">&#39;-R&#39;</span><span class="p">,</span> <span class="s1">&#39;750&#39;</span><span class="p">,</span> <span class="n">dst</span><span class="p">],</span> <span class="n">user</span><span class="o">=</span><span class="n">CODEGRADE_USER</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Downloaded file&#39;</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutoTestRunner.download_fixtures"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.AutoTestRunner.download_fixtures">[docs]</a>    <span class="k">def</span> <span class="nf">download_fixtures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cont</span><span class="p">:</span> <span class="n">StartedContainer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Download all the fixtures of this test.</span>

<span class="sd">        :param cont: The container in which the fixtures should be downloaded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fixture_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixtures</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span>
                <span class="n">cont</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;fixtures/</span><span class="si">{fixture_id}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{cont.fixtures_dir}{name}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">from_home</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">cont</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;ls&#39;</span><span class="p">,</span> <span class="s1">&#39;-hl&#39;</span><span class="p">,</span> <span class="n">cont</span><span class="o">.</span><span class="n">fixtures_dir</span><span class="p">],</span>
            <span class="n">user</span><span class="o">=</span><span class="n">CODEGRADE_USER</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AutoTestRunner.download_student_code"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.AutoTestRunner.download_student_code">[docs]</a>    <span class="nd">@timed_function</span>
    <span class="k">def</span> <span class="nf">download_student_code</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cont</span><span class="p">:</span> <span class="n">StartedContainer</span><span class="p">,</span> <span class="n">result_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Download the code of the student.</span>

<span class="sd">        :param cont: The lxc container in which to download the code.</span>
<span class="sd">        :param result_id: The id of the code which should be downloaded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;results/</span><span class="si">{result_id}</span><span class="s1">?type=submission_files&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">cont</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="s1">&#39;student.zip&#39;</span><span class="p">)</span>

        <span class="n">cont</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s1">&#39;unzip&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;{_get_home_dir(CODEGRADE_USER)}/student.zip&#39;</span><span class="p">,</span> <span class="s1">&#39;-d&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;{_get_home_dir(CODEGRADE_USER)}/student/&#39;</span>
            <span class="p">],</span>
            <span class="n">user</span><span class="o">=</span><span class="n">CODEGRADE_USER</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Extracted student code&#39;</span><span class="p">)</span>

        <span class="n">cont</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;chmod&#39;</span><span class="p">,</span> <span class="s1">&#39;-R&#39;</span><span class="p">,</span> <span class="s1">&#39;+x&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;{_get_home_dir(CODEGRADE_USER)}/student/&#39;</span><span class="p">],</span>
            <span class="n">user</span><span class="o">=</span><span class="n">CODEGRADE_USER</span>
        <span class="p">)</span>
        <span class="n">cont</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;{_get_home_dir(CODEGRADE_USER)}/student.zip&#39;</span><span class="p">]</span>
        <span class="p">)</span></div>

    <span class="nd">@timed_function</span>
    <span class="k">def</span> <span class="nf">_upload_output_folder</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cont</span><span class="p">:</span> <span class="n">StartedContainer</span><span class="p">,</span>
        <span class="n">result_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">test_suite</span><span class="p">:</span> <span class="n">SuiteInstructions</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">has_files</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">def</span> <span class="nf">stdout_callback</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">nonlocal</span> <span class="n">has_files</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                <span class="n">has_files</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">cont</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;find&#39;</span><span class="p">,</span> <span class="n">cont</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;-type&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">],</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">stdout_callback</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_files</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">tfile</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">tfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mo">0o777</span><span class="p">)</span>
            <span class="n">cont</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;tar&#39;</span><span class="p">,</span> <span class="s1">&#39;cjf&#39;</span><span class="p">,</span> <span class="s1">&#39;/dev/stdout&#39;</span><span class="p">,</span> <span class="n">cont</span><span class="o">.</span><span class="n">output_dir</span><span class="p">],</span>
                <span class="n">user</span><span class="o">=</span><span class="n">CODEGRADE_USER</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">tfile</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
            <span class="n">tfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">suite_id</span> <span class="o">=</span> <span class="n">test_suite</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{base}</span><span class="s1">/results/</span><span class="si">{result_id}</span><span class="s1">/suites/</span><span class="si">{suite_id}</span><span class="s1">/files/&#39;</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span>
                <span class="n">files</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;f.tar.bz2&#39;</span><span class="p">,</span> <span class="n">tfile</span><span class="p">,</span> <span class="s1">&#39;application/octet-stream&#39;</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Uploaded files to server&#39;</span><span class="p">,</span>
                <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                <span class="n">response_content</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">content</span>
            <span class="p">)</span>

    <span class="nd">@timed_function</span>
    <span class="k">def</span> <span class="nf">_run_test_suite</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">student_container</span><span class="p">:</span> <span class="n">StartedContainer</span><span class="p">,</span> <span class="n">result_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">test_suite</span><span class="p">:</span> <span class="n">SuiteInstructions</span><span class="p">,</span> <span class="n">cpu_core</span><span class="p">:</span> <span class="n">CpuCores</span><span class="o">.</span><span class="n">Core</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">total_points</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">possible_points</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">def</span> <span class="nf">yield_core</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">snap</span><span class="o">.</span><span class="n">stopped_container</span><span class="p">():</span>
                <span class="n">cpu_core</span><span class="o">.</span><span class="n">yield_core</span><span class="p">()</span>
            <span class="n">snap</span><span class="o">.</span><span class="n">pin_to_core</span><span class="p">(</span><span class="n">cpu_core</span><span class="o">.</span><span class="n">get_core_number</span><span class="p">())</span>

        <span class="k">with</span> <span class="n">student_container</span><span class="o">.</span><span class="n">as_snapshot</span><span class="p">(</span>
            <span class="n">test_suite</span><span class="p">[</span><span class="s1">&#39;network_disabled&#39;</span><span class="p">]</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">snap</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{self.base_url}</span><span class="s1">/results/</span><span class="si">{result_id}</span><span class="s1">/step_results/&#39;</span>

            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">test_step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_suite</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">]):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running step&#39;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">test_step</span><span class="p">)</span>
                <span class="n">step_result_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">def</span> <span class="nf">update_test_result</span><span class="p">(</span>
                    <span class="n">state</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="p">,</span>
                    <span class="n">log</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span>
                    <span class="n">test_step</span><span class="p">:</span> <span class="n">StepInstructions</span> <span class="o">=</span> <span class="n">test_step</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">nonlocal</span> <span class="n">step_result_id</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="n">log</span><span class="p">,</span>
                        <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="s1">&#39;auto_test_step_id&#39;</span><span class="p">:</span> <span class="n">test_step</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="n">step_result_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_result_id</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Posting result data&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                        <span class="n">url</span><span class="p">,</span>
                        <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="n">_REQUEST_TIMEOUT</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Posted result data&#39;</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                    <span class="n">step_result_id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

                <span class="n">typ</span> <span class="o">=</span> <span class="n">auto_test_handlers</span><span class="p">[</span><span class="n">test_step</span><span class="p">[</span><span class="s1">&#39;test_type_name&#39;</span><span class="p">]]</span>

                <span class="k">with</span> <span class="n">timed_code</span><span class="p">(</span><span class="s1">&#39;run_suite_step&#39;</span>
                                <span class="p">)</span> <span class="k">as</span> <span class="n">get_step_time</span><span class="p">,</span> <span class="n">cg_logger</span><span class="o">.</span><span class="n">bound_to_logger</span><span class="p">(</span>
                                    <span class="n">test_step</span><span class="o">=</span><span class="n">test_step</span>
                                <span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">total_points</span> <span class="o">+=</span> <span class="n">typ</span><span class="o">.</span><span class="n">execute_step</span><span class="p">(</span>
                            <span class="n">snap</span><span class="p">,</span>
                            <span class="n">ExecuteOptions</span><span class="p">(</span>
                                <span class="n">update_test_result</span><span class="o">=</span><span class="n">update_test_result</span><span class="p">,</span>
                                <span class="n">test_instructions</span><span class="o">=</span><span class="n">test_step</span><span class="p">,</span>
                                <span class="n">achieved_percentage</span><span class="o">=</span><span class="n">helpers</span><span class="o">.</span><span class="n">safe_div</span><span class="p">(</span>
                                    <span class="n">total_points</span><span class="p">,</span> <span class="n">possible_points</span><span class="p">,</span> <span class="mi">1</span>
                                <span class="p">),</span>
                                <span class="n">yield_core</span><span class="o">=</span><span class="n">yield_core</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="n">StopRunningStepsException</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Stopping steps&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="c1"># We still need the correct amount of possible points,</span>
                        <span class="c1"># so we update it here.</span>
                        <span class="n">possible_points</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span>
                            <span class="n">ts</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">test_suite</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">][</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
                        <span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">except</span> <span class="n">CommandTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Command timed out&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">update_test_result</span><span class="p">(</span>
                            <span class="n">models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="o">.</span><span class="n">timed_out</span><span class="p">,</span> <span class="p">{</span>
                                <span class="s1">&#39;exit_code&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">EXIT_CODE</span><span class="p">,</span>
                                <span class="s1">&#39;stdout&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                <span class="s1">&#39;stderr&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                                <span class="s1">&#39;time_spend&#39;</span><span class="p">:</span> <span class="n">get_step_time</span><span class="p">(),</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                        <span class="n">yield_core</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finished step&#39;</span><span class="p">,</span> <span class="n">total_points</span><span class="o">=</span><span class="n">total_points</span><span class="p">)</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="n">possible_points</span> <span class="o">+=</span> <span class="n">test_step</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_upload_output_folder</span><span class="p">(</span><span class="n">snap</span><span class="p">,</span> <span class="n">result_id</span><span class="p">,</span> <span class="n">test_suite</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">total_points</span><span class="p">,</span> <span class="n">possible_points</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_is_old_submission_error</span><span class="p">(</span>
        <span class="n">exc</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the given exception is a ``NOT_NEWEST_SUBMSSION`` error.</span>

<span class="sd">        &gt;&gt;&gt; f = AutoTestRunner._is_old_submission_error</span>
<span class="sd">        &gt;&gt;&gt; f(Exception())</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; r = requests.HTTPError()</span>
<span class="sd">        &gt;&gt;&gt; f(r)</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; r.response = requests.get(&#39;https://google.com&#39;)</span>
<span class="sd">        &gt;&gt;&gt; f(r)</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; # Get {&quot;code&quot;: &quot;NOPE&quot;}</span>
<span class="sd">        &gt;&gt;&gt; r.response = requests.get(&#39;http://www.mocky.io/v2/5d9e5e2d320000c532329d37&#39;)</span>
<span class="sd">        &gt;&gt;&gt; f(r)</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; f(r.response)</span>
<span class="sd">        False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">response</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">exc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">APICodes</span><span class="o">.</span><span class="n">NOT_NEWEST_SUBMSSION</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@timed_function</span>
    <span class="k">def</span> <span class="nf">_run_student</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cont</span><span class="p">:</span> <span class="n">StartedContainer</span><span class="p">,</span>
        <span class="n">cpu</span><span class="p">:</span> <span class="n">CpuCores</span><span class="o">.</span><span class="n">Core</span><span class="p">,</span>
        <span class="n">result_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">result_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{self.base_url}</span><span class="s1">/results/</span><span class="si">{result_id}</span><span class="s1">&#39;</span>

        <span class="n">result_state</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="p">]</span>
        <span class="n">result_state</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="o">.</span><span class="n">passed</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">timed_code</span><span class="p">(</span><span class="s1">&#39;set_cgroup_limits&#39;</span><span class="p">):</span>
                <span class="n">cont</span><span class="o">.</span><span class="n">set_cgroup_item</span><span class="p">(</span>
                    <span class="s1">&#39;memory.limit_in_bytes&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;AUTO_TEST_MEMORY_LIMIT&#39;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">cont</span><span class="o">.</span><span class="n">pin_to_core</span><span class="p">(</span><span class="n">cpu</span><span class="o">.</span><span class="n">get_core_number</span><span class="p">())</span>
                <span class="n">cont</span><span class="o">.</span><span class="n">set_cgroup_item</span><span class="p">(</span>
                    <span class="s1">&#39;memory.memsw.limit_in_bytes&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;AUTO_TEST_MEMORY_LIMIT&#39;</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">download_student_code</span><span class="p">(</span><span class="n">cont</span><span class="p">,</span> <span class="n">result_id</span><span class="p">)</span>

            <span class="n">cont</span><span class="o">.</span><span class="n">move_fixtures_dir</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_run_setup</span><span class="p">(</span><span class="n">cont</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_script</span><span class="p">,</span> <span class="n">result_url</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dropping sudo rights&#39;</span><span class="p">)</span>
            <span class="n">cont</span><span class="o">.</span><span class="n">run_command</span><span class="p">([</span><span class="s1">&#39;deluser&#39;</span><span class="p">,</span> <span class="n">CODEGRADE_USER</span><span class="p">,</span> <span class="s1">&#39;sudo&#39;</span><span class="p">])</span>
            <span class="c1"># TODO: escape the codegrade user here if that is needed</span>
            <span class="n">cont</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;sed&#39;</span><span class="p">,</span> <span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;s/^</span><span class="si">{CODEGRADE_USER}</span><span class="s1">.*$//g&#39;</span><span class="p">,</span> <span class="s1">&#39;/etc/sudoers&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="n">cont</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;grep&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="n">CODEGRADE_USER</span><span class="p">,</span> <span class="s1">&#39;/etc/sudoers&#39;</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Sudo was not dropped!&#39;</span>

            <span class="n">cont</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s1">&#39;/bin/bash&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;-c&#39;</span><span class="p">,</span>
                    <span class="p">(</span>
                        <span class="s1">&#39;mkdir -p &quot;</span><span class="si">{output_dir}</span><span class="s1">&quot; &amp;&amp; &#39;</span>
                        <span class="s1">&#39;chown -R </span><span class="si">{user}</span><span class="s1">:&quot;$(id -gn </span><span class="si">{user}</span><span class="s1">)&quot; &quot;</span><span class="si">{output_dir}</span><span class="s1">&quot; &amp;&amp; &#39;</span>
                        <span class="s1">&#39;chmod 770 &quot;</span><span class="si">{output_dir}</span><span class="s1">&quot;&#39;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">output_dir</span><span class="o">=</span><span class="n">OUTPUT_DIR</span><span class="p">,</span>
                        <span class="n">user</span><span class="o">=</span><span class="n">CODEGRADE_USER</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="n">total_points</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">possible_points</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">for</span> <span class="n">test_set</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="s1">&#39;sets&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">test_suite</span> <span class="ow">in</span> <span class="n">test_set</span><span class="p">[</span><span class="s1">&#39;suites&#39;</span><span class="p">]:</span>
                    <span class="n">cont</span><span class="o">.</span><span class="n">move_fixtures_dir</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">)</span>
                    <span class="n">achieved_points</span><span class="p">,</span> <span class="n">suite_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_test_suite</span><span class="p">(</span>
                        <span class="n">cont</span><span class="p">,</span> <span class="n">result_id</span><span class="p">,</span> <span class="n">test_suite</span><span class="p">,</span> <span class="n">cpu</span>
                    <span class="p">)</span>
                    <span class="n">total_points</span> <span class="o">+=</span> <span class="n">achieved_points</span>
                    <span class="n">possible_points</span> <span class="o">+=</span> <span class="n">suite_points</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;Finished suite&#39;</span><span class="p">,</span>
                        <span class="n">total_points</span><span class="o">=</span><span class="n">total_points</span><span class="p">,</span>
                        <span class="n">test_suite</span><span class="o">=</span><span class="n">test_suite</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Finished set&#39;</span><span class="p">,</span>
                    <span class="n">total_points</span><span class="o">=</span><span class="n">total_points</span><span class="p">,</span>
                    <span class="n">stop_points</span><span class="o">=</span><span class="n">test_set</span><span class="p">[</span><span class="s1">&#39;stop_points&#39;</span><span class="p">],</span>
                    <span class="n">test_set</span><span class="o">=</span><span class="n">test_set</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">helpers</span><span class="o">.</span><span class="n">FloatHelpers</span><span class="o">.</span><span class="n">le</span><span class="p">(</span>
                    <span class="n">helpers</span><span class="o">.</span><span class="n">safe_div</span><span class="p">(</span><span class="n">total_points</span><span class="p">,</span> <span class="n">possible_points</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">test_set</span><span class="p">[</span><span class="s1">&#39;stop_points&#39;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="k">break</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">StopRunningStudentException</span><span class="p">,</span> <span class="o">*</span><span class="n">NETWORK_EXCEPTIONS</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">result_state</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_old_submission_error</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Was running old submission&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;HTTP error, so stopping this student&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">StopRunningTestsException</span><span class="p">:</span>
            <span class="n">result_state</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Stop running steps&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Something went wrong&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">result_state</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="o">.</span><span class="n">failed</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result_state</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="o">.</span><span class="n">passed</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
                    <span class="n">result_url</span><span class="p">,</span>
                    <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">result_state</span><span class="o">.</span><span class="n">name</span><span class="p">},</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">_REQUEST_TIMEOUT</span><span class="p">,</span>
                <span class="p">)</span>

<div class="viewcode-block" id="AutoTestRunner.run_student"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.AutoTestRunner.run_student">[docs]</a>    <span class="k">def</span> <span class="nf">run_student</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">base_container_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cpu_cores</span><span class="p">:</span> <span class="n">CpuCores</span><span class="p">,</span>
        <span class="n">opts</span><span class="p">:</span> <span class="n">cg_worker_pool</span><span class="o">.</span><span class="n">CallbackArguments</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run the test for a single student.</span>

<span class="sd">        :param base_container_name: The name of the base lxc container.</span>
<span class="sd">        :param cpu_cores: The cpu cores which are available during testing.</span>
<span class="sd">        :param result_id: The id of the student to run.</span>
<span class="sd">        :param opts: The way to get work from the worker pool.</span>
<span class="sd">        :returns: Nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_container</span> <span class="o">=</span> <span class="n">AutoTestContainer</span><span class="p">(</span><span class="n">base_container_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">student_container</span> <span class="o">=</span> <span class="n">base_container</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">retry_work</span><span class="p">(</span><span class="n">work</span><span class="p">:</span> <span class="n">cg_worker_pool</span><span class="o">.</span><span class="n">Work</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{self.base_url}</span><span class="s1">/results/</span><span class="si">{work.result_id}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;state&#39;</span><span class="p">:</span>
                            <span class="n">models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="o">.</span><span class="n">not_started</span><span class="o">.</span><span class="n">name</span>
                    <span class="p">},</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">_REQUEST_TIMEOUT</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>  <span class="c1"># pylint: disable=bare-except</span>
                <span class="k">pass</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">opts</span><span class="o">.</span><span class="n">retry_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">student_container</span><span class="o">.</span><span class="n">started_container</span><span class="p">()</span> <span class="k">as</span> <span class="n">cont</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">work</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">get_work</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">work</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">result_id</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">result_id</span>

                <span class="k">with</span> <span class="n">cpu_cores</span><span class="o">.</span><span class="n">reserved_core</span><span class="p">()</span> <span class="k">as</span> <span class="n">cpu</span><span class="p">:</span>
                    <span class="n">patch_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{self.base_url}</span><span class="s1">/results/</span><span class="si">{result_id}</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                            <span class="s1">&#39;state&#39;</span><span class="p">:</span>
                                <span class="n">models</span><span class="o">.</span><span class="n">AutoTestStepResultState</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">name</span>
                        <span class="p">},</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="n">_REQUEST_TIMEOUT</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">patch_res</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_old_submission_error</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                            <span class="n">retry_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">patch_res</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span> <span class="ow">or</span>
                        <span class="ow">not</span> <span class="n">patch_res</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;taken&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="k">with</span> <span class="n">cg_logger</span><span class="o">.</span><span class="n">bound_to_logger</span><span class="p">(</span><span class="n">result_id</span><span class="o">=</span><span class="n">result_id</span><span class="p">):</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_student</span><span class="p">(</span><span class="n">cont</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">result_id</span><span class="p">):</span>
                                <span class="c1"># Student didn&#39;t finish correctly. So put back</span>
                                <span class="c1"># in the queue. The retry function contains the</span>
                                <span class="c1"># functionality for only retrying a fixed</span>
                                <span class="c1"># amount of time.</span>
                                <span class="n">retry_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
                            <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_started_heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;RepeatedTimer&#39;</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">push_heartbeat</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{self.base_url}</span><span class="s1">/runs/</span><span class="si">{self.instructions[&quot;run_id&quot;]}</span><span class="s1">/&#39;</span>
                <span class="s1">&#39;heartbeats/&#39;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">_REQUEST_TIMEOUT</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

        <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="s1">&#39;heartbeat_interval&#39;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting heartbeat interval&#39;</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RepeatedTimer</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="n">push_heartbeat</span><span class="p">)</span>

<div class="viewcode-block" id="AutoTestRunner.run_test"><a class="viewcode-back" href="../../psef_api/psef.html#psef.auto_test.AutoTestRunner.run_test">[docs]</a>    <span class="k">def</span> <span class="nf">run_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cont</span><span class="p">:</span> <span class="n">StartedContainer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run the test for all students using the given container as base.</span>

<span class="sd">        :param cont: The base container used for all students.</span>
<span class="sd">        :returns: Nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">run_result_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{self.base_url}</span><span class="s1">/runs/</span><span class="si">{self.instructions[&quot;run_id&quot;]}</span><span class="s1">&#39;</span>
        <span class="n">time_taken</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_started_heartbeat</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">timed_code</span><span class="p">(</span><span class="s1">&#39;run_complete_auto_test&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">get_time_taken</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_run_test</span><span class="p">(</span><span class="n">cont</span><span class="p">)</span>
                <span class="n">time_taken</span> <span class="o">=</span> <span class="n">get_time_taken</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
                    <span class="n">run_result_url</span><span class="p">,</span>
                    <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="s1">&#39;stopped&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;time_taken&#39;</span><span class="p">:</span> <span class="n">time_taken</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">_REQUEST_TIMEOUT</span><span class="p">,</span>
                <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_maybe_run_setup</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cont</span><span class="p">:</span> <span class="s1">&#39;StartedContainer&#39;</span><span class="p">,</span>
        <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">timed_code</span><span class="p">(</span><span class="s1">&#39;run_setup_script&#39;</span><span class="p">,</span> <span class="n">setup_cmd</span><span class="o">=</span><span class="n">cmd</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">cont</span><span class="o">.</span><span class="n">run_student_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span>
                <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;setup_time_spend&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">time_spend</span><span class="p">,</span>
                    <span class="s1">&#39;setup_stdout&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                    <span class="s1">&#39;setup_stderr&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">stderr</span>
                <span class="p">},</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">_REQUEST_TIMEOUT</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cont</span><span class="p">:</span> <span class="n">StartedContainer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">helpers</span><span class="o">.</span><span class="n">ensure_on_test_server</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">timed_code</span><span class="p">(</span><span class="s1">&#39;run_setup_commands&#39;</span><span class="p">):</span>
            <span class="n">cont</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s1">&#39;/bin/bash&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;-c&#39;</span><span class="p">,</span>
                    <span class="p">(</span>
                        <span class="s1">&#39;adduser --shell /bin/bash --disabled-password --gecos&#39;</span>
                        <span class="s1">&#39; &quot;&quot; </span><span class="si">{user}</span><span class="s1"> &amp;&amp; &#39;</span>
                        <span class="s1">&#39;mkdir -p &quot;</span><span class="si">{home_dir}</span><span class="s1">/student/&quot; &amp;&amp; &#39;</span>
                        <span class="s1">&#39;mkdir -p &quot;</span><span class="si">{fixtures_root}</span><span class="s1">/</span><span class="si">{fixtures}</span><span class="s1">&quot; &amp;&amp; &#39;</span>
                        <span class="s1">&#39;chown -R </span><span class="si">{user}</span><span class="s1">:&quot;$(id -gn </span><span class="si">{user}</span><span class="s1">)&quot; &quot;</span><span class="si">{home_dir}</span><span class="s1">&quot; &amp;&amp; &#39;</span>
                        <span class="s1">&#39;chown -R </span><span class="si">{user}</span><span class="s1">:&quot;$(id -gn </span><span class="si">{user}</span><span class="s1">)&quot; &quot;</span><span class="si">{fixtures_root}</span><span class="s1">&quot; &amp;&amp; &#39;</span>
                        <span class="s1">&#39;chmod 110 &quot;</span><span class="si">{fixtures_root}</span><span class="s1">&quot;&#39;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">user</span><span class="o">=</span><span class="n">CODEGRADE_USER</span><span class="p">,</span>
                        <span class="n">home_dir</span><span class="o">=</span><span class="n">_get_home_dir</span><span class="p">(</span><span class="n">CODEGRADE_USER</span><span class="p">),</span>
                        <span class="n">fixtures</span><span class="o">=</span><span class="n">PRE_STUDENT_FIXTURES_DIR</span><span class="p">,</span>
                        <span class="n">fixtures_root</span><span class="o">=</span><span class="n">FIXTURES_ROOT</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">],</span>
            <span class="p">)</span>

            <span class="n">cont</span><span class="o">.</span><span class="n">run_command</span><span class="p">([</span><span class="s1">&#39;usermod&#39;</span><span class="p">,</span> <span class="s1">&#39;-aG&#39;</span><span class="p">,</span> <span class="s1">&#39;sudo&#39;</span><span class="p">,</span> <span class="n">CODEGRADE_USER</span><span class="p">])</span>

            <span class="n">cont</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;tee&#39;</span><span class="p">,</span> <span class="s1">&#39;--append&#39;</span><span class="p">,</span> <span class="s1">&#39;/etc/sudoers&#39;</span><span class="p">],</span>
                <span class="n">stdin</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{CODEGRADE_USER}</span><span class="s1"> ALL=(ALL) NOPASSWD: ALL</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">cont</span><span class="o">.</span><span class="n">run_command</span><span class="p">([</span><span class="s1">&#39;grep&#39;</span><span class="p">,</span> <span class="n">CODEGRADE_USER</span><span class="p">,</span> <span class="s1">&#39;/etc/sudoers&#39;</span><span class="p">])</span>

        <span class="k">with</span> <span class="n">timed_code</span><span class="p">(</span><span class="s1">&#39;download_fixtures&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download_fixtures</span><span class="p">(</span><span class="n">cont</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_run_setup</span><span class="p">(</span>
            <span class="n">cont</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">[</span><span class="s1">&#39;run_setup_script&#39;</span><span class="p">],</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{self.base_url}</span><span class="s1">/runs/</span><span class="si">{self.instructions[&quot;run_id&quot;]}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{FIXTURES_ROOT}</span><span class="s1">/</span><span class="si">{PRE_STUDENT_FIXTURES_DIR}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">cont</span><span class="o">.</span><span class="n">stopped_container</span><span class="p">()</span> <span class="k">as</span> <span class="n">base_container</span><span class="p">,</span> <span class="n">timed_code</span><span class="p">(</span>
            <span class="s1">&#39;run_all_students&#39;</span>
        <span class="p">),</span> <span class="n">_Manager</span><span class="p">()</span> <span class="k">as</span> <span class="n">manager</span><span class="p">:</span>
            <span class="c1"># Known issue from typeshed:</span>
            <span class="c1"># https://github.com/python/typeshed/issues/3018</span>
            <span class="n">cpu_cores</span><span class="p">:</span> <span class="n">CpuCores</span> <span class="o">=</span> <span class="n">CpuCores</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_worker_pool</span><span class="p">(</span><span class="n">base_container</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cpu_cores</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_work_producer</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">_STOP_CONTAINERS</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;AutoTest crashed&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done with containers, cleaning up&#39;</span><span class="p">)</span>
                <span class="n">_STOP_CONTAINERS</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, CodeGrade

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>